<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title>æ‰€æœ‰æ–‡ç«  - PME-Blog</title><link>https://hpk.me/posts/</link><description>æ‰€æœ‰æ–‡ç«  | PME-Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><managingEditor>hpkaiq@qq.com (hpkaiq)</managingEditor><webMaster>hpkaiq@qq.com (hpkaiq)</webMaster><lastBuildDate>Mon, 29 May 2023 10:45:18 +0800</lastBuildDate><atom:link href="https://hpk.me/posts/" rel="self" type="application/rss+xml"/><item><title>Cloudflareä¼˜é€‰ipå¹¶ä½¿ç”¨dnspodcn apiè®¾ç½®è§£æ</title><link>https://hpk.me/posts/cloudflare-betterip-dnspodcn/</link><pubDate>Mon, 29 May 2023 10:45:18 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/cloudflare-betterip-dnspodcn/</guid><description><![CDATA[<p>Cloudflareä¼˜é€‰ipå¹¶ä½¿ç”¨dnspodcn apiè®¾ç½®è§£æï¼Œå®ç°åœ¨æœ¬åœ°ç½‘ç»œç¯å¢ƒä¸‹nasæˆ–è€…å…¶ä»–æœåŠ¡å™¨ä¸Šä¼˜é€‰IPï¼Œå¹¶è‡ªåŠ¨è§£æåˆ°è‡ªå·±çš„dnspodcnåŸŸåï¼Œå®ç°é€Ÿåº¦æœ€ä¼˜ã€‚</p>
<h2 id="ä¼˜é€‰ip">ä¼˜é€‰ip</h2>
<p>è¯·å‚è€ƒgithubé¡¹ç›® <a href="https://github.com/XIU2/CloudflareSpeedTest"target="_blank" rel="external nofollow noopener noreferrer">XIU2/CloudflareSpeedTest: ğŸŒ©ã€Œè‡ªé€‰ä¼˜é€‰ IPã€æµ‹è¯• Cloudflare CDN å»¶è¿Ÿå’Œé€Ÿåº¦ï¼Œè·å–æœ€å¿« IP (IPv4 / IPv6)ï¼å¦å¤–ä¹Ÿæ”¯æŒå…¶ä»– CDN / ç½‘ç«™ IP ~ (github.com)<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>æˆ‘çš„æœ¬åœ°æœåŠ¡å™¨ä¸ºcentos8ç³»ç»Ÿï¼Œä¸‹è½½å¹¶è§£å‹åˆ° /opt/cloudflareST ç›®å½•ä¸‹è¿è¡Œã€‚</p>
<h2 id="dnspodcn-api-è®¾ç½®è§£æ">dnspodcn api è®¾ç½®è§£æ</h2>
<p>å‚è€ƒ<a href="https://github.com/rehiy/dnspod-shell"target="_blank" rel="external nofollow noopener noreferrer">rehiy/dnspod-shell: åŸºäºDNSPodç”¨æˆ·APIå®ç°çš„çº¯ShellåŠ¨æ€åŸŸåå®¢æˆ·ç«¯ (github.com)<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> ï¼ŒåŠ å…¥çº¿è·¯é€»è¾‘ä¿®æ”¹è€Œæ¥ã€‚</p>
<p>è¿›å…¥ /opt/cloudflareST ç›®å½•ï¼Œæ–°å»ºä»¥ä¸‹è„šæœ¬ã€‚éœ€è¦ä¿®æ”¹arToken=&ldquo;12345,xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&rdquo; ä¸ºä½ è‡ªå·±çš„dnspodcnçš„tokenï¼Œä¿®æ”¹arDdnsCheck &ldquo;xx.yy&rdquo; &ldquo;sub1&rdquo; &ldquo;$yys_line&rdquo; ä¸ºä½ è‡ªå·±çš„åŸŸåã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">#</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">###################################################################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># AnripDdns v6.4.0</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Dynamic DNS using DNSPod API</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Author: Rehiy, https://github.com/rehiy</span>
</span></span><span class="line"><span class="cl"><span class="c1">#                https://www.rehiy.com/?s=dnspod</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Collaborators: https://github.com/rehiy/dnspod-shell/graphs/contributors</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Usage: please refer to `ddnspod.sh`</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### params ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> arToken
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The url to be used for querying public ip address.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">arIp4QueryUrl</span><span class="o">=</span><span class="s2">&#34;http://ipv4.rehi.org/ip&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">arIp6QueryUrl</span><span class="o">=</span><span class="s2">&#34;http://ipv6.rehi.org/ip&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The temp file to store the last record ip</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The error code to return when a ddns record is not changed</span>
</span></span><span class="line"><span class="cl"><span class="c1"># By default, report unchanged event as success</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">arErrCodeUnchanged</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### logger ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Output log to stderr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arLog<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &gt;<span class="p">&amp;</span><span class="m">2</span> <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### http client ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Use curl or wget open url</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Args: url postdata</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arRequest<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">url</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">data</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">agent</span><span class="o">=</span><span class="s2">&#34;AnripDdns/6.4.0(wang@rehiy.com)&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span> curl &gt;/dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">echo</span> <span class="nv">$url</span> <span class="p">|</span> grep -q https<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$params</span><span class="s2"> -k&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$data</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$params</span><span class="s2"> -d </span><span class="nv">$data</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        curl -s -A <span class="s2">&#34;</span><span class="nv">$agent</span><span class="s2">&#34;</span> <span class="nv">$params</span> <span class="nv">$url</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$?</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span> wget &gt;/dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">echo</span> <span class="nv">$url</span> <span class="p">|</span> grep -q https<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$params</span><span class="s2"> --no-check-certificate&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$data</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$params</span><span class="s2"> --post-data </span><span class="nv">$data</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        wget -qO- -U <span class="s2">&#34;</span><span class="nv">$agent</span><span class="s2">&#34;</span> <span class="nv">$params</span> <span class="nv">$url</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$?</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get IPv4 by ip route or network</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arWanIp4<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> hostIp
</span></span><span class="line"><span class="cl">    <span class="nv">hostIp</span><span class="o">=</span><span class="k">$(</span>awk -F <span class="s1">&#39;,&#39;</span> <span class="s1">&#39;NR==2 {print $1}&#39;</span> /opt/cloudflareST/result.csv<span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="nv">$hostIp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### dnspod api ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Dnspod Bridge</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Args: interface data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arDdnsApi<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">dnsapi</span><span class="o">=</span><span class="s2">&#34;https://dnsapi.cn/</span><span class="si">${</span><span class="nv">1</span><span class="p">:?</span><span class="s1">&#39;Info.Version&#39;</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;login_token=</span><span class="nv">$arToken</span><span class="s2">&amp;format=json&amp;lang=en&amp;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    arRequest <span class="s2">&#34;</span><span class="nv">$dnsapi</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$params</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Fetch Record Id</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Args: domain subdomain recordType</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arDdnsLookup<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> errMsg
</span></span><span class="line"><span class="cl">    <span class="c1"># Get Record Id</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordId</span><span class="o">=</span><span class="k">$(</span>arDdnsApi <span class="s2">&#34;Record.List&#34;</span> <span class="s2">&#34;domain=</span><span class="nv">$1</span><span class="s2">&amp;sub_domain=</span><span class="nv">$2</span><span class="s2">&amp;record_type=</span><span class="nv">$3</span><span class="s2">&amp;record_line=</span><span class="nv">$4</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordId</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordId</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*&#34;id&#34;:&#34;\([0-9]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> ! <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$recordId</span><span class="s2">&#34;</span> -gt <span class="m">0</span> <span class="o">]</span> 2&gt;/dev/null <span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">errMsg</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordId</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*&#34;message&#34;:&#34;\([^\&#34;]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; arDdnsLookup - </span><span class="nv">$errMsg</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="nv">$recordId</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Update Record Value</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Args: domain subdomain recordId recordType [hostIp]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arDdnsUpdate<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> errMsg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> recordRs
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> recordCd
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> recordIp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> lastRecordIp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">yys_line</span><span class="o">=</span><span class="nv">$6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">arLastRecordFile</span><span class="o">=</span>/run/ardnspod_last_record_<span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>.<span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>.<span class="s2">&#34;</span><span class="nv">$yys_line</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$arLastRecordFile</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">lastRecordIp</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$arLastRecordFile</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># fetch the last record ip from api</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$lastRecordIp</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">recordRs</span><span class="o">=</span><span class="k">$(</span>arDdnsApi <span class="s2">&#34;Record.Info&#34;</span> <span class="s2">&#34;domain=</span><span class="nv">$1</span><span class="s2">&amp;record_id=</span><span class="nv">$3</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">recordCd</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordRs</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*{&#34;code&#34;:&#34;\([0-9]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">lastRecordIp</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordRs</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*,&#34;value&#34;:&#34;\([0-9a-fA-F\.\:]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$5</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="nv">$lastRecordIp</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; arDdnsUpdate - unchanged: </span><span class="nv">$recordIp</span><span class="s2">&#34;</span> <span class="c1"># unchanged event</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$arErrCodeUnchanged</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordRs</span><span class="o">=</span><span class="k">$(</span>arDdnsApi <span class="s2">&#34;Record.Ddns&#34;</span> <span class="s2">&#34;domain=</span><span class="nv">$1</span><span class="s2">&amp;sub_domain=</span><span class="nv">$2</span><span class="s2">&amp;record_id=</span><span class="nv">$3</span><span class="s2">&amp;record_type=</span><span class="nv">$4</span><span class="s2">&amp;value=</span><span class="nv">$5</span><span class="s2">&amp;record_line=</span><span class="nv">$yys_line</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># parse result</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordCd</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordRs</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*{&#34;code&#34;:&#34;\([0-9]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordIp</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordRs</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*,&#34;value&#34;:&#34;\([0-9a-fA-F\.\:]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$recordCd</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;1&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">errMsg</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordRs</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*,&#34;message&#34;:&#34;\([^&#34;]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; arDdnsUpdate - error: </span><span class="nv">$errMsg</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$recordIp</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="nv">$lastRecordIp</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; arDdnsUpdate - unchanged: </span><span class="nv">$recordIp</span><span class="s2">&#34;</span> <span class="c1"># unchanged event</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="nv">$recordIp</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$arErrCodeUnchanged</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; arDdnsUpdate - updated: </span><span class="nv">$recordIp</span><span class="s2">&#34;</span> <span class="c1"># updated event</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="nv">$recordIp</span> &gt; <span class="nv">$arLastRecordFile</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="nv">$recordIp</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### task hub ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># DDNS Check</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Args: domain subdomain [6|4] interface</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arDdnsCheck<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> errCode
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> hostIp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> recordType
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    arLog <span class="s2">&#34;=== Check </span><span class="nv">$2</span><span class="s2">.</span><span class="nv">$1</span><span class="s2"> </span><span class="k">$(</span><span class="nb">printf</span> <span class="k">$(</span><span class="nb">echo</span> -n <span class="s2">&#34;</span><span class="nv">$3</span><span class="s2">&#34;</span> <span class="p">|</span> sed <span class="s1">&#39;s/\\/\\\\/g;s/\(%\)\([0-9a-fA-F][0-9a-fA-F]\)/\\x\2/g&#39;</span><span class="k">))</span><span class="s2"> line===&#34;</span>
</span></span><span class="line"><span class="cl">    arLog <span class="s2">&#34;Fetching Host Ip&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">recordType</span><span class="o">=</span>A
</span></span><span class="line"><span class="cl">    <span class="nv">hostIp</span><span class="o">=</span><span class="k">$(</span>arWanIp4<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">errCode</span><span class="o">=</span><span class="nv">$?</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$errCode</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; Host Ip: </span><span class="nv">$hostIp</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; Record Type: </span><span class="nv">$recordType</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="o">[</span> <span class="nv">$errCode</span> -eq <span class="m">2</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; Host Ip: Auto&#34;</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; Record Type: </span><span class="nv">$recordType</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;</span><span class="nv">$hostIp</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$errCode</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    arLog <span class="s2">&#34;Fetching RecordId&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordId</span><span class="o">=</span><span class="k">$(</span>arDdnsLookup <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$recordType</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$3</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">errCode</span><span class="o">=</span><span class="nv">$?</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$errCode</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; Record Id: </span><span class="nv">$recordId</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;</span><span class="nv">$recordId</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$errCode</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    arLog <span class="s2">&#34;Updating Record value&#34;</span>
</span></span><span class="line"><span class="cl">    arDdnsUpdate <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$recordId</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$recordType</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$hostIp</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$3</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### end ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /opt/cloudflareST
</span></span><span class="line"><span class="cl"><span class="c1"># https://github.com/XIU2/CloudflareSpeedTest</span>
</span></span><span class="line"><span class="cl"><span class="c1"># å³éœ€è¦æ‰¾åˆ° 10 ä¸ªå¹³å‡å»¶è¿Ÿä½äº 300 ms ä¸”ä¸‹è½½é€Ÿåº¦é«˜äº 15MB/s çš„ IP æ‰ä¼šåœæ­¢æµ‹é€Ÿ</span>
</span></span><span class="line"><span class="cl">/opt/cloudflareST/CloudflareST -tl <span class="m">300</span> -sl <span class="m">15</span> -dn <span class="m">10</span> -url https://cf.xiu2.xyz/url -o /opt/cloudflareST/result.csv     
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Combine your token ID and token together as follows</span>
</span></span><span class="line"><span class="cl"><span class="nv">arToken</span><span class="o">=</span><span class="s2">&#34;12345,xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Web endpoint to be used for querying the public IPv6 address</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Set this to override the default url provided by ardnspod</span>
</span></span><span class="line"><span class="cl"><span class="c1"># arIp4QueryUrl=&#34;http://ipv4.rehi.org/ip&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># arIp6QueryUrl=&#34;http://ipv6.rehi.org/ip&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Return code when the last record IP is same as current host IP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Set this to a value other than 0 to distinguish with a successful ddns update</span>
</span></span><span class="line"><span class="cl"><span class="c1"># arErrCodeUnchanged=0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Place each domain you want to check as follows</span>
</span></span><span class="line"><span class="cl"><span class="c1"># you can have multiple arDdnsCheck blocks</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## è”é€š %E8%81%94%E9%80%9A</span>
</span></span><span class="line"><span class="cl"><span class="c1">## ç§»åŠ¨ %E7%A7%BB%E5%8A%A8</span>
</span></span><span class="line"><span class="cl"><span class="c1">## ç”µä¿¡ %E7%94%B5%E4%BF%A1</span>
</span></span><span class="line"><span class="cl"><span class="nv">yys_lines</span><span class="o">=(</span><span class="s2">&#34;%E8%81%94%E9%80%9A&#34;</span> <span class="s2">&#34;%E7%A7%BB%E5%8A%A8&#34;</span> <span class="s2">&#34;%E7%94%B5%E4%BF%A1&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ä½¿ç”¨å¾ªç¯éå†æ•°ç»„</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> yys_line in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">yys_lines</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">    arDdnsCheck <span class="s2">&#34;xx.yy&#34;</span> <span class="s2">&#34;sub1&#34;</span> <span class="s2">&#34;</span><span class="nv">$yys_line</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    arDdnsCheck <span class="s2">&#34;xx.yy&#34;</span> <span class="s2">&#34;sub2&#34;</span> <span class="s2">&#34;</span><span class="nv">$yys_line</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å®šæ—¶è¿è¡Œ">å®šæ—¶è¿è¡Œ</h2>
<p>æˆ‘ä½¿ç”¨crontabï¼Œ8å°æ—¶è¿è¡Œä¸€æ¬¡ï¼Œè¯·æ ¹æ®éœ€è¦è‡ªè¡Œä¿®æ”¹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="m">0</span> */8 * * * /opt/cloudflareST/dnspodcn.sh &gt;&gt; /opt/cloudflareST/log.txt
</span></span></code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>Cloudflareä¼˜é€‰ipå¹¶ä½¿ç”¨dnspodcn apiè®¾ç½®è§£æ</title><link>https://hpk.me/posts/cloudflare-betterip-dnspodcn/</link><pubDate>Mon, 29 May 2023 10:45:18 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/cloudflare-betterip-dnspodcn/</guid><description><![CDATA[<p>Cloudflareä¼˜é€‰ipå¹¶ä½¿ç”¨dnspodcn apiè®¾ç½®è§£æï¼Œå®ç°åœ¨æœ¬åœ°ç½‘ç»œç¯å¢ƒä¸‹nasæˆ–è€…å…¶ä»–æœåŠ¡å™¨ä¸Šä¼˜é€‰IPï¼Œå¹¶è‡ªåŠ¨è§£æåˆ°è‡ªå·±çš„dnspodcnåŸŸåï¼Œå®ç°é€Ÿåº¦æœ€ä¼˜ã€‚</p>
<h2 id="ä¼˜é€‰ip">ä¼˜é€‰ip</h2>
<p>è¯·å‚è€ƒgithubé¡¹ç›® <a href="https://github.com/XIU2/CloudflareSpeedTest"target="_blank" rel="external nofollow noopener noreferrer">XIU2/CloudflareSpeedTest: ğŸŒ©ã€Œè‡ªé€‰ä¼˜é€‰ IPã€æµ‹è¯• Cloudflare CDN å»¶è¿Ÿå’Œé€Ÿåº¦ï¼Œè·å–æœ€å¿« IP (IPv4 / IPv6)ï¼å¦å¤–ä¹Ÿæ”¯æŒå…¶ä»– CDN / ç½‘ç«™ IP ~ (github.com)<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>æˆ‘çš„æœ¬åœ°æœåŠ¡å™¨ä¸ºcentos8ç³»ç»Ÿï¼Œä¸‹è½½å¹¶è§£å‹åˆ° /opt/cloudflareST ç›®å½•ä¸‹è¿è¡Œã€‚</p>
<h2 id="dnspodcn-api-è®¾ç½®è§£æ">dnspodcn api è®¾ç½®è§£æ</h2>
<p>å‚è€ƒ<a href="https://github.com/rehiy/dnspod-shell"target="_blank" rel="external nofollow noopener noreferrer">rehiy/dnspod-shell: åŸºäºDNSPodç”¨æˆ·APIå®ç°çš„çº¯ShellåŠ¨æ€åŸŸåå®¢æˆ·ç«¯ (github.com)<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> ï¼ŒåŠ å…¥çº¿è·¯é€»è¾‘ä¿®æ”¹è€Œæ¥ã€‚</p>
<p>è¿›å…¥ /opt/cloudflareST ç›®å½•ï¼Œæ–°å»ºä»¥ä¸‹è„šæœ¬ã€‚éœ€è¦ä¿®æ”¹arToken=&ldquo;12345,xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&rdquo; ä¸ºä½ è‡ªå·±çš„dnspodcnçš„tokenï¼Œä¿®æ”¹arDdnsCheck &ldquo;xx.yy&rdquo; &ldquo;sub1&rdquo; &ldquo;$yys_line&rdquo; ä¸ºä½ è‡ªå·±çš„åŸŸåã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">#</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">###################################################################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># AnripDdns v6.4.0</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Dynamic DNS using DNSPod API</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Author: Rehiy, https://github.com/rehiy</span>
</span></span><span class="line"><span class="cl"><span class="c1">#                https://www.rehiy.com/?s=dnspod</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Collaborators: https://github.com/rehiy/dnspod-shell/graphs/contributors</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Usage: please refer to `ddnspod.sh`</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### params ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> arToken
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The url to be used for querying public ip address.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">arIp4QueryUrl</span><span class="o">=</span><span class="s2">&#34;http://ipv4.rehi.org/ip&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">arIp6QueryUrl</span><span class="o">=</span><span class="s2">&#34;http://ipv6.rehi.org/ip&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The temp file to store the last record ip</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The error code to return when a ddns record is not changed</span>
</span></span><span class="line"><span class="cl"><span class="c1"># By default, report unchanged event as success</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">arErrCodeUnchanged</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### logger ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Output log to stderr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arLog<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &gt;<span class="p">&amp;</span><span class="m">2</span> <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### http client ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Use curl or wget open url</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Args: url postdata</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arRequest<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">url</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">data</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">agent</span><span class="o">=</span><span class="s2">&#34;AnripDdns/6.4.0(wang@rehiy.com)&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span> curl &gt;/dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">echo</span> <span class="nv">$url</span> <span class="p">|</span> grep -q https<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$params</span><span class="s2"> -k&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$data</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$params</span><span class="s2"> -d </span><span class="nv">$data</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        curl -s -A <span class="s2">&#34;</span><span class="nv">$agent</span><span class="s2">&#34;</span> <span class="nv">$params</span> <span class="nv">$url</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$?</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span> wget &gt;/dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">echo</span> <span class="nv">$url</span> <span class="p">|</span> grep -q https<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$params</span><span class="s2"> --no-check-certificate&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$data</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$params</span><span class="s2"> --post-data </span><span class="nv">$data</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        wget -qO- -U <span class="s2">&#34;</span><span class="nv">$agent</span><span class="s2">&#34;</span> <span class="nv">$params</span> <span class="nv">$url</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$?</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get IPv4 by ip route or network</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arWanIp4<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> hostIp
</span></span><span class="line"><span class="cl">    <span class="nv">hostIp</span><span class="o">=</span><span class="k">$(</span>awk -F <span class="s1">&#39;,&#39;</span> <span class="s1">&#39;NR==2 {print $1}&#39;</span> /opt/cloudflareST/result.csv<span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="nv">$hostIp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### dnspod api ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Dnspod Bridge</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Args: interface data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arDdnsApi<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">dnsapi</span><span class="o">=</span><span class="s2">&#34;https://dnsapi.cn/</span><span class="si">${</span><span class="nv">1</span><span class="p">:?</span><span class="s1">&#39;Info.Version&#39;</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;login_token=</span><span class="nv">$arToken</span><span class="s2">&amp;format=json&amp;lang=en&amp;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    arRequest <span class="s2">&#34;</span><span class="nv">$dnsapi</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$params</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Fetch Record Id</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Args: domain subdomain recordType</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arDdnsLookup<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> errMsg
</span></span><span class="line"><span class="cl">    <span class="c1"># Get Record Id</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordId</span><span class="o">=</span><span class="k">$(</span>arDdnsApi <span class="s2">&#34;Record.List&#34;</span> <span class="s2">&#34;domain=</span><span class="nv">$1</span><span class="s2">&amp;sub_domain=</span><span class="nv">$2</span><span class="s2">&amp;record_type=</span><span class="nv">$3</span><span class="s2">&amp;record_line=</span><span class="nv">$4</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordId</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordId</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*&#34;id&#34;:&#34;\([0-9]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> ! <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$recordId</span><span class="s2">&#34;</span> -gt <span class="m">0</span> <span class="o">]</span> 2&gt;/dev/null <span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">errMsg</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordId</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*&#34;message&#34;:&#34;\([^\&#34;]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; arDdnsLookup - </span><span class="nv">$errMsg</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="nv">$recordId</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Update Record Value</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Args: domain subdomain recordId recordType [hostIp]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arDdnsUpdate<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> errMsg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> recordRs
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> recordCd
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> recordIp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> lastRecordIp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">yys_line</span><span class="o">=</span><span class="nv">$6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">arLastRecordFile</span><span class="o">=</span>/run/ardnspod_last_record_<span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>.<span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>.<span class="s2">&#34;</span><span class="nv">$yys_line</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$arLastRecordFile</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">lastRecordIp</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$arLastRecordFile</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># fetch the last record ip from api</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$lastRecordIp</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">recordRs</span><span class="o">=</span><span class="k">$(</span>arDdnsApi <span class="s2">&#34;Record.Info&#34;</span> <span class="s2">&#34;domain=</span><span class="nv">$1</span><span class="s2">&amp;record_id=</span><span class="nv">$3</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">recordCd</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordRs</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*{&#34;code&#34;:&#34;\([0-9]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">lastRecordIp</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordRs</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*,&#34;value&#34;:&#34;\([0-9a-fA-F\.\:]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$5</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="nv">$lastRecordIp</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; arDdnsUpdate - unchanged: </span><span class="nv">$recordIp</span><span class="s2">&#34;</span> <span class="c1"># unchanged event</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$arErrCodeUnchanged</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordRs</span><span class="o">=</span><span class="k">$(</span>arDdnsApi <span class="s2">&#34;Record.Ddns&#34;</span> <span class="s2">&#34;domain=</span><span class="nv">$1</span><span class="s2">&amp;sub_domain=</span><span class="nv">$2</span><span class="s2">&amp;record_id=</span><span class="nv">$3</span><span class="s2">&amp;record_type=</span><span class="nv">$4</span><span class="s2">&amp;value=</span><span class="nv">$5</span><span class="s2">&amp;record_line=</span><span class="nv">$yys_line</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># parse result</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordCd</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordRs</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*{&#34;code&#34;:&#34;\([0-9]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordIp</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordRs</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*,&#34;value&#34;:&#34;\([0-9a-fA-F\.\:]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$recordCd</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;1&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">errMsg</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordRs</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*,&#34;message&#34;:&#34;\([^&#34;]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; arDdnsUpdate - error: </span><span class="nv">$errMsg</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$recordIp</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="nv">$lastRecordIp</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; arDdnsUpdate - unchanged: </span><span class="nv">$recordIp</span><span class="s2">&#34;</span> <span class="c1"># unchanged event</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="nv">$recordIp</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$arErrCodeUnchanged</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; arDdnsUpdate - updated: </span><span class="nv">$recordIp</span><span class="s2">&#34;</span> <span class="c1"># updated event</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="nv">$recordIp</span> &gt; <span class="nv">$arLastRecordFile</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="nv">$recordIp</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### task hub ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># DDNS Check</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Args: domain subdomain [6|4] interface</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arDdnsCheck<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> errCode
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> hostIp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> recordType
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    arLog <span class="s2">&#34;=== Check </span><span class="nv">$2</span><span class="s2">.</span><span class="nv">$1</span><span class="s2"> </span><span class="k">$(</span><span class="nb">printf</span> <span class="k">$(</span><span class="nb">echo</span> -n <span class="s2">&#34;</span><span class="nv">$3</span><span class="s2">&#34;</span> <span class="p">|</span> sed <span class="s1">&#39;s/\\/\\\\/g;s/\(%\)\([0-9a-fA-F][0-9a-fA-F]\)/\\x\2/g&#39;</span><span class="k">))</span><span class="s2"> line===&#34;</span>
</span></span><span class="line"><span class="cl">    arLog <span class="s2">&#34;Fetching Host Ip&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">recordType</span><span class="o">=</span>A
</span></span><span class="line"><span class="cl">    <span class="nv">hostIp</span><span class="o">=</span><span class="k">$(</span>arWanIp4<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">errCode</span><span class="o">=</span><span class="nv">$?</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$errCode</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; Host Ip: </span><span class="nv">$hostIp</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; Record Type: </span><span class="nv">$recordType</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="o">[</span> <span class="nv">$errCode</span> -eq <span class="m">2</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; Host Ip: Auto&#34;</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; Record Type: </span><span class="nv">$recordType</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;</span><span class="nv">$hostIp</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$errCode</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    arLog <span class="s2">&#34;Fetching RecordId&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordId</span><span class="o">=</span><span class="k">$(</span>arDdnsLookup <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$recordType</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$3</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">errCode</span><span class="o">=</span><span class="nv">$?</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$errCode</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; Record Id: </span><span class="nv">$recordId</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;</span><span class="nv">$recordId</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$errCode</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    arLog <span class="s2">&#34;Updating Record value&#34;</span>
</span></span><span class="line"><span class="cl">    arDdnsUpdate <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$recordId</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$recordType</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$hostIp</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$3</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### end ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /opt/cloudflareST
</span></span><span class="line"><span class="cl"><span class="c1"># https://github.com/XIU2/CloudflareSpeedTest</span>
</span></span><span class="line"><span class="cl"><span class="c1"># å³éœ€è¦æ‰¾åˆ° 10 ä¸ªå¹³å‡å»¶è¿Ÿä½äº 300 ms ä¸”ä¸‹è½½é€Ÿåº¦é«˜äº 15MB/s çš„ IP æ‰ä¼šåœæ­¢æµ‹é€Ÿ</span>
</span></span><span class="line"><span class="cl">/opt/cloudflareST/CloudflareST -tl <span class="m">300</span> -sl <span class="m">15</span> -dn <span class="m">10</span> -url https://cf.xiu2.xyz/url -o /opt/cloudflareST/result.csv     
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Combine your token ID and token together as follows</span>
</span></span><span class="line"><span class="cl"><span class="nv">arToken</span><span class="o">=</span><span class="s2">&#34;12345,xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Web endpoint to be used for querying the public IPv6 address</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Set this to override the default url provided by ardnspod</span>
</span></span><span class="line"><span class="cl"><span class="c1"># arIp4QueryUrl=&#34;http://ipv4.rehi.org/ip&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># arIp6QueryUrl=&#34;http://ipv6.rehi.org/ip&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Return code when the last record IP is same as current host IP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Set this to a value other than 0 to distinguish with a successful ddns update</span>
</span></span><span class="line"><span class="cl"><span class="c1"># arErrCodeUnchanged=0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Place each domain you want to check as follows</span>
</span></span><span class="line"><span class="cl"><span class="c1"># you can have multiple arDdnsCheck blocks</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## è”é€š %E8%81%94%E9%80%9A</span>
</span></span><span class="line"><span class="cl"><span class="c1">## ç§»åŠ¨ %E7%A7%BB%E5%8A%A8</span>
</span></span><span class="line"><span class="cl"><span class="c1">## ç”µä¿¡ %E7%94%B5%E4%BF%A1</span>
</span></span><span class="line"><span class="cl"><span class="nv">yys_lines</span><span class="o">=(</span><span class="s2">&#34;%E8%81%94%E9%80%9A&#34;</span> <span class="s2">&#34;%E7%A7%BB%E5%8A%A8&#34;</span> <span class="s2">&#34;%E7%94%B5%E4%BF%A1&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ä½¿ç”¨å¾ªç¯éå†æ•°ç»„</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> yys_line in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">yys_lines</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">    arDdnsCheck <span class="s2">&#34;xx.yy&#34;</span> <span class="s2">&#34;sub1&#34;</span> <span class="s2">&#34;</span><span class="nv">$yys_line</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    arDdnsCheck <span class="s2">&#34;xx.yy&#34;</span> <span class="s2">&#34;sub2&#34;</span> <span class="s2">&#34;</span><span class="nv">$yys_line</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å®šæ—¶è¿è¡Œ">å®šæ—¶è¿è¡Œ</h2>
<p>æˆ‘ä½¿ç”¨crontabï¼Œ8å°æ—¶è¿è¡Œä¸€æ¬¡ï¼Œè¯·æ ¹æ®éœ€è¦è‡ªè¡Œä¿®æ”¹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="m">0</span> */8 * * * /opt/cloudflareST/dnspodcn.sh &gt;&gt; /opt/cloudflareST/log.txt
</span></span></code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>spark å®ç° mysql upsert</title><link>https://hpk.me/posts/spark-mysql-upsert/</link><pubDate>Tue, 18 Apr 2023 14:23:06 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/spark-mysql-upsert/</guid><description><![CDATA[<p><strong>å®ç° spark dataframe/dataset æ ¹æ®mysqlè¡¨å”¯ä¸€é”®å®ç°æœ‰åˆ™æ›´æ–°ï¼Œæ— åˆ™æ’å…¥åŠŸèƒ½ã€‚</strong></p>
<p>åŸºäº <strong>spark2.4.3 scala2.11.8</strong></p>
<h2 id="å·¥å…·ç±»-dataframewriterenhance">å·¥å…·ç±» DataFrameWriterEnhance</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.xxx.utils</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.spark.sql.catalyst.plans.logical.LogicalPlan</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.spark.sql.execution.SQLExecution</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.spark.sql.execution.datasources.DataSource</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.spark.sql.execution.datasources.jdbc.</span><span class="o">{</span><span class="n">JDBCOptions</span><span class="o">,</span> <span class="n">JdbcOptionsInWrite</span><span class="o">,</span> <span class="n">JdbcRelationProvider</span><span class="o">,</span> <span class="n">JdbcUtils</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.spark.sql.jdbc.</span><span class="o">{</span><span class="n">JdbcDialect</span><span class="o">,</span> <span class="n">JdbcDialects</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.spark.sql.sources.BaseRelation</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.spark.sql.types.StructType</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.spark.sql._</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.sql.Connection</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">object</span> <span class="n">DataFrameWriterEnhance</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">implicit</span> <span class="kd">class</span> <span class="nf">DataFrameWriterMysqlUpdateEnhance</span><span class="o">(</span><span class="n">writer</span><span class="o">:</span> <span class="n">DataFrameWriter</span><span class="o">[</span><span class="n">Row</span><span class="o">])</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">def</span> <span class="nf">update</span><span class="o">():</span> <span class="n">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">extraOptionsField</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="na">getClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;org$apache$spark$sql$DataFrameWriter$$extraOptions&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">dfField</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="na">getClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;df&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">sourceField</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="na">getClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;source&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">partitioningColumnsField</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="na">getClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;partitioningColumns&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">extraOptionsField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">dfField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">sourceField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">partitioningColumnsField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">extraOptions</span> <span class="o">=</span> <span class="n">extraOptionsField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">writer</span><span class="o">).</span><span class="na">asInstanceOf</span><span class="o">[</span><span class="n">scala</span><span class="o">.</span><span class="na">collection</span><span class="o">.</span><span class="na">Map</span><span class="o">[</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">]]</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">df</span> <span class="o">=</span> <span class="n">dfField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">writer</span><span class="o">).</span><span class="na">asInstanceOf</span><span class="o">[</span><span class="n">DataFrame</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">partitioningColumns</span> <span class="o">=</span> <span class="n">partitioningColumnsField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">writer</span><span class="o">).</span><span class="na">asInstanceOf</span><span class="o">[</span><span class="n">Option</span><span class="o">[</span><span class="n">Seq</span><span class="o">[</span><span class="n">String</span><span class="o">]]]</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">logicalPlanField</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="na">getClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;logicalPlan&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">logicalPlanField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">var</span> <span class="n">logicalPlan</span> <span class="o">=</span> <span class="n">logicalPlanField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">df</span><span class="o">).</span><span class="na">asInstanceOf</span><span class="o">[</span><span class="n">LogicalPlan</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">session</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="na">sparkSession</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">sparkSession</span> <span class="o">=</span> <span class="n">session</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">className</span> <span class="o">=</span> <span class="n">s</span><span class="s">&#34;${DataFrameWriterEnhance.getClass.getName}MysqlUpdateRelationProvider&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">partitionColumns</span> <span class="o">=</span> <span class="n">partitioningColumns</span><span class="o">.</span><span class="na">getOrElse</span><span class="o">(</span><span class="n">Nil</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">options</span> <span class="o">=</span> <span class="n">extraOptions</span><span class="o">.</span><span class="na">toMap</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">logicalPlan</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">planForWriting</span><span class="o">(</span><span class="n">SaveMode</span><span class="o">.</span><span class="na">Append</span><span class="o">,</span> <span class="n">logicalPlan</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">qe</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">sessionState</span><span class="o">.</span><span class="na">executePlan</span><span class="o">(</span><span class="n">logicalPlan</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">SQLExecution</span><span class="o">.</span><span class="na">withNewExecutionId</span><span class="o">(</span><span class="n">session</span><span class="o">,</span> <span class="n">qe</span><span class="o">)(</span><span class="n">qe</span><span class="o">.</span><span class="na">toRdd</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">class</span> <span class="nc">MysqlUpdateRelationProvider</span> <span class="kd">extends</span> <span class="n">JdbcRelationProvider</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">override</span> <span class="n">def</span> <span class="nf">createRelation</span><span class="o">(</span><span class="n">sqlContext</span><span class="o">:</span> <span class="n">SQLContext</span><span class="o">,</span> <span class="n">mode</span><span class="o">:</span> <span class="n">SaveMode</span><span class="o">,</span> <span class="n">parameters</span><span class="o">:</span> <span class="n">Map</span><span class="o">[</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">],</span> <span class="n">df</span><span class="o">:</span> <span class="n">DataFrame</span><span class="o">):</span> <span class="n">BaseRelation</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">options</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JdbcOptionsInWrite</span><span class="o">(</span><span class="n">parameters</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">isCaseSensitive</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="na">sparkSession</span><span class="o">.</span><span class="na">sessionState</span><span class="o">.</span><span class="na">conf</span><span class="o">.</span><span class="na">caseSensitiveAnalysis</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">createConnectionFactory</span><span class="o">(</span><span class="n">options</span><span class="o">)()</span>
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="n">tableExists</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">tableExists</span><span class="o">(</span><span class="n">conn</span><span class="o">,</span> <span class="n">options</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">tableExists</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">mode</span> <span class="n">match</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">SaveMode</span><span class="o">.</span><span class="na">Overwrite</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="o">(</span><span class="n">options</span><span class="o">.</span><span class="na">isTruncate</span> <span class="o">&amp;&amp;</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">isCascadingTruncateTable</span><span class="o">(</span><span class="n">options</span><span class="o">.</span><span class="na">url</span><span class="o">).</span><span class="na">contains</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// In this case, we should truncate table and then load.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">truncateTable</span><span class="o">(</span><span class="n">conn</span><span class="o">,</span> <span class="n">options</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">val</span> <span class="n">tableSchema</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">getSchemaOption</span><span class="o">(</span><span class="n">conn</span><span class="o">,</span> <span class="n">options</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">updateTable</span><span class="o">(</span><span class="n">df</span><span class="o">,</span> <span class="n">tableSchema</span><span class="o">,</span> <span class="n">isCaseSensitive</span><span class="o">,</span> <span class="n">options</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Otherwise, do not truncate the table, instead drop and recreate it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">dropTable</span><span class="o">(</span><span class="n">conn</span><span class="o">,</span> <span class="n">options</span><span class="o">.</span><span class="na">table</span><span class="o">,</span> <span class="n">options</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">createTable</span><span class="o">(</span><span class="n">conn</span><span class="o">,</span> <span class="n">df</span><span class="o">,</span> <span class="n">options</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">updateTable</span><span class="o">(</span><span class="n">df</span><span class="o">,</span> <span class="n">Some</span><span class="o">(</span><span class="n">df</span><span class="o">.</span><span class="na">schema</span><span class="o">),</span> <span class="n">isCaseSensitive</span><span class="o">,</span> <span class="n">options</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">SaveMode</span><span class="o">.</span><span class="na">Append</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="n">val</span> <span class="n">tableSchema</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">getSchemaOption</span><span class="o">(</span><span class="n">conn</span><span class="o">,</span> <span class="n">options</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="n">updateTable</span><span class="o">(</span><span class="n">df</span><span class="o">,</span> <span class="n">tableSchema</span><span class="o">,</span> <span class="n">isCaseSensitive</span><span class="o">,</span> <span class="n">options</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">SaveMode</span><span class="o">.</span><span class="na">ErrorIfExists</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">s</span><span class="s">&#34;Table or view &#39;${options.table}&#39; already exists. &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                  <span class="n">s</span><span class="s">&#34;SaveMode: ErrorIfExists.&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">SaveMode</span><span class="o">.</span><span class="na">Ignore</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// With `SaveMode.Ignore` mode, if table already exists, the save operation is expected
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// to not save the contents of the DataFrame and to not change the existing data.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Therefore, it is okay to do nothing here and then just return the relation below.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">createTable</span><span class="o">(</span><span class="n">conn</span><span class="o">,</span> <span class="n">df</span><span class="o">,</span> <span class="n">options</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="n">updateTable</span><span class="o">(</span><span class="n">df</span><span class="o">,</span> <span class="n">Some</span><span class="o">(</span><span class="n">df</span><span class="o">.</span><span class="na">schema</span><span class="o">),</span> <span class="n">isCaseSensitive</span><span class="o">,</span> <span class="n">options</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">createRelation</span><span class="o">(</span><span class="n">sqlContext</span><span class="o">,</span> <span class="n">parameters</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">def</span> <span class="nf">updateTable</span><span class="o">(</span><span class="n">df</span><span class="o">:</span> <span class="n">DataFrame</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">tableSchema</span><span class="o">:</span> <span class="n">Option</span><span class="o">[</span><span class="n">StructType</span><span class="o">],</span>
</span></span><span class="line"><span class="cl">                    <span class="n">isCaseSensitive</span><span class="o">:</span> <span class="n">Boolean</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">options</span><span class="o">:</span> <span class="n">JdbcOptionsInWrite</span><span class="o">):</span> <span class="n">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">url</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="na">url</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">table</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="na">table</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">dialect</span> <span class="o">=</span> <span class="n">JdbcDialects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">url</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">rddSchema</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="na">schema</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">getConnection</span><span class="o">:</span> <span class="o">()</span> <span class="o">=&gt;</span> <span class="n">Connection</span> <span class="o">=</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">createConnectionFactory</span><span class="o">(</span><span class="n">options</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">batchSize</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="na">batchSize</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">isolationLevel</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="na">isolationLevel</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">updateStmt</span> <span class="o">=</span> <span class="n">getUpdateStatement</span><span class="o">(</span><span class="n">table</span><span class="o">,</span> <span class="n">rddSchema</span><span class="o">,</span> <span class="n">tableSchema</span><span class="o">,</span> <span class="n">isCaseSensitive</span><span class="o">,</span> <span class="n">dialect</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">println</span><span class="o">(</span><span class="n">updateStmt</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">repartitionedDF</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="na">numPartitions</span> <span class="n">match</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">Some</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">=&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">s</span><span class="s">&#34;Invalid value `$n` for parameter `${JDBCOptions.JDBC_NUM_PARTITIONS}` in table writing &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;via JDBC. The minimum value is 1.&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">Some</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">df</span><span class="o">.</span><span class="na">rdd</span><span class="o">.</span><span class="na">partitions</span><span class="o">.</span><span class="na">length</span> <span class="o">=&gt;</span> <span class="n">df</span><span class="o">.</span><span class="na">coalesce</span><span class="o">(</span><span class="n">n</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">_</span> <span class="o">=&gt;</span> <span class="n">df</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">repartitionedDF</span><span class="o">.</span><span class="na">rdd</span><span class="o">.</span><span class="na">foreachPartition</span><span class="o">(</span><span class="n">iterator</span> <span class="o">=&gt;</span> <span class="n">JdbcUtils</span><span class="o">.</span><span class="na">savePartition</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">getConnection</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span> <span class="n">iterator</span><span class="o">,</span> <span class="n">rddSchema</span><span class="o">,</span> <span class="n">updateStmt</span><span class="o">,</span> <span class="n">batchSize</span><span class="o">,</span> <span class="n">dialect</span><span class="o">,</span> <span class="n">isolationLevel</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">options</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">def</span> <span class="nf">getUpdateStatement</span><span class="o">(</span><span class="n">table</span><span class="o">:</span> <span class="n">String</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">rddSchema</span><span class="o">:</span> <span class="n">StructType</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">tableSchema</span><span class="o">:</span> <span class="n">Option</span><span class="o">[</span><span class="n">StructType</span><span class="o">],</span>
</span></span><span class="line"><span class="cl">                           <span class="n">isCaseSensitive</span><span class="o">:</span> <span class="n">Boolean</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">dialect</span><span class="o">:</span> <span class="n">JdbcDialect</span><span class="o">):</span> <span class="n">String</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">columns</span> <span class="o">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">tableSchema</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">rddSchema</span><span class="o">.</span><span class="na">fields</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">x</span> <span class="o">=&gt;</span> <span class="n">dialect</span><span class="o">.</span><span class="na">quoteIdentifier</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">name</span><span class="o">)).</span><span class="na">mkString</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="n">columnNameEquality</span> <span class="o">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">isCaseSensitive</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">analysis</span><span class="o">.</span><span class="na">caseSensitiveResolution</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">analysis</span><span class="o">.</span><span class="na">caseInsensitiveResolution</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// The generated insert statement needs to follow rddSchema&#39;s column sequence and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// tableSchema&#39;s column names. When appending data into some case-sensitive DBMSs like
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// PostgreSQL/Oracle, we need to respect the existing case-sensitive column names instead of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// RDD column names for user convenience.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">val</span> <span class="n">tableColumnNames</span> <span class="o">=</span> <span class="n">tableSchema</span><span class="o">.</span><span class="na">get</span><span class="o">.</span><span class="na">fieldNames</span>
</span></span><span class="line"><span class="cl">        <span class="n">rddSchema</span><span class="o">.</span><span class="na">fields</span><span class="o">.</span><span class="na">map</span> <span class="o">{</span> <span class="n">col</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="n">val</span> <span class="n">normalizedName</span> <span class="o">=</span> <span class="n">tableColumnNames</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">f</span> <span class="o">=&gt;</span> <span class="n">columnNameEquality</span><span class="o">(</span><span class="n">f</span><span class="o">,</span> <span class="n">col</span><span class="o">.</span><span class="na">name</span><span class="o">)).</span><span class="na">getOrElse</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="o">(</span><span class="n">s</span><span class="s">&#34;&#34;&#34;Column &#34;</span><span class="n">$</span><span class="o">{</span><span class="n">col</span><span class="o">.</span><span class="na">name</span><span class="o">}</span><span class="s">&#34; not found in schema $tableSchema&#34;&#34;&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">}</span>
</span></span><span class="line"><span class="cl">          <span class="n">dialect</span><span class="o">.</span><span class="na">quoteIdentifier</span><span class="o">(</span><span class="n">normalizedName</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">}.</span><span class="na">mkString</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">val</span> <span class="n">placeholders</span> <span class="o">=</span> <span class="n">rddSchema</span><span class="o">.</span><span class="na">fields</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">_</span> <span class="o">=&gt;</span> <span class="s">&#34;?&#34;</span><span class="o">).</span><span class="na">mkString</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">s</span><span class="s">&#34;&#34;&#34;INSERT INTO $table ($columns) VALUES ($placeholders)
</span></span></span><span class="line"><span class="cl"><span class="s">         |ON DUPLICATE KEY UPDATE
</span></span></span><span class="line"><span class="cl"><span class="s">         |${columns.split(&#34;</span><span class="o">,</span><span class="s">&#34;).map(col =&gt; s&#34;</span><span class="n">$col</span><span class="o">=</span><span class="n">VALUES</span><span class="o">(</span><span class="n">$col</span><span class="o">)</span><span class="s">&#34;).mkString(&#34;</span><span class="o">,</span><span class="s">&#34;)}
</span></span></span><span class="line"><span class="cl"><span class="s">         |&#34;&#34;&#34;</span><span class="o">.</span><span class="na">stripMargin</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å·¥å…·ç±»-mysqlutils">å·¥å…·ç±» MysqlUtils</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.xxx.utils</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.xxx.utils.DataFrameWriterEnhance.DataFrameWriterMysqlUpdateEnhance</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.spark.sql.functions.col</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.spark.sql.types.</span><span class="o">{</span><span class="n">NullType</span><span class="o">,</span> <span class="n">ShortType</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.spark.sql.</span><span class="o">{</span><span class="n">DataFrame</span><span class="o">,</span> <span class="n">SaveMode</span><span class="o">,</span> <span class="n">SparkSession</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">object</span> <span class="n">MysqlUtils</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">def</span> <span class="nf">upsert</span><span class="o">(</span><span class="n">rawDF</span><span class="o">:</span> <span class="n">DataFrame</span><span class="o">,</span> <span class="n">database</span><span class="o">:</span> <span class="n">String</span><span class="o">,</span> <span class="n">tableName</span><span class="o">:</span> <span class="n">String</span><span class="o">)(</span><span class="n">implicit</span> <span class="n">spark</span><span class="o">:</span> <span class="n">SparkSession</span><span class="o">):</span> <span class="n">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">var</span> <span class="n">df</span> <span class="o">=</span> <span class="n">rawDF</span>
</span></span><span class="line"><span class="cl">    <span class="nf">for</span> <span class="o">(</span><span class="n">elem</span> <span class="o">&lt;-</span> <span class="n">df</span><span class="o">.</span><span class="na">schema</span><span class="o">.</span><span class="na">fields</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="o">(</span><span class="n">elem</span><span class="o">.</span><span class="na">dataType</span> <span class="o">==</span> <span class="n">NullType</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="na">withColumn</span><span class="o">(</span><span class="n">elem</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">col</span><span class="o">(</span><span class="n">elem</span><span class="o">.</span><span class="na">name</span><span class="o">).</span><span class="na">cast</span><span class="o">(</span><span class="n">ShortType</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="na">write</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&#34;jdbc&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">mode</span><span class="o">(</span><span class="n">SaveMode</span><span class="o">.</span><span class="na">Append</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="s">&#34;driver&#34;</span><span class="o">,</span> <span class="s">&#34;com.mysql.jdbc.Driver&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="s">&#34;url&#34;</span><span class="o">,</span> <span class="n">spark</span><span class="o">.</span><span class="na">conf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">s</span><span class="s">&#34;spark.job.mysql.${database}.url&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="s">&#34;user&#34;</span><span class="o">,</span> <span class="n">spark</span><span class="o">.</span><span class="na">conf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">s</span><span class="s">&#34;spark.job.mysql.${database}.username&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="s">&#34;password&#34;</span><span class="o">,</span> <span class="n">spark</span><span class="o">.</span><span class="na">conf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">s</span><span class="s">&#34;spark.job.mysql.${database}.password&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="s">&#34;dbtable&#34;</span><span class="o">,</span> <span class="n">tableName</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="s">&#34;useSSL&#34;</span><span class="o">,</span> <span class="s">&#34;false&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="s">&#34;showSql&#34;</span><span class="o">,</span> <span class="s">&#34;false&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="s">&#34;numPartitions&#34;</span><span class="o">,</span> <span class="s">&#34;1&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">update</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<p>sparkå¯åŠ¨è„šæœ¬åŠ å…¥mysqlé…ç½®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">spark-submit <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--master yarn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--deploy-mode cluster <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--executor-memory 3G <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--num-executors <span class="m">5</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--executor-cores <span class="m">4</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--driver-memory 3G <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.job.mysql.test.url<span class="o">=</span><span class="si">${</span><span class="nv">jdbc_url</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.job.mysql.test.username<span class="o">=</span><span class="si">${</span><span class="nv">jdbc_username</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.job.mysql.test.password<span class="o">=</span><span class="si">${</span><span class="nv">jdbc_password</span><span class="si">}</span> <span class="se">\
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨èŒƒä¾‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">utils.MysqlUtils</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">object</span> <span class="n">TestMysqlUpsert</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">def</span> <span class="nf">main</span><span class="o">(</span><span class="n">args</span><span class="o">:</span> <span class="n">Array</span><span class="o">[</span><span class="n">String</span><span class="o">]):</span> <span class="n">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">implicit</span> <span class="n">val</span> <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">enableHiveSupport</span><span class="o">().</span><span class="na">getOrCreate</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">spark.implicits._</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">val</span> <span class="n">database</span> <span class="o">=</span> <span class="s">&#34;test&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">Array</span><span class="o">((</span><span class="mi">1</span><span class="o">,</span><span class="mi">11</span><span class="o">,</span><span class="s">&#34;name1&#34;</span><span class="o">,</span><span class="mi">11111</span><span class="o">),(</span><span class="mi">2</span><span class="o">,</span><span class="mi">22</span><span class="o">,</span><span class="s">&#34;name2&#34;</span><span class="o">,</span><span class="mi">22222</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span> <span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">sparkContext</span><span class="o">.</span><span class="na">parallelize</span><span class="o">(</span><span class="n">arr</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">toDF</span><span class="o">(</span><span class="s">&#34;key_one&#34;</span><span class="o">,</span> <span class="s">&#34;key_two&#34;</span><span class="o">,</span> <span class="s">&#34;val_one&#34;</span><span class="o">,</span> <span class="s">&#34;val_two&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">MysqlUtils</span><span class="o">.</span><span class="na">upsert</span><span class="o">(</span><span class="n">df</span><span class="o">,</span> <span class="n">database</span><span class="o">,</span> <span class="s">&#34;test_unique_key&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">spark</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>test_unique_keyè¡¨ç»“æ„</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">test_unique_key</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">key_one</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">key_two</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">val_one</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">val_two</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">uk</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">key_one</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">key_two</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="w"> </span><span class="k">COMMENT</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<p><a href="https://blog.csdn.net/qq_18453581/article/details/125907861" title="csdn_Spark Upsertå†™å…¥Mysql(scalaå¢å¼º) æ— éœ€ä¾èµ–"target="_blank" rel="external nofollow noopener noreferrer">csdn_Spark Upsertå†™å…¥Mysql(scalaå¢å¼º) æ— éœ€ä¾èµ–<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>]]></description></item><item><title>java é¢‘æ¬¡æ§åˆ¶</title><link>https://hpk.me/posts/java-rate-limit-google-guava/</link><pubDate>Tue, 18 Apr 2023 14:21:15 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/java-rate-limit-google-guava/</guid><description><![CDATA[<p>è®¿é—®æŸæ¥å£æ‹‰å–æ•°æ®ï¼Œæ¥å£éœ€è¦é¢‘æ¬¡æ§åˆ¶ï¼Œç»è°ƒç ”ï¼Œ<code>com.google.common.util.concurrent.RateLimiter</code>å¯è½»æ˜“å®ç°ã€‚</p>
<h2 id="1-maven">1. Maven</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.google.guava<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>guava<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>31.1-jre<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>cn.hutool<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>hutool-all<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>5.8.4<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2-æµ‹è¯•ä»£ç ">2. æµ‹è¯•ä»£ç </h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">cn.hutool.http.HttpRequest</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.google.common.util.concurrent.RateLimiter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RateLimiterTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">RateLimiter</span> <span class="n">rateLimiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">20</span><span class="o">,</span><span class="mi">1000</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">RateLimiterTest</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">InstanceHolder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">static</span> <span class="kd">final</span> <span class="n">RateLimiterTest</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RateLimiterTest</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">RateLimiterTest</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">InstanceHolder</span><span class="o">.</span><span class="na">instance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">runHttpGet</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">header</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">rateLimiter</span><span class="o">.</span><span class="na">acquire</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">HttpRequest</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">url</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="n">header</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">execute</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">body</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestRate</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">ExecutionException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">&#34;https://xxxxx&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">header</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">header</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;Content-type&#34;</span><span class="o">,</span> <span class="n">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="s">&#34;application/json&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">header</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;Access-Token&#34;</span><span class="o">,</span> <span class="n">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="s">&#34;xxxxx&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">tasks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Callable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">callable</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">RateLimiterTest</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">RateLimiterTest</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="na">runHttpGet</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">header</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">tasks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">callable</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ExecutorService</span> <span class="n">exec</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">60</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="n">exec</span><span class="o">.</span><span class="na">invokeAll</span><span class="o">(</span><span class="n">tasks</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">:</span> <span class="n">futures</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">exec</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>python3 easyocr ç®€å•ä½¿ç”¨è¯†åˆ«å‚æ•°</title><link>https://hpk.me/posts/python3-easyocr-simple/</link><pubDate>Tue, 18 Apr 2023 14:18:37 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/python3-easyocr-simple/</guid><description><![CDATA[<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">easyocr</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">gpu_is_available</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">reader</span> <span class="o">=</span> <span class="n">easyocr</span><span class="o">.</span><span class="n">Reader</span><span class="p">([</span><span class="s1">&#39;ch_sim&#39;</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">],</span> <span class="n">gpu</span><span class="o">=</span><span class="n">gpu_is_available</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ocr_data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">readtext</span><span class="p">(</span><span class="s1">&#39;/image/path&#39;</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">text_threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">low_text</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width_ths</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>detail = 0 ä»…è¾“å‡ºè¯†åˆ«åˆ°çš„æ–‡å­—</li>
<li>text_threshold=0.7 æ–‡æœ¬ç½®ä¿¡é˜ˆå€¼ï¼Œå€¼è¶Šå°ï¼Œæ–‡æœ¬å—å†…è¢«è¯†åˆ«ä¸ºæ–‡å­—çš„å¯èƒ½æ€§è¶Šé«˜</li>
<li>low_text=0.1 å€¼è¶Šå°ï¼Œå›¾ç‰‡å†…å®¹è¢«è¯†åˆ«ä¸ºæ–‡æœ¬å—çš„å¯èƒ½æ€§å°±æ›´é«˜</li>
<li>width_ths=0.3 æ§åˆ¶æ¨ªå‘å›¾ç‰‡å†…å®¹æ˜¯å¦ä¼šè¢«è¯†åˆ«ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªæ–‡æœ¬å—ï¼Œå€¼è¶Šå°è¢«è¯†åˆ«æˆå¤šä¸ªæ–‡æœ¬å—çš„å¯èƒ½æ€§å°±æ›´é«˜</li>
<li>å¾…ç»­&hellip;</li>
</ol>
<p>å‚è€ƒï¼š</p>
<ol>
<li><a href="https://www.jaided.ai/easyocr/documentation/" title="å®˜æ–¹æ–‡æ¡£"target="_blank" rel="external nofollow noopener noreferrer">å®˜æ–¹æ–‡æ¡£<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://cloud.tencent.com/developer/article/2016127" title="Pythonä½¿ç”¨EasyOCRåº“å¯¹è¡Œç¨‹ç å›¾ç‰‡è¿›è¡ŒOCRæ–‡å­—è¯†åˆ«ä»‹ç»ä¸å®è·µ"target="_blank" rel="external nofollow noopener noreferrer">Pythonä½¿ç”¨EasyOCRåº“å¯¹è¡Œç¨‹ç å›¾ç‰‡è¿›è¡ŒOCRæ–‡å­—è¯†åˆ«ä»‹ç»ä¸å®è·µ<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ol>]]></description></item><item><title>presto è‡ªå®šä¹‰å‡½æ•°ç®€è¿°</title><link>https://hpk.me/posts/presto-udf-simple/</link><pubDate>Tue, 18 Apr 2023 14:16:42 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/presto-udf-simple/</guid><description><![CDATA[<p>prestoè‡ªå¸¦unbase64å‡½æ•°æŸäº›æ—¶å€™ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥æƒ³è¦è‡ªå®šä¹‰ä¸€ä¸ªunbase64å‡½æ•°ã€‚</p>
<p>prestoè‡ªå¸¦unbase64å‡½æ•°ï¼Œç”¨æ³•å¦‚ä¸‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">FROM_UTF8(from_base64(nickname))
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½†æ˜¯æœ‰äº›å­—ç¬¦ä¼šæŠ¥é”™ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Query failed (#20220720_091551_00087_mkhun): Illegal base64 character -1a
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ideaæ–°å»ºmavené¡¹ç›®">ideaæ–°å»ºmavené¡¹ç›®</h2>
<p>pomæ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">    <span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.facebook.presto<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>presto-spi<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>0.272<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.google.guava<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>guava<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>18.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;build&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugins&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;artifactId&gt;</span>maven-jar-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;configuration&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;classesDirectory&gt;</span>target/classes/<span class="nt">&lt;/classesDirectory&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;archive&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;manifest&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;mainClass&gt;</span>com.alibaba.dubbo.container.Main<span class="nt">&lt;/mainClass&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="c">&lt;!-- æ‰“åŒ…æ—¶ MANIFEST.MFæ–‡ä»¶ä¸è®°å½•çš„æ—¶é—´æˆ³ç‰ˆæœ¬ --&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;useUniqueVersions&gt;</span>false<span class="nt">&lt;/useUniqueVersions&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;addClasspath&gt;</span>true<span class="nt">&lt;/addClasspath&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;classpathPrefix&gt;</span>lib/<span class="nt">&lt;/classpathPrefix&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;/manifest&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;manifestEntries&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;Class-Path&gt;</span>.<span class="nt">&lt;/Class-Path&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;/manifestEntries&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;/archive&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/configuration&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;artifactId&gt;</span>maven-dependency-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;executions&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;execution&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;id&gt;</span>copy-dependencies<span class="nt">&lt;/id&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;goals&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;goal&gt;</span>copy-dependencies<span class="nt">&lt;/goal&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;/goals&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;configuration&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;type&gt;</span>jar<span class="nt">&lt;/type&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;includeTypes&gt;</span>jar<span class="nt">&lt;/includeTypes&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;outputDirectory&gt;</span>
</span></span><span class="line"><span class="cl">                                ${project.build.directory}/lib
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;/outputDirectory&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;/configuration&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;/execution&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/executions&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;groupId&gt;</span>com.facebook.presto<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;artifactId&gt;</span>presto-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;version&gt;</span>0.3<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;extensions&gt;</span>true<span class="nt">&lt;/extensions&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugins&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/build&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="functionå¼€å‘">functionå¼€å‘</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">base64</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.facebook.presto.common.type.StandardTypes</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.facebook.presto.spi.function.Description</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.facebook.presto.spi.function.ScalarFunction</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.facebook.presto.spi.function.SqlType</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.airlift.slice.Slice</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.airlift.slice.Slices</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnBase64Function</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ScalarFunction</span><span class="o">(</span><span class="s">&#34;unBase64&#34;</span><span class="o">)</span> <span class="c1">// å›ºå®šå‚æ•°ï¼Œè¡¨ç¤ºå‡½æ•°åçš„æ„æ€ï¼Œä¹Ÿå°±æˆ‘ä»¬åœ¨ä½¿ç”¨Prestoçš„æ—¶å€™ç”¨çš„å‡½æ•°å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Description</span><span class="o">(</span><span class="s">&#34;base64è§£å¯†&#34;</span><span class="o">)</span> <span class="c1">// å‡½æ•°çš„æ³¨é‡Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@SqlType</span><span class="o">(</span><span class="n">StandardTypes</span><span class="o">.</span><span class="na">VARCHAR</span><span class="o">)</span> <span class="c1">// è¡¨ç¤ºæ•°æ®ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Slice</span> <span class="nf">unBase64</span><span class="o">(</span><span class="nd">@SqlType</span><span class="o">(</span><span class="n">StandardTypes</span><span class="o">.</span><span class="na">VARCHAR</span><span class="o">)</span> <span class="n">Slice</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è§£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">res</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">byte</span><span class="o">[]</span> <span class="n">decodeBytes</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="n">input</span><span class="o">.</span><span class="na">toStringUtf8</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">decodeBytes</span><span class="o">,</span> <span class="s">&#34;utf-8&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Slices</span><span class="o">.</span><span class="na">utf8Slice</span><span class="o">(</span><span class="n">res</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="pluginå¼€å‘">pluginå¼€å‘</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64.Base64Function</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64.UnBase64Function</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.facebook.presto.spi.Plugin</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.google.common.collect.ImmutableSet</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PrestoUdfPlugin</span> <span class="kd">implements</span> <span class="n">Plugin</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">getFunctions</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ImmutableSet</span><span class="o">.&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span><span class="n">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// æ·»åŠ æ’ä»¶class
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">UnBase64Function</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="åŠ è½½plugin">åŠ è½½plugin</h2>
<p>åœ¨src/main/resourcesä¸‹åˆ›å»ºç›®å½•META-INFï¼Œå†åœ¨META-INFç›®å½•ä¸‹åˆ›å»ºservicesç›®å½•ï¼Œæ³¨æ„ä¸‹å›¾é¡¹ç›®ç»“æ„ä¸­META-INFæ˜¯çˆ¶ç›®å½• servicesæ˜¯å­ç›®å½•ï¼Œåªæ˜¯ideaåˆå¹¶æ˜¾ç¤ºäº†ï¼Œä¸æ˜¯è¯´æ–‡ä»¶å¤¹åé‡Œé¢æœ‰ç‚¹ â€œ.â€ ã€‚ç„¶ååˆ›å»ºæ–‡ä»¶com.facebook.presto.spi.Pluginï¼Œæ–‡ä»¶å†…å®¹ä¸ºpluginçš„å…¨ç±»åã€‚
ä¾‹å¦‚æœ¬ä¾‹ï¼š<code>PrestoUdfPlugin</code></p>
<h2 id="ä¸Šçº¿">ä¸Šçº¿</h2>
<ol>
<li>mavenæ‰“åŒ…ã€‚</li>
<li>åœ¨æ‰€æœ‰prestoèŠ‚ç‚¹æœåŠ¡å™¨çš„prestoå®‰è£…ç›®å½•${PRESTO_HOME}/pluginä¸‹æ–°å»ºä¸€ä¸ªmy_pluginç›®å½•ã€‚</li>
<li>ä¸Šä¼ jaråŒ…ï¼ŒåŠç›¸å…³ä¾èµ–åŒ…ï¼ˆåœ¨libç›®å½•ä¸‹ï¼‰åˆ°æ‰€æœ‰æœåŠ¡å™¨æ–°å»ºçš„my_pluginç›®å½•ä¸‹ã€‚</li>
<li>é‡å¯prestoï¼š ${PRESTO_HOME}/bin/launcher restartã€‚</li>
</ol>
<h1 id="é¡¹ç›®ç»“æ„">é¡¹ç›®ç»“æ„</h1>
<p><figure><a class="lightgallery" href="https://m.360buyimg.com/babel/jfs/t1/2081/12/19574/60306/62d7d4afEe88e1e4b/e23c77b2aa3d6304.png" data-thumbnail="https://m.360buyimg.com/babel/jfs/t1/2081/12/19574/60306/62d7d4afEe88e1e4b/e23c77b2aa3d6304.png" data-sub-html="<h2>ç»“æ„</h2><p>ç»“æ„</p>"></a><figcaption class="image-caption">ç»“æ„</figcaption>
  </figure></p>
<p>å‚è€ƒï¼š<a href="https://blog.csdn.net/Mrerlou/article/details/119997884" title="ã€prestoã€‘æ–¹æ³•äºŒï¼šprestoå®ç°è‡ªå®šä¹‰UDFå‡½æ•°"target="_blank" rel="external nofollow noopener noreferrer">ã€prestoã€‘æ–¹æ³•äºŒï¼šprestoå®ç°è‡ªå®šä¹‰UDFå‡½æ•°<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>]]></description></item><item><title>python3 pandas å®ç°mysql upsertæ“ä½œï¼ˆå”¯ä¸€é”®æ›´æ–°ï¼‰</title><link>https://hpk.me/posts/python3-pandas-mysql-upsert/</link><pubDate>Tue, 18 Apr 2023 14:15:04 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/python3-pandas-mysql-upsert/</guid><description><![CDATA[<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">parse</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">parse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="s1">&#39;xxxxxx.mysql.rds.aliyuncs.com&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">3306</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span>
</span></span><span class="line"><span class="cl">           <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;mysql+pymysql://</span><span class="si">%(user)s</span><span class="s1">:</span><span class="si">%(password)s</span><span class="s1">@</span><span class="si">%(host)s</span><span class="s1">:</span><span class="si">%(port)d</span><span class="s1">/</span><span class="si">%(database)s</span><span class="s1">?charset=utf8&#39;</span> <span class="o">%</span> <span class="n">db_info</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mysql_replace_into</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">data_iter</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">sqlalchemy.dialects.mysql</span> <span class="kn">import</span> <span class="n">insert</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data_iter</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">update_stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">on_duplicate_key_update</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">inserted</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">stmt</span><span class="o">.</span><span class="n">inserted</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update_stmt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">write_database</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">mysql_replace_into</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;app_id&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;app_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;11111122&#34;</span><span class="p">,</span> <span class="s2">&#34;game_id&#34;</span><span class="p">:</span> <span class="mi">11</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;app_id&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;app_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;22222233&#34;</span><span class="p">,</span> <span class="s2">&#34;game_id&#34;</span><span class="p">:</span> <span class="mi">22</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;app_id&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&#34;app_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;33333344&#34;</span><span class="p">,</span> <span class="s2">&#34;game_id&#34;</span><span class="p">:</span> <span class="mi">33</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">detailDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">write_database</span><span class="p">(</span><span class="n">detailDF</span><span class="p">,</span> <span class="s2">&#34;ad_app_ext&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>sqoop mysql update AUTO_INCREMENT è‡ªå¢ä¸»é”®é‡å¤å¢é•¿é—®é¢˜</title><link>https://hpk.me/posts/sqoop-mysql-update-auto-increment/</link><pubDate>Tue, 18 Apr 2023 14:11:19 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/sqoop-mysql-update-auto-increment/</guid><description><![CDATA[<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sqoop <span class="nb">export</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--update-key unique_index_columns <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--update-mode allowinsert
</span></span></code></pre></td></tr></table>
</div>
</div><p>é—®é¢˜æè¿°ï¼š
ç”¨ä¸Šè¿°æ¨¡å¼ sqoop å¯¼å…¥æ•°æ®æ›´æ–° mysql æ•°æ®ï¼Œæ— è®ºå¯¼å…¥çš„æ•°æ®ä¸mysqlé‡Œæ•°æ®ç›¸æ¯”æœ‰æ²¡æœ‰æ›´æ–°ï¼Œmysqlè¡¨çš„ AUTO_INCREMENT çš„PRIMARY KEY ä¾‹å¦‚ ï¼ˆ<code>id</code> int(11) NOT NULL AUTO_INCREMENT COMMENT &lsquo;è‡ªå¢ä¸»é”®&rsquo;ï¼‰ å®é™…éƒ½æ˜¯å¢åŠ äº†çš„ï¼Œå½“æœ‰æ–°å”¯ä¸€ä¸»é”®æ•°æ®æ’å…¥æ—¶ï¼Œidä¼šæ˜¯ç´¯åŠ åçš„å¼€å§‹ï¼Œä¼šå˜çš„å¾ˆå¤§ã€‚</p>
<p>è§£å†³ï¼š
sqoopæºç å±‚çº§æš‚æ—¶æ²¡çœ‹åŸå› ã€‚ã€‚ã€‚
å¯ä»¥ä»ä¸šåŠ¡æµç¨‹ä¸Šè§£å†³ä¸‹è¿™ä¸ªé—®é¢˜ï¼Œä¿è¯å¯¼å…¥çš„æ•°æ®éƒ½æ˜¯æ–°å¢æˆ–è€…æ›´æ–°çš„ï¼Œä¸ä¼šæœ‰ä¸mysqlä¸€æ ·çš„æ•°æ®ï¼Œå¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šå‡å°‘ id çš„å¢é•¿ã€‚</p>]]></description></item><item><title>è„šæœ¬æ‰§è¡Œspark-shell scalaæ–‡ä»¶é€€å‡º</title><link>https://hpk.me/posts/bash-spark-shell-scala/</link><pubDate>Tue, 18 Apr 2023 14:09:10 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/bash-spark-shell-scala/</guid><description><![CDATA[<p>è„šæœ¬</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#! /bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">source</span> /etc/profile
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">set</span> +o posix  <span class="c1"># to enable process substitution when not running on bash </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">scala_file</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">shift</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">arguments</span><span class="o">=</span><span class="nv">$@</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">##### scala æ–‡ä»¶ååŠ   sys.exit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">spark-shell --master yarn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--executor-cores <span class="m">5</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--num-executors <span class="m">4</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--executor-memory 8g <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--driver-memory 3g <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.serializer<span class="o">=</span>org.apache.spark.serializer.KryoSerializer <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.default.parallelism<span class="o">=</span><span class="m">400</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.sql.shuffle.partitions<span class="o">=</span><span class="m">400</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.shuffle.io.maxRetries<span class="o">=</span><span class="m">10</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.shuffle.io.retryWait<span class="o">=</span>20s <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.yarn.executor.memoryOverhead<span class="o">=</span><span class="m">4096</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.network.timeout<span class="o">=</span>300s <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--name sparkshell_scala <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-i &lt;<span class="o">(</span><span class="nb">echo</span> <span class="s1">&#39;val args = &#34;&#39;</span><span class="nv">$arguments</span><span class="s1">&#39;&#34;.split(&#34;\\s+&#34;)&#39;</span> <span class="p">;</span> cat <span class="nv">$scala_file</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç®€å•scalaæ–‡ä»¶ç¤ºä¾‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">val</span> <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="na">read</span><span class="o">.</span><span class="na">parquet</span><span class="o">(</span><span class="n">path</span><span class="o">).</span><span class="na">where</span><span class="o">(</span><span class="s">&#34;app_id = 77701&#34;</span><span class="o">).</span><span class="na">repartition</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">write</span><span class="o">.</span><span class="na">parquet</span><span class="o">(</span><span class="n">s</span><span class="s">&#34;${path}_new&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sys</span><span class="o">.</span><span class="na">exit</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœä¸éœ€è¦ä¼ å‚ï¼Œå¯ç®€å•ä½¿ç”¨</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">spark-shell &lt; test.scala
</span></span></code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>kudu-spark KuduContext java.io.InvalidClassException è§£å†³</title><link>https://hpk.me/posts/kudu-spark-invalid-class-exception/</link><pubDate>Tue, 18 Apr 2023 13:56:34 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/kudu-spark-invalid-class-exception/</guid><description><![CDATA[<p>èƒŒæ™¯ï¼š
çº¿ä¸Škudu é›†ç¾¤ç‰ˆæœ¬ä¸º1.11.0ç‰ˆæœ¬, spark ä½¿ç”¨ kudu-spark2_2.11-1.7.0.jarï¼Œ
ä¸ºäº†ä½¿ç”¨æ–°ç‰ˆæœ¬ä¸­çš„
<code>val wo = new KuduWriteOptions(ignoreNull = true)</code>
ç‰¹æ€§ï¼Œå‡çº§è‡³ kudu-spark2_2.11-1.11.0.jar ç‰ˆæœ¬ï¼Œä½†æ˜¯æŠ¥é”™ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InvalidClassException</span><span class="o">:</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">kudu</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">kudu</span><span class="o">.</span><span class="na">KuduContext</span><span class="o">;</span> <span class="n">local</span> <span class="kd">class</span> <span class="nc">incompatible</span><span class="o">:</span> <span class="n">stream</span> <span class="n">classdesc</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">xxxxxxxx</span><span class="o">,</span> <span class="n">local</span> <span class="kd">class</span> <span class="nc">serialVersionUID</span> <span class="o">=</span> <span class="n">xxxxxxx111</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨https://issues.apache.org/jira/browse/KUDU-2898 ä¸­è¯´è¿™ä¸ªå·²ç»ä¿®å¤ï¼Œä½†æ˜¯ä¿®å¤çš„ç‰ˆæœ¬æ˜¯kudu 1.12.0ï¼Œå‡çº§çº¿ä¸Škuduç‰ˆæœ¬è¿™ä¸ªæš‚æ—¶ä¸è€ƒè™‘ï¼Œåªå¥½è‡ªå·±ä¿®æ”¹æºç ï¼Œé‡æ–°ç¼–è¯‘ kudu-spark2_2.11-1.11.0.jar</p>
<ul>
<li>
<p>1.è§£å‹ kudu-spark2_2.11-1.11.0.jar ï¼Œå°†è§£å‹å‡ºçš„æ‰€æœ‰æ–‡ä»¶å¤¹ç§»åŠ¨è‡³ä¸€ä¸ªç©ºæ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚tmp</p>
</li>
<li>
<p>2.åœ¨ideaä¸­æ–°å»ºmavené¡¹ç›®ï¼Œé…ç½®å¥½ scala ç­‰ç¯å¢ƒ</p>
</li>
<li>
<p>3.è§£å‹ kudu-spark2_2.11-1.11.0-sources.jarï¼Œå°† å…¶ä¸­ org æ–‡ä»¶å¤¹ å¤åˆ¶ è‡³ mavenä¸­åˆšåˆšå»ºå¥½çš„é¡¹ç›®ä¸­ï¼ˆorg/apache/kudu/spark/kuduï¼‰</p>
</li>
<li>
<p>4.ä¿®æ”¹æ–‡ä»¶ KuduContext.scala ã€ KuduRDD.scalaï¼Œ å¢åŠ æˆ–ä¿®æ”¹ @SerialVersionUID(xxxxxxxxxxL) ï¼Œxxxxxxxxxxæ”¹ä¸ºæŠ¥é”™ä¿¡æ¯ä¸­çš„local class serialVersionUID<br></p>
</li>
<li>
<p><br></p>
</li>
<li>
<p><br></p>
</li>
<li>
<p><br></p>
</li>
<li>
<p>5ï¼šOperationType.scalaæ–‡ä»¶ä¹Ÿéœ€ä¿®æ”¹ï¼Œå’Œ ä¸Šé¢çš„serialVersionUIDä¸åŒï¼Œèµ°å®Œæ•´ä¸ªæµç¨‹è¿è¡Œä¼šæŠ¥è¿™ä¸ªæ–‡ä»¶çš„serialVersionUIDé”™è¯¯ï¼Œæ”¹æˆé”™è¯¯ä¿¡æ¯ä¸­çš„local class serialVersionUID</p>
</li>
<li>
<p>6.å°† kudu-spark2_2.11-1.11.0.pom ä¸­çš„ dependencies ç²˜è´´è‡³ maven ä¸­é¡¹ç›®çš„pomæ–‡ä»¶ä¸­ï¼Œè¿˜éœ€é¢å¤–å¢åŠ ä»¥ä¸‹ä¾èµ–ï¼š</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.apache.kudu<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>kudu-client<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>1.11.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.apache.yetus<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>audience-annotations<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>0.13.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.hdrhistogram<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>HdrHistogram<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>2.1.12<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>7.ideaä¸­å°†mavené¡¹ç›®æ‰“åŒ…</p>
</li>
<li>
<p>8.å°†ideaä¸­æ‰“å¥½çš„åŒ…è§£å‹ï¼Œå°†å…¶ä¸­ org/apache/kudu/spark/kudu  ä¸‹çš„æ–‡ä»¶è¦†ç›–è‡³ tmp ä¸­ org/apache/kudu/spark/kudu</p>
</li>
<li>
<p>9.å°† tmp æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰ç›®å½•æ‰“åŒ…æˆæ–°çš„jaråŒ…</p>
</li>
</ul>
<p>å‚è€ƒé“¾æ¥ï¼š</p>
<ol>
<li><a href="https://community.cloudera.com/t5/Support-Questions/KUDU-need-rebuild-post-upgrade-of-CDH-cluster/td-p/92885"target="_blank" rel="external nofollow noopener noreferrer">https://community.cloudera.com/t5/Support-Questions/KUDU-need-rebuild-post-upgrade-of-CDH-cluster/td-p/92885<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://issues.apache.org/jira/browse/KUDU-2898"target="_blank" rel="external nofollow noopener noreferrer">https://issues.apache.org/jira/browse/KUDU-2898<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ol>]]></description></item><item><title>phoenix-client-4.14.1-HBase-1.4.jar jaråŒ…å†²çªè§£å†³</title><link>https://hpk.me/posts/phoenix-client-hbase-jar/</link><pubDate>Tue, 18 Apr 2023 13:49:28 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/phoenix-client-hbase-jar/</guid><description><![CDATA[<p>é¡¹ç›®ç”¨åˆ°phoenixï¼Œä½¿ç”¨äº†è¿™ä¸ªjaråŒ…phoenix-client-4.14.1-HBase-1.4.jarï¼Œè¿™ä¸ªjaråŒ…å¯¼è‡´çš„jaråŒ…å†²çªå¾ˆå¤šï¼Œä¸€ç•ªæ‘¸ç´¢ï¼Œè§£å†³äº†ï¼Œè§£å†³å¦‚ä¸‹ã€‚</p>
<p>å…ˆjarå‘½ä»¤è§£å‹jaråŒ…ï¼Œç„¶ååˆ é™¤ä»¥ä¸‹å†…å®¹ã€‚ç„¶ååœ¨jarå‘½ä»¤æ‰“æˆjaråŒ…ã€‚</p>
<ol>
<li>rm -r javax/</li>
<li>rm -r com/jayway/</li>
<li>rm -r org/apache/phoenix/shaded/org/apache/thrift</li>
<li>rm -r com/sun/jersey/</li>
</ol>]]></description></item><item><title>spark è¯»å– hive date åˆ†åŒºè¡¨ å¥‡æ€ªçš„æŠ¥é”™</title><link>https://hpk.me/posts/spark-hive-partition-issue/</link><pubDate>Mon, 17 Apr 2023 21:29:55 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/spark-hive-partition-issue/</guid><description><![CDATA[<p>å½“ hive è¡¨çš„åˆ†åŒºå­—æ®µ æ˜¯ date ç±»å‹æ—¶ï¼Œç”¨å¦‚ä¸‹æ–¹å¼è¯»å–ä¼šå‘ç”ŸæŠ¥é”™ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">targetDay</span> <span class="k">=</span> <span class="s">&#34;2020-08-20&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">table</span><span class="o">(</span><span class="n">tableName</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="s">s&#34;targetday in (&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,59),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,49),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,39),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,29),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,14),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,6),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,5),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,4),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,3),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,2),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,1),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,0))&#34;</span> <span class="o">).</span><span class="n">show</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>targetday ä¸º è¡¨çš„åˆ†åŒºå­—æ®µï¼Œdateç±»å‹ã€‚
å½“ in åé¢ çš„æ—¥æœŸä¸ªæ•°å¤§äº 10 æ—¶å°±ä¼šæŠ¥é”™ï¼Œå°äºç­‰äº 10 æ—¶éƒ½ä¸ä¼šæŠ¥é”™ã€‚å¥‡æ€ªçš„ç°è±¡ã€‚ã€‚ã€‚
targetday ä¸º string ç±»å‹ä¸ä¼šæœ‰æ­¤é”™è¯¯ã€‚</p>]]></description></item><item><title>Apache Kudu å†™å…¥æ•°æ®å®šæœŸå‡ºé—®é¢˜</title><link>https://hpk.me/posts/kudu-periodic-issues/</link><pubDate>Mon, 17 Apr 2023 21:23:09 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/kudu-periodic-issues/</guid><description><![CDATA[<p>çº¿ä¸Šé¡¹ç›®å‡ºç°ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„é—®é¢˜ï¼Œæ•°æ®ç»è¿‡Sparkç¨‹åºæ¶ˆè´¹Kafkaå†™å…¥Kuduï¼Œå‡ºç°Kudu Masterè¿æ¥è¶…æ—¶ï¼Œè¿™ä¸ªé—®é¢˜å¼€å§‹æ’æŸ¥ä¸å‡ºåŸå› ï¼Œæœ‰ç‚¹å¤´å¤§ï¼Œåªèƒ½é‡‡ç”¨ä¸‹ä¸‹ç­–ï¼Œé‡å¯Sparkç¨‹åºï¼Œå‡ºç°è¿‡å‡ æ¬¡åï¼Œ æˆ‘è®°å½•äº†å‡ºç°çš„æ—¶é—´ï¼Œå‘ç°æ¯æ¬¡å‡ºç°æ—¶é—´æœ‰ä¸ªå›ºå®šå‘¨æœŸï¼Œä¸€å‘¨ï¼Œæœ‰è§„å¾‹å°±æ˜¯æœ€å¤§çš„å¥½æ¶ˆæ¯ï¼Œæ„Ÿè§‰ç¦»å‘ç°çœŸç›¸ä¸è¿œäº†ï¼Œæœç„¶ç½‘ä¸Šæœ‰è¿™æ–¹é¢çš„é—®é¢˜è®¨è®ºï¼Œè™½è¯´ä»¥å‰ä¹Ÿå»ç½‘ä¸Šæœç´¢è¿‡ç›¸å…³é—®é¢˜ï¼Œæ¯•ç«ŸKuduç›¸æ¯”äºHiveã€HBaseè¿˜æ˜¯å°ä¼—äº†ä¸€ç‚¹ã€‚ã€‚ã€‚æ˜¯Kudu Java Clientçš„é—®é¢˜ï¼Œä½¿ç”¨1.5ä»¥ä¸Šç‰ˆæœ¬å°±æ²¡é—®é¢˜äº†ã€‚</p>
<p>å‚è€ƒï¼š<a href="https://blog.csdn.net/u011489205/article/details/79173537"target="_blank" rel="external nofollow noopener noreferrer">å…³äºkuduä½¿ç”¨çš„ä¸€äº›é—®é¢˜åŠè§£å†³åŠæ³•<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>]]></description></item><item><title>spark yarn clusteræ¨¡å¼ä¸‹log4jæ—¥å¿—çš„é…ç½®</title><link>https://hpk.me/posts/spark-yarn-cluster-log4j/</link><pubDate>Mon, 17 Apr 2023 21:19:43 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/spark-yarn-cluster-log4j/</guid><description><![CDATA[<p>æœ€è¿‘çº¿ä¸Šçš„sparké¡¹ç›®æ—¥å¿—æ–‡ä»¶æ€¥å‰§å¢åŠ ï¼Œç£ç›˜é¡¶ä¸ä½äº†å•Šï¼Œè§£å†³æ—¥å¿—æ–‡ä»¶é—®é¢˜ï¼Œå‚è€ƒä¸‹é¢ä¸‰ç¯‡æ–‡ç« ï¼ŒåŸºæœ¬å°±å¯ä»¥ææ˜ç™½äº†ã€‚</p>
<ol>
<li><a href="https://www.jianshu.com/p/0fe51185eeba"target="_blank" rel="external nofollow noopener noreferrer">Sparkæ—¥å¿—è¿‡å¤§å¯¼è‡´ç£ç›˜æº¢å‡ºé—®é¢˜è§£å†³æ–¹æ¡ˆ<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="http://www.cnblogs.com/163yun/p/9882530.html"target="_blank" rel="external nofollow noopener noreferrer">Sparkæ—¥å¿—é…ç½®åŠé—®é¢˜æ’æŸ¥æ–¹å¼ã€‚<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://blog.csdn.net/ZMC921/article/details/80238392"target="_blank" rel="external nofollow noopener noreferrer">Spark log4j æ—¥å¿—é…ç½®è¯¦è§£<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ol>
<p>ä»¥ä¸Šå†…å®¹è½¬è½½è‡ªç½‘ç»œï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ã€‚</p>]]></description></item><item><title>äº”åä¸ªç”µå­ä¹¦æœç´¢ç½‘</title><link>https://hpk.me/posts/book-search-website/</link><pubDate>Mon, 17 Apr 2023 21:15:15 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/book-search-website/</guid><description><![CDATA[<p><em>è½¬è½½è‡ªç½‘ç»œï¼Œä¸ä¿è¯å¯ç”¨æ€§åŠæ˜¯å¦æ‹¥æœ‰ç‰ˆæƒï¼Œä»…ä¾›åˆ†äº«ï¼Œå¦‚æœ‰æ³•å¾‹çº çº·ï¼Œè¯·è”ç³»åˆ é™¤ã€‚</em></p>
<h1 id="å›½å†…ç½‘ç«™"><strong>å›½å†…ç½‘ç«™</strong></h1>
<p>1ã€é¸ æ‘©æœä¹¦</p>
<p>ç½‘å€ï¼šhttps://www.jiumodiary.com/</p>
<p>ä¸€ä¸ªå¼ºå¤§çš„æœä¹¦ç¥ç«™ï¼Œæ— è®ºæ˜¯ä»€ä¹ˆç±»å‹çš„ä¹¦ç±ï¼Œåªè¦ä½ çŸ¥é“ä¹¦åï¼Œå°±å¯ä»¥è½»æ¾çš„æœåˆ°ä½ æƒ³è¦ä¹¦ç±ã€‚é¡µé¢ç®€å•æ˜äº†ï¼Œä¹¦ç±ç§ç±»ç¹å¤šï¼Œæ ¼å¼å¤šç§å¤šæ ·ï¼Œæœ‰mobiæ ¼å¼ã€pdfæ ¼å¼ã€wordæ ¼å¼ã€txtæ ¼å¼ç­‰ã€‚å…³é”®æ˜¯å¯ä»¥æ— é™ä¸‹è½½ï¼Œæ— éœ€æ³¨å†Œç™»å½•ã€‚</p>
<p>2ã€å‘¨è¯»</p>
<p>ç½‘å€ï¼šhttp://www.ireadweek.com/index.php/Index/index.html</p>
<p>å‘¨è¯»æ˜¯ä¸€ä¸ªæä¾›ä¼˜è´¨çš„epud,mobi,pdf,txtç”µå­ä¹¦ä¸‹è½½å’Œåˆ†äº«çš„ç½‘ç«™ï¼Œå¸®åŠ©ä¸çŸ¥é“è¯»ä»€ä¹ˆä¹¦çš„ç”¨æˆ·ï¼Œé€‰æ‹©å€¼å¾—è¯»çš„å¥½ä¹¦ç±ï¼Œè¯¥ç½‘ç«™æä¾›å¤šç§ä¹¦ç±åˆ†ç±»ï¼Œæ¶µç›–äº†å¤§å¤šæ•°çš„å¯è¯»ä¹¦ç±ã€‚</p>
<p>3ã€æˆ‘çš„å°ä¹¦å±‹</p>
<p>ç½‘å€ï¼šhttp://mebook.cc/</p>
<p>å…è´¹æ— å¹¿å‘Šã€ç”µå­ä¹¦çš„è´¨é‡å¾ˆå¥½ï¼Œå›¾ä¹¦éƒ½æ˜¯ç»è¿‡ç«™é•¿ç²¾æŒ‘ç»†é€‰çš„ã€‚ç½‘ç«™åˆ†ä¸ºç•…é”€å°è¯´ã€ç½‘ç»œå°è¯´ã€åˆé›†èµ„æºã€å¤šçœ‹ä¸“åŒºã€æ‚å¿—æœŸåˆŠã€æ¼«ç”»ã€å·¥å…·ä¹¦ã€åŸç‰ˆä¹¦ç±ã€è½»å°è¯´ç­‰æ¨¡å—ã€‚ç«™é•¿æ¯å¤©éƒ½ä¼šæ¨èæ›´æ–°å‡ æœ¬ä¹¦ï¼Œä¹¦å¤ªå¤šä¸çŸ¥é“è¯»ä»€ä¹ˆï¼Œå°±è¯•è¯•ç«™é•¿æ¨èçš„å§ã€‚</p>
<p>4ã€ä¹¦æ ¼</p>
<p>ç½‘å€ï¼š <a href="https://shuge.org/"target="_blank" rel="external nofollow noopener noreferrer">https://shuge.org/<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>ä¹¦æ ¼æ˜¯ä¸€ä¸ªè‡ªç”±å¼€æ”¾çš„åœ¨çº¿å¤ç±å›¾ä¹¦é¦†ï¼Œè‡´åŠ›äºå¼€æ”¾å¼åˆ†äº«ã€ä»‹ç»ã€æ¨èå¤æœ¬ï¼ˆå››ä¹ä»¥å‰çš„å½±åƒæœ¬ï¼‰PDFï¼›ç½‘ç«™è‡´åŠ›äºä¸ºå¤ç±çš„ä¿æŠ¤ä¸æ•°å­—åŒ–ä¼ æ’­è´¡çŒ®ã€‚</p>
<p>5ã€è¥¿æ—è¡—æœç´¢</p>
<p>ç½‘å€ï¼šhttp://www.xilinjie.com/</p>
<p>ä¸“æ³¨äºç½‘ç›˜ã€è§†é¢‘ã€æ–‡åº“ï¼ˆæ–‡æ¡£ã€å¤ç±ã€ä¸“ä¸šä¹¦ç±ã€ç”µå­ä¹¦PDFã€ePubã€Mobiç­‰æ ¼å¼ï¼‰ã€å­¦æœ¯ï¼ˆå„ç§æœŸåˆŠã€è®ºæ–‡ã€å­¦æŠ¥ç­‰ï¼‰å’ŒMoocï¼ˆåœ¨çº¿è¯¾ç¨‹ã€å­¦ä¹ ã€è§†é¢‘æ•™ç¨‹ï¼‰ç­‰èµ„æºçš„æœç´¢ã€‚</p>
<p>6ã€å¥½è¯»</p>
<p>ç½‘å€ï¼šhttp://haodoo.net</p>
<p>å…è´¹çš„çº¿ä¸Šç¹ä½“ä¸­æ–‡å›¾ä¹¦é¦†ï¼Œå¯åœ¨çº¿é˜…è¯»åŠä¸‹è½½ï¼Œå¯ä¸‹è½½çš„æ ¼å¼æœ‰ï¼šupdbï¼Œpdbï¼Œprcï¼Œepubã€‚</p>
<p>7ã€å›¾çµç¤¾åŒº</p>
<p>ç½‘å€ï¼šhttp://www.ituring.com.cn/</p>
<p>å›¾çµç¤¾åŒºä¸»è¦ä¸“æ³¨äºç§‘æŠ€ä¹¦ç±çš„å‡ºç‰ˆï¼ŒåŒ…æ‹¬è®¡ç®—æœºã€æ•°å­¦ç»Ÿè®¡ã€ç§‘æ™®ç­‰é¢†åŸŸï¼Œæä¾›å…è´¹å’Œä»˜è´¹çš„ç”µå­ä¹¦ã€‚ç”¨æˆ·å¯ä»¥ä½¿ç”¨ç½‘é“¶æˆ–è€…æ”¯ä»˜å®çš„è´­ä¹°æ–¹å¼ï¼Œå¤§éƒ¨åˆ†ç”µå­ä¹¦åŒæ—¶æä¾›äº†ä¸‰ç§é˜…è¯»æ–¹å¼ï¼šåœ¨çº¿é˜…è¯»ã€MOBI æ¨é€ã€PDF ä¸‹è½½ï¼Œéƒ¨åˆ†ä¹¦ç±åªæä¾›å…¶ä¸­éƒ¨åˆ†æ ¼å¼ã€‚</p>
<p>8ã€ç›˜æœ</p>
<p>ç½‘å€ï¼šhttp://www.pansoso.com/</p>
<p>ä¸€ä¸ªè€ç‰Œç½‘ç›˜æœç´¢å·¥å…·ï¼ŒåŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œç•Œé¢éå¸¸ç®€æ´ã€‚æ¯å¤©éƒ½æœ‰æ›´æ–°ï¼Œä¸åŒè¾¾äººåˆ†äº«è‡ªå·±çš„â€œç›˜ä¸­èµ„æºâ€ï¼ç›˜æœä¸å­˜å‚¨ä»»ä½•ç½‘ç›˜å†…å®¹ï¼Œä½†æ˜¯èµ„æºéå¸¸ä¸°å¯Œï¼Œæ— è®ºæ˜¯å·¥ä½œè¿˜æ˜¯å­¦ä¹ éƒ½å¿…å¤‡ã€‚</p>
<p>9ã€è‹¦ç“œä¹¦ç›˜</p>
<p>ç½‘å€ï¼šhttps://kgbook.com/</p>
<p>è‹¦ç“œä¹¦ç›˜,ç”µå­ä¹¦åˆ†äº«çš„å¹³å°ã€‚é€‚åˆç”µçº¸ä¹¦é˜…è¯»çš„6å¯¸pdfåŠmobiæ ¼å¼ç”µå­ä¹¦åˆ¶ä½œæŠ€æœ¯çš„ç½‘ç«™ã€‚</p>
<p>10ã€æ–°æµªçˆ±é—®å…±äº«èµ„æ–™</p>
<p>ç½‘å€ï¼šhttp://ishare.iask.sina.com.cn/</p>
<p>æ–°æµªçˆ±é—®å…±äº«èµ„æ–™æ˜¯æ–°æµªæ——ä¸‹çš„åœ¨çº¿èµ„æ–™åˆ†äº«ç«™ï¼Œå…è´¹é«˜é€Ÿä¸Šä¼ æˆ–ä¸‹è½½å„ç±»èµ„æºï¼Œå†…å®¹æ¶‰åŠæ•™è‚²èµ„æºã€ä¸“ä¸šèµ„æ–™ã€ITçš„èµ„æ–™ã€å¨±ä¹ç”Ÿæ´»ã€ç»æµç®¡ç†ã€åŠå…¬æ–‡ä¹¦ã€æ¸¸æˆèµ„æ–™ç­‰ã€‚å¦‚æœä½ è¦å¯»æ‰¾åå­¦æœ¯çš„èµ„æ–™ï¼Œæ‰€æœ‰åœ°æ–¹éƒ½æ‰¾ä¸åˆ°ï¼Œå¯ä»¥æ¥è¿™é‡Œè¯•è¯•ï¼Œä¸€èˆ¬ä¸ºæ‰«æç‰ˆPDFã€‚</p>
<p>11ã€Eä¹¦è”ç›Ÿ</p>
<p>ç½‘å€ï¼šhttp://www.book118.com/</p>
<p>Eä¹¦è”ç›Ÿæ˜¯ä¸€ä¸ªåºå¤§çš„å…è´¹ä¸­æ–‡ç”µå­ä¹¦ä¸‹è½½ç«™ï¼Œæä¾›å„ç±»ç”µå­ä¹¦ä¸‹è½½ï¼Œå…¶ä¸­å«æ¯”è¾ƒä¸“ä¸šçš„ç”µå­å›¾ä¹¦ï¼Œæä¾›éƒ¨åˆ†ç”µå­ä¹¦åœ¨çº¿é˜…è¯»ã€‚</p>
<p>12ã€äº‘æµ·ç”µå­å›¾ä¹¦é¦†</p>
<p>ç½‘å€ï¼šhttp://www.pdfbook.cn/</p>
<p>äº‘æµ·ç”µå­å›¾ä¹¦é¦†æ˜¯è‡´åŠ›äºpdfç”µå­ä¹¦çš„ä¸“ä¸šç½‘ç«™,æä¾›å„é—¨ç±»pdfç”µå­ä¹¦ä¸‹è½½åŠé«˜æ¸…pdfç”µå­ä¹¦ã€‚</p>
<p>13ã€ä¸‡åƒé›†åˆç«™</p>
<p>ç½‘å€ï¼šhttp://www.hejizhan.com/html/search</p>
<p>åŒ…å«éå¸¸å¤šçš„æ•™æç±»ç›¸å…³ç”µå­ä¹¦ç±ï¼Œæœç´¢åç›´æ¥æ˜¾ç¤ºä¸‹è½½é“¾æ¥ã€‚æœç´¢ç»“æœåŸºæœ¬æ¶µç›–äº†æ‰€æœ‰ç‰ˆæœ¬çš„ç”µå­æ•™æã€ä¹ é¢˜è¯¦è§£ç­‰ã€‚å¦‚æœä¸Šå¤§å­¦æ—¶æœ‰è¿™ç§èµ„æºï¼Œå°±çœä¸‹å¥½å¤šä¹°æ•™æã€ä¹ é¢˜è§£ç­”çš„é’±äº†ã€‚</p>
<p>14ã€èš‚èšæœä¹¦</p>
<p>ç½‘å€ï¼šhttp://book.mybanshu.win/</p>
<p>ITä¹¦æ›´å¤šçš„èµ„æºç½‘ç«™ï¼Œæ”¯æŒä¸‹è½½ï¼Œä¸æ”¯æŒkindleæ¨é€ã€‚æ³¨å†Œéœ€è¦åŠ å¾®ä¿¡ç´¢è¦é‚€è¯·ç ï¼Œä¹Ÿæ˜¯ç®¡ç†å¾ˆä¸¥æ ¼äº†ã€‚</p>
<p>15ã€ä¹¦è¯­è€…</p>
<p>ç½‘å€ï¼šhttps://book.shuyuzhe.com/</p>
<p>ä¹¦è¯­è€…ç”µå­å›¾ä¹¦é¦†ï¼Œä¸€ä¸ªæœä¹¦ç½‘ç«™ï¼Œè®©ä½ å¿«é€Ÿæ‰¾åˆ°æƒ³è¦çš„ä¹¦ç±ï¼</p>
<p>16ã€è®¡ç®—æœºä¹¦æ§</p>
<p>ç½‘å€ï¼šhttp://bestcbooks.com/</p>
<p>è¿™ä¸ªç½‘ç«™å¯è°“æ˜¯è®¡ç®—æœºä¸“ä¸šçš„ç¦éŸ³ï¼Œè¿™é‡ŒåŒ…å«è®¸å¤šä¼˜ç§€çš„è®¡ç®—æœºä¹¦ç±ä¸‹è½½ã€‚æ— è®ºæ˜¯è‹±æ–‡åŸç‰ˆè¿˜æ˜¯ä¸­æ–‡è¿™é‡Œéƒ½æœ‰ã€‚</p>
<p>17ã€å½±å°å¤ç±èµ„æ–™</p>
<p>ç½‘å€ï¼šhttps://sou-yun.com/eBookIndex.aspx</p>
<p>æä¾›7000+ç§å¤ç±èµ„æ–™çš„ç½‘ä¸Šé˜…è¯»å’ŒPDFæ ¼å¼ä¸‹è½½æœåŠ¡ã€‚</p>
<p>18ã€çŸ¥è½©è—ä¹¦</p>
<p>ç½‘å€ï¼šhttp://www.zxcs8.com/</p>
<p>è¿™æ˜¯ä¸€ä¸ªå°è¯´ç½‘ç«™ï¼Œåœ¨è¿™é‡Œä½ å¯ä»¥æ‰¾åˆ°ä½ æƒ³è¦çš„å°è¯´ã€‚</p>
<p>19ã€å›½å­¦ç½‘</p>
<p>åœ°å€ï¼šhttp://www.guoxue.com/</p>
<p>ä¸€å®¶åœ¨å›½å­¦ä¼ æ’­é¢†åŸŸç‹¬å…·ç‰¹è‰²çš„æ–‡åŒ–åˆ›æ„ä¼ä¸šï¼Œä¸»è¦ä»äº‹å¤ç±æ•°å­—åŒ–ç ”ç©¶ã€ç½‘ç»œæ–‡çŒ®æ£€ç´¢å¼€å‘å’Œç½‘ç«™å»ºè®¾ï¼Œæ˜¯ä¸­å›½æœ€å¤§çš„ä¸“ä¸šå¤ç±ç”µå­æ–‡çŒ®æ•°æ®å…¬å¸ä¹‹ä¸€ã€‚</p>
<p>20ã€å›½å®¶æ•°å­—å›¾ä¹¦é¦†</p>
<p>ç½‘å€ï¼š <a href="http://www.nlc.gov.cn/index.htm"target="_blank" rel="external nofollow noopener noreferrer">http://www.nlc.gov.cn/index.htm<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>å¤§é‡åœ¨çº¿èµ„æºã€å­æ•°æ®åº“ã€å¯ä»¥åœ¨çº¿é˜…è¯»æµ·é‡ç”µå­ä¹¦ï¼Œéœ€è¦æ³¨å†Œï¼ˆå®åæ³¨å†Œã€éœ€è¦èº«ä»½è¯å·ï¼‰ã€‚å›½å›¾è´­ä¹°äº†å¤§é‡èµ„æºï¼Œæœ‰è´¦å·ï¼Œä¾¿å¯åœ¨çº¿é˜…è¯»æˆ–è€…ä¸‹è½½ï¼Œç‰ˆæƒæœŸé™å†…çš„å›¾ä¹¦åªèƒ½è¯»å‰ä¸¤ç« ï¼Œæ°‘å›½å›¾ä¹¦å’Œå¤ç±åˆ™å¯é˜…è¯»å…¨éƒ¨å†…å®¹ã€‚</p>
<p>21ã€PDFä¹‹å®¶</p>
<p>ç½‘å€ï¼š <a href="http://www.pdfzj.com/"target="_blank" rel="external nofollow noopener noreferrer">http://www.pdfzj.com/<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>PDFä¹‹å®¶ï¼Œåšä¸­å›½æœ€å¥½çš„pdfèµ„æºç«™ï¼Œè‡´åŠ›æœ€å…¨æœ€æ–°çš„pdfæ‚å¿—ã€æœŸåˆŠæ‚å¿—ã€ç”µå­æ‚å¿—ã€ç”µå­å›¾ä¹¦çš„å…è´¹åˆ†äº«å’Œä¸‹è½½æœåŠ¡ã€‚</p>
<p>22ã€æˆ‘çˆ±è¯»ç”µå­ä¹¦</p>
<p>ç½‘å€ï¼šhttp://www.woaidu.org/</p>
<p>æˆ‘çˆ±è¯»ç”µå­ä¹¦æ˜¯æƒå¨ç”µå­ä¹¦æœç´¢å¼•æ“ï¼Œå¯ä»¥ä½¿ç”¨æˆ‘çˆ±è¯»ç”µå­ä¹¦å¿«é€Ÿçš„æ‰¾åˆ°è‡ªå·±å–œæ¬¢çš„ç”µå­ä¹¦ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¹¦æ¦œäº†è§£æœ€æ–°æœ€çƒ­é—¨çš„ä¹¦ï¼Œéšæ—¶éšåœ°ç•…æƒ³è‡ªå·±å–œæ¬¢çš„ä¹¦ã€‚</p>
<p>23ã€é«˜æ¸…æ‚å¿—ç½‘</p>
<p>ç½‘å€ï¼šhttp://www.gqzzw.com/</p>
<p>é«˜æ¸…æ‚å¿—ç½‘æä¾›æ‚å¿—å›½å†…çƒ­é—¨åŸç‰ˆé«˜æ¸…ç”µå­æ‚å¿—ä¸‹è½½æœåŠ¡,ç›®å‰æœ‰è´¢ç»ç†è´¢ã€ç”µè„‘æ•°ç ã€æ•…äº‹ä¼ å¥‡ã€å©šå§»å®¶åº­ã€å¥åº·å…»ç”Ÿã€æ•™è‚²æ•™å­¦ã€ç»æµæ³•å¾‹ã€ç§‘æŠ€ç§‘æ™®ã€æ—…æ¸¸æ°‘ä¿—ã€å¥³æ€§æ‚å¿—ç­‰ç­‰ã€‚</p>
<p>24ã€è¶…æ˜Ÿç”µå­ä¹¦</p>
<p>ç½‘å€ï¼šhttp://www.chaoxing.com</p>
<p>40ä¸‡ç”µå­ä¹¦ï¼Œæ³¨å†Œåå¯ä»¥åœ¨çº¿æˆ–ä½¿ç”¨å®¢æˆ·ç«¯é˜…è¯»æµ·é‡ä¹¦ç±ã€‚è‹¥åœ¨æ•™è‚²ç½‘ä¸­ï¼Œæ¨èåŒ…åº“ç½‘å€ ï¼Œå¯ä»¥å°†PDGæ ¼å¼ç”µå­ä¹¦ä¸‹è½½åˆ°æœ¬æœºä¸Šç¦»çº¿é˜…è¯»ã€‚pdgå¦‚ä½•è½¬æˆpdfï¼Œè¯·çœ‹ç™¾åº¦ç»éªŒ ã€‚è¯¥ç«™å…±äº«èµ„æ–™é¡µä¹Ÿæœ‰å¤§é‡èµ„æºã€‚</p>
<p>25ã€èµ°è¯»æ´¾</p>
<p>åœ°å€ï¼šhttp://zoudupai.com</p>
<p>ç€‘å¸ƒæµç”µå­ä¹¦ç½‘ç«™ï¼Œæ”¯æŒä¸‹è½½å’Œæ¨é€ï¼Œæ³¨å†Œç™»é™†åæ— å…¶ä»–é™åˆ¶ï¼Œä½†æ˜¯ä¹¦ä¸å¤šï¼Œä¸Šä¼ èµ„æºéœ€è¦å…ˆç”³è¯·ã€‚èµ„æºè´¨é‡æœ‰å¾…ä¼˜åŒ–ã€‚å…¶ä¹¦è¯„ç³»ç»Ÿ #ä¹¦ç“¦å°# å½¢å¼æ¥è¿‘å¾®åšã€‚</p>
<p>26ã€æŒä¸Šä¹¦è‹‘</p>
<p>åœ°å€ï¼šhttps://www.cnepub.com/</p>
<p>Epubæ ¼å¼ç”µå­ä¹¦ä¸‹è½½ç«™ï¼Œä¸‹è½½å’Œæ¨é€å‡ä¸ºä»˜è´¹æœåŠ¡ï¼Œä½†æ˜¯å¯ä»¥å…è´¹åœ¨çº¿é˜…è¯»</p>
<p>27ã€ä¼—äººæœç´¢ç½‘</p>
<p>ç½‘å€ï¼šhttp://dianzishu.renrensousuo.com/</p>
<p>ä¸€ä¸ªç”µå­ä¹¦æœç´¢åŠŸèƒ½çš„ç½‘ç«™ï¼Œå¯ä»¥åŒæ—¶æœç´¢å„ç±»ç”µå­ä¹¦ã€ç”µå­å°è¯´ç­‰ã€‚</p>
<p>28ã€èƒ–æ¬¡æœç´¢</p>
<p>ç½‘å€ï¼šhttps://www.panc.cc/</p>
<p>èƒ–æ¬¡çš„æœç´¢ç»“æœéœ€è¦é…åˆç¹ä½“å­—æ‰èƒ½æœ‰æœ€ä½³æ•ˆæœï¼Œæ•´ä½“æ¥è¯´èƒ–æ¬¡è¿˜è›®å¥½ç”¨çš„ï¼Œè¿éšç§˜ç»è¿¹çš„è®²åº§å½•éŸ³/ç¬”è®°éƒ½æœ‰ï¼Œè¿™ä¸ªå¿…é¡»ç»™ç‚¹ä¸ªèµï¼ç•Œé¢åšçš„ä¹ŸæŒºç®€æ´ï¼Œèµ„æºæ–¹é¢è¯´å®è¯ä¹Ÿå¤Ÿçœ‹äº†ã€‚èƒ–æ¬¡å¯æœç´¢å½±éŸ³è§†é¢‘ã€éŸ³ä¹æ­Œæ›²ã€å°è¯´æ–‡æ¡£ã€ç¨‹åºAppã€å›¾ç‰‡å£çº¸ã€å‹ç¼©æ–‡ä»¶BTç§å­ç­‰èµ„æºï¼›èƒ–æ¬¡æœç´¢å¦‚æœæ˜¯æ— æ•ˆèµ„æºï¼Œä¼šæ˜¾ç¤ºå‡ºæ¥ï¼Œè¿™ä¸ªå¾ˆæ–¹ä¾¿ã€‚</p>
<p>29ã€ç›˜å¤šå¤š</p>
<p>ç½‘å€ï¼šhttp://www.panduoduo.net/</p>
<p>çƒ­é—¨èµ„æºã€ä¸“ä¸šèµ„æºæ–¹é¢å‡ºæ¥çš„ç»“æœéƒ½å¾ˆæ£’ã€‚office2016ï¼Œå„ç§‘ç›®çš„æ–‡çŒ®èµ„æ–™éƒ½æœ‰ï¼Œåªè¦ç‚¹å‡»é“¾æ¥ï¼Œå°±èƒ½è¿›å…¥è¯¦ç»†é¡µé¢è¿›è¡Œä¸‹è½½ï¼Œåœ¨é¡µé¢ä¸‹æ–¹ï¼Œä¹Ÿåˆ—å‡ºäº†å…¶ä»–ç›¸å…³èµ„æºï¼Œå…¨ç«™æ— è¯±å¯¼ä¸‹è½½çš„å‡æŒ‰é’®ï¼ŒçœŸå¿ƒä¸é”™ã€‚å°é—®é¢˜ï¼šèµ„æºæœ€ä¸°å¯Œï¼Œä½†æ˜¯å¶å°”ä¸ç¨³å®šã€‚</p>
<p>30ã€å»è½¬ç›˜ç½‘</p>
<p>ç½‘å€ï¼šhttp://www.quzhuanpan.com/</p>
<p>å»è½¬ç›˜æœ‰ç€é£æ™¯å®œäººçš„ç•Œé¢ï¼Œæ˜¯ä¸€ä¸ªç½‘ç›˜æœç´¢å¼•æ“ï¼Œå¯ä»¥æœç´¢btå’Œç½‘ç›˜èµ„æºè¿˜æœ‰èµ„æºåˆ†äº«ç­‰åŠŸèƒ½ï¼Œæœç´¢ç±»å‹ä¸»è¦æœ‰å½±è§†ã€éŸ³ä¹ã€ç”µå­ä¹¦ã€ç§å­ã€è½¯ä»¶ç­‰å„ç§èµ„æºï¼Œæœç´¢ç½‘ç›˜ä¸ºç™¾åº¦ç½‘ç›˜ã€‚åŒæ—¶å¼€å‘äº†PCç«¯å’Œappå®¢æˆ·ç«¯ï¼Œé“¾æ¥é¾™è½©å¯¼èˆªã€å“”å“©å“”å“©ã€å’ªå’•é±¼ç­‰ç½‘ç«™ï¼ŒåŠŸèƒ½ååˆ†å¼ºå¤§ã€‚</p>
<p>31ã€éº¦åº“æœç´¢</p>
<p>ç½‘å€ï¼šhttp://huisou.me/</p>
<p>éº¦åº“æœç´¢ç•Œé¢ç›¸å½“ç®€çº¦ï¼Œä½†ä¸å½±å“å…¶å¼ºå¤§çš„æœç´¢åŠŸèƒ½ã€‚éº¦åº“æ˜¯åˆ©ç”¨Googleåˆ›å»ºçš„ä¸€ç³»åˆ—å‚ç›´æœç´¢å¼•æ“ï¼Œæ‰€ä»¥Googleçš„ä¸€äº›ä½¿ç”¨æŠ€å·§åŒæ ·é€‚åˆäºéº¦åº“æœç´¢ã€‚éº¦åº“æ•°æ®æ¥æºï¼šç™¾åº¦ç½‘ç›˜ï¼Œæ–°æµªå¾®ç›˜ç­‰ã€‚</p>
<p>32ã€ç‰¹ç™¾åº¦</p>
<p>ç½‘å€ï¼šhttp://www.tebaidu.com/</p>
<p>ç‰¹ç™¾åº¦äº‘æä¾›ç™¾åº¦äº‘æ——ä¸‹çš„ç™¾åº¦ç½‘ç›˜æœç´¢ä¸‹è½½ç™¾åº¦ç½‘ç›˜çš„èµ„æºï¼Œæœ¬ç«™ä¹Ÿæ”¯æŒç™¾åº¦ç½‘ç›˜ç™»é™†ï¼Œç™¾åº¦ç½‘ç›˜æ˜¯ç›®å‰å—æ¬¢è¿çš„Tçº§è¶…å¤§å…è´¹ç½‘ç›˜ï¼Œæ³¨å†Œç”¨æˆ·è¿‡äº¿ã€‚</p>
<p>33ã€å²è±å§†æœç´¢</p>
<p>ç½‘å€ï¼šhttp://www.slimego.cn/</p>
<p>æœ€ä¸°å¯Œçš„å­¦ä¹ èµ„æ–™åº“,æ”¶é›†æ•´ç†äº†å¤§é‡å…è´¹èµ„æº,æ•™å­¦èµ„æº,ç™¾åº¦äº‘èµ„æº,ç½‘ç›˜èµ„æºã€‚åŒ…å«ä¸»æµçš„èµ„æºæœç´¢å¤–,è¿˜èƒ½æ‰¾åˆ°å„è¡Œä¸šç»†åˆ†çš„å­¦ä¹ èµ„æºã€‚</p>
<h1 id="å›½å¤–ç½‘ç«™"><strong>å›½å¤–ç½‘ç«™</strong></h1>
<p>34ã€Library Genesis</p>
<p>ç½‘å€ï¼šhttp://gen.lib.rus.ec/</p>
<p>è¿™ä¸ªç•Œé¢ç®€æ´æ˜äº†ï¼Œè¾“å…¥ä½ æƒ³è¦æ‰¾çš„å…³é”®è¯æˆ–è€…å…¨åï¼Œå°±å¯ä»¥æœåˆ°è¯¥é¢†åŸŸçš„ä¸€äº›ç”µå­ä¹¦ç±ã€‚ä¸€äº›ç§‘ç ”çš„ç”µå­ä¹¦ï¼Œè¿˜æœ‰ç§‘ç ”è®ºæ–‡ã€å°è¯´ã€å–œå‰§ã€è¡Œä¸šæ ‡å‡†ã€æ‚å¿—å•¥çš„éƒ½å¯ä»¥æœæœè¯•è¯•ã€‚ä»è¿™ä¸ªç½‘ç«™æœç´¢å¯ä»¥æœå‡ºä¸€æœ¬ä¹¦çš„å¥½å¤šç‰ˆæœ¬ï¼Œå¤§å®¶æ ¹æ®è‡ªå·±çš„éœ€æ±‚ä¸‹è½½ã€‚</p>
<p>35ã€Project Gutenberg</p>
<p>ç½‘å€ï¼šhttp://www.gutenberg.org/</p>
<p>å®ƒæ˜¯å›½å¤–ä¸€ä¸ªçŸ¥åçš„ç”µå­ä¹¦å…è´¹åˆ†äº«ç½‘ç«™ï¼Œæ—¨åœ¨åŸºäºäº’è”ç½‘ï¼Œå¤§é‡æä¾›ç‰ˆæƒè¿‡æœŸè€Œè¿›å…¥å…¬æœ‰é¢†åŸŸä¹¦ç±çš„ä¸€é¡¹åä½œè®¡åˆ’ï¼Œæœ€åˆæ˜¯åœ¨1971å¹´7æœˆç”±Michael Hartå‘èµ·çš„ã€‚ç™»å ¡è®¡åˆ’æ˜¯äº’è”ç½‘ä¸Šæœ€æ—©çš„å…è´¹ç”µå­ä¹¦ç½‘ç«™ã€‚å®ƒä»¬æ‹¥æœ‰ä¼—å¤šçš„å¿—æ„¿è€…ï¼Œè—ä¹¦é‡è¶…è¿‡4ä¸‡æœ¬ã€‚ä¹¦æµ·èŒ«èŒ«ï¼Œæ‰¾æœ¬å¥½ä¹¦ä¸å®¹æ˜“ï¼Œè€Œå¤ç™»å ¡çš„ä¹¦ç±ä¸‹è½½æ’è¡Œæ¦œæœ‰å¾ˆé«˜çš„å‚è€ƒä»·å€¼ã€‚</p>
<p>36ã€ebookee</p>
<p>ç½‘å€ï¼š <a href="https://ebookee.org/"target="_blank" rel="external nofollow noopener noreferrer">https://ebookee.org/<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>è¯¥ç«™ä¹¦ç±ç§ç±»ä¸°å¯Œï¼ŒåŸºæœ¬ä¸“ä¸šä¹¦ç±éƒ½å¯æ‰¾åˆ°ã€‚ç½‘ç«™æ˜¯æŒ‰ç…§ä¸»é¢˜åˆ†ç±»çš„ï¼Œç‰¹åˆ«æ–¹ä¾¿æŸ¥æ‰¾ï¼</p>
<p>37ã€Planet eBook</p>
<p>ç½‘å€ï¼šhttps://www.planetebook.com/</p>
<p>è¿™ä¸ªç½‘ç«™æ˜¯å…è´¹çš„å¤å…¸æ–‡å­¦çš„å®¶å›­ã€‚è¿™é‡Œæ‰€æœ‰çš„å°è¯´å’Œä¹¦ç±æ˜¯å®Œå…¨å…è´¹ä¸‹è½½å’Œå…±äº«ï¼Œå›¾é‡Œçœ‹åˆ°çš„1984ï¼ŒThe Great Gastsbyï¼Œåªè¦ç‚¹å‡»å›¾æ ‡ï¼Œå°±å¯ä»¥å¾ˆå¿«ä¸‹è½½ä¸‹æ¥ã€‚</p>
<p>38ã€HathiTrust Digital Library</p>
<p>ç½‘å€ï¼šhttps://www.hathitrust.org/</p>
<p>HathiTrustæ˜¯å­¦æœ¯å’Œç ”ç©¶æœºæ„åˆä½œï¼Œæä¾›ä¸€ä¸ªæ”¶é›†ä¸–ç•Œå„åœ°çš„æ•°ä»¥ç™¾ä¸‡è®¡çš„å›¾ä¹¦æ•°å­—åŒ–å›¾ä¹¦é¦†ã€‚å¯åœ¨çº¿é˜…è¯»ï¼Œä¹Ÿå¯ä¸‹è½½ã€‚</p>
<p>39ã€Wikibooks</p>
<p>ç½‘å€ï¼šhttps://en.wikibooks.org/wiki/Main_Page</p>
<p>Wikibooksï¼Œç»´åŸºæ•™ç§‘ä¹¦ï¼Œå†…å®¹å¼€æ”¾çš„æ•™ç§‘ä¹¦åŠæ‰‹å†Œé›†ã€‚æ˜¯ç»´åŸºåª’ä½“çš„ä¸€é¡¹å·¥ç¨‹ï¼Œä¹Ÿæ˜¯ç»´åŸºç™¾ç§‘çš„å§Šå¦¹è®¡åˆ’ï¼Œäº2003å¹´7æœˆ10æ—¥å¼€æ”¾ã€‚ æ­¤è®¡åˆ’æ”¶é›†è‡ªç”±çš„æ•™ç§‘ä¹¦ï¼Œç›®å½•æˆ–å…¶ä»–ç”¨æˆ·è‡ªå·±ç¼–è¾‘çš„ä¹¦ã€‚</p>
<p>40ã€Get Free e-Books</p>
<p>ç½‘å€ï¼šhttps://www.getfreeebooks.com/</p>
<p>å…è´¹ç”µå­å›¾ä¹¦ç½‘ç«™ï¼Œä¸‹è½½ä¹¦ç±ä¹Ÿæ˜¯å®Œå…¨å…è´¹ã€‚åœ¨è¿™ä¸ªç½‘ç«™ä¸Šï¼Œä½ æ‰¾åˆ°çš„ç”µå­ä¹¦æ”¶é›†æ¥è‡ªå„åœ°æˆ–ç”±åˆ›å§‹äººäº²è‡ªç¼–åˆ¶ã€‚</p>
<p>41ã€BookYards</p>
<p>ç½‘å€ï¼šhttps://www.bookyards.com/en/welcome</p>
<p>Bookyardsæœ‰22626æœ¬ä¹¦ç±ï¼Œè€Œä¸”å›¾ä¹¦é‡éšæ—¶åœ¨å¢åŠ ã€‚å®ƒè¿˜æœ‰å››ä¸‡å¤šä¸ªå¤–éƒ¨ç½‘ç«™é“¾æ¥ï¼Œå°†è¿‘äº”åƒä¸ªæ–°é—»å’Œåšå®¢çš„é“¾æ¥ï¼Œä¸‰ä¸‡å¤šä¸ªç”µå­ä¹¦é“¾æ¥å’Œè®¿é—®æ•°ä»¥ç™¾è®¡çš„ç½‘ä¸Šå›¾ä¹¦é¦†ã€‚</p>
<p>42ã€ePUBee</p>
<p>ç½‘å€ï¼šhttp://cn.epubee.com/books/</p>
<p>è¿™ä¸ªç½‘ç«™åº”è¯¥æ˜¯å…¨çƒæœ€å¤§çš„å…è´¹ç”µå­ä¹¦åº“ï¼Œè¶…è¿‡10ä¸‡æœ¬ä¹¦ç±ï¼Œ50ä¸‡ä¸ªæ–‡ä»¶ç‰ˆæœ¬ï¼Œæ€»èƒ½æ‰¾åˆ°ä½ å–œæ¬¢çš„é€‚åˆé˜…è¯»å™¨çš„ç”µå­ä¹¦æ–‡ä»¶ã€‚å“ç±»é½å…¨ï¼Œæœç´¢åŠŸèƒ½å¼ºå¤§ï¼Œå›¾ä¹¦ç®¡ç†æ–¹ä¾¿ã€‚</p>
<p>43ã€FreeBookSpot</p>
<p>ç½‘å€ï¼šhttp://www.freebookspot.es/</p>
<p>FreeBookSpotæ˜¯ä¸€ä¸ªå…è´¹è‹±æ–‡ç”µå­ä¹¦å¤§å…¨ç½‘ç«™ï¼Œå®ƒæä¾›æœ‰4485æœ¬å…è´¹ç”µå­ä¹¦ï¼Œåˆ†ä¸º96ä¸ªåˆ†ç±»ï¼Œé«˜è¾¾71.97GBã€‚ä½ å¯ä»¥é€šè¿‡åˆ†ç±»æœç´¢è¿™äº›å…è´¹ç”µå­ä¹¦ï¼Œæ¯”å¦‚ç§‘å­¦ï¼Œå·¥ä¸šï¼Œç¼–è¾‘ï¼Œå°è¯´æˆ–å…¶å®ƒç”µå­ä¹¦ã€‚å¹¶ä¸”æ²¡æœ‰æ³¨å†Œè¦æ±‚ï¼Œå°±å¯ä»¥å…è´¹ä¸‹è½½ç”µå­ä¹¦ã€‚</p>
<p>44ã€Free-eBooks</p>
<p>ç½‘å€ï¼šhttps://www.free-ebooks.net/</p>
<p>Free-eBooksæ˜¯ä¸€ä¸ªæä¾›å…è´¹ç”µå­ä¹¦ä¸‹è½½ï¼Œç”µå­ä¹¦èµ„æºï¼Œç”µå­ä¹¦ä½œè€…ä»‹ç»çš„ç½‘ç«™ï¼Œä½ å¯ä»¥å…è´¹ä¸‹è½½ä½ å–œæ¬¢çš„ç”µå­ä¹¦ï¼Œä¹Ÿå¯ä»¥ä¸Šä¼ ä½ è‡ªå·±çš„ç”µå­ä¹¦åˆ†äº«ã€‚ä½ éœ€è¦æ³¨å†Œæˆä¸ºè¯¥ç½‘ç«™çš„ç”¨æˆ·æ‰å¯ä»¥ä¸‹è½½å®ƒä»¬çš„ç”µå­æ”¶èµ„æºï¼Œä¸è¿‡æ³¨å†Œæ˜¯å…è´¹çš„ã€‚</p>
<p>45ã€ManyBooks</p>
<p>åœ°å€ï¼šhttp://manybooks.net/</p>
<p>ManyBooksæ˜¯ä¸€ä¸ªä¸“é—¨æä¾›å…è´¹ç”µå­ä¹¦ä¸‹è½½çš„ç½‘ç«™ï¼Œå®ƒæ‰€æä¾›çš„å…è´¹ç”µå­ä¹¦è¶…è¿‡2ä¸‡æœ¬ã€‚ä½ å¯ä»¥é€šè¿‡åˆ†ç±»ï¼Œä½œè€…ï¼Œä¹¦åå’Œè¯­è¨€è¿›è¡Œæœç´¢æŸ¥è¯¢ï¼Œæ¯æœ¬ä¹¦éƒ½åŒ…å«ä¸€ä¸ªç®€ä»‹ï¼ŒåŒ…æ‹¬ä¹¦åï¼Œä½œè€…ï¼Œå›½å®¶å’Œå†…å®¹ç®€ä»‹ã€‚æ‰€æœ‰ç”µå­ä¹¦å«éƒ½å¯ä»¥ä¸‹è½½ä¿å­˜ä¸ºå‡ åç§ç”µå­ä¹¦æ ¼å¼ï¼Œæ¯”å¦‚Docï¼ŒPDFï¼ŒRTFï¼ŒJARï¼ŒTXTç­‰ç­‰ã€‚</p>
<p>46ã€GetFreeEBooks</p>
<p>ç½‘å€ï¼šhttps://www.getfreeebooks.com/</p>
<p>GetFreeEBooksæ˜¯ä¸€ä¸ªæä¾›å…è´¹ç”µå­ä¹¦ä¸‹è½½çš„ç½‘ç«™ï¼Œç«™å†…çš„æ‰€æœ‰ç”µå­ä¹¦éƒ½å¯ä»¥å…è´¹ä¸‹è½½ã€‚æ›´é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œè¯¥ç½‘ç«™æä¾›çš„ç”µå­ä¹¦éƒ½æ˜¯ç¬¦åˆæ³•å¾‹è¦æ±‚æˆ–æ˜¯ç‰ˆæƒåè®®çš„ã€‚</p>
<p>47ã€FreeComputerBooks</p>
<p>ç½‘å€ï¼šhttp://freecomputerbooks.com/</p>
<p>FreeComputerBooksæ˜¯ä¸€ä¸ªä¸“é—¨æ”¶é›†è®¡ç®—æœºï¼Œç¼–è¾‘ï¼Œæ•°å­¦ï¼Œæ¼”è®²æŠ¥å‘Šå’Œæ•™ç¨‹ç­‰ä¸“ä¸šçŸ¥è¯†ç”µå­ä¹¦çš„ç½‘ç«™ã€‚å®ƒçš„ç½‘ç«™åˆ†ç±»ç»“æ„éå¸¸ç»†è‡´ï¼Œè¾¾åˆ°12å±‚çš„åˆ†ç±»ç³»ç»Ÿï¼Œè¶…è¿‡150ä¸ªå­åˆ†ç±»ã€‚æ–¹ä¾¿ä½ çš„ç”µå­ä¹¦æœç´¢æŸ¥æ‰¾ã€‚</p>
<p>48ã€FreeTechBooks</p>
<p>ç½‘å€ï¼šhttp://www.freetechbooks.com/</p>
<p>FreeTechBooksä¹Ÿæ˜¯ä¸€ä¸ªæä¾›ç§‘æŠ€ç±»å…è´¹ç”µå­ä¹¦ä¸‹è½½çš„ç½‘ç«™ï¼Œè¯¥ç½‘ç«™æä¾›çš„ç”µå­ä¹¦éƒ½æ˜¯ç¬¦åˆæ³•å¾‹è¦æ±‚æˆ–æ˜¯ç‰ˆæƒåè®®ï¼Œè®¸å¯å…è´¹çš„ã€‚</p>
<p>49ã€TheOnlineBooksPage</p>
<p>ç½‘å€ï¼šhttp://digital.library.upenn.edu/books/</p>
<p>TheOnlineBooksPageåˆ—å‡ºäº†ä¸€ä»½å…è´¹ç”µå­ä¹¦åˆ—è¡¨ï¼Œè¶…è¿‡3ä¸‡æœ¬å…è´¹ç”µå­ä¹¦ä¾›ç”¨æˆ·å…è´¹ä¸‹è½½ã€‚</p>
<p>50ã€Owllook</p>
<p>ç½‘å€ï¼šhttps://www.owllook.net/</p>
<p>ä¸€ä¸ªå…è´¹ä¸‹è½½å„ç±»å°è¯´çš„æœç´¢å¼•æ“ï¼Œ é¡µé¢æ¸…æ–°ç®€æ´ï¼Œæ— å¹¿å‘Šã€‚ç›´æ¥è¾“å…¥ä¹¦åå³å¯æœç´¢ã€‚</p>]]></description></item><item><title>é˜¿é‡ŒDruidè¿æ¥æ± è¿æ¥ä¸é‡Šæ”¾ã€è¿æ¥æ³„æ¼æ’æŸ¥</title><link>https://hpk.me/posts/druid-connect-not-free/</link><pubDate>Mon, 17 Apr 2023 21:12:25 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/druid-connect-not-free/</guid><description><![CDATA[<p>é…ç½®å¥½ä¸‹é¢ä¸‰ä¸ªå±æ€§ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- è¶…è¿‡æ—¶é—´é™åˆ¶æ˜¯å¦å›æ”¶ --&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;removeAbandoned&#34;</span> <span class="na">value=</span><span class="s">&#34;true&#34;</span> <span class="nt">/&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="c">&lt;!-- è¶…æ—¶æ—¶é—´ï¼›å•ä½ä¸ºç§’ã€‚180ç§’=3åˆ†é’Ÿ   --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;removeAbandonedTimeout&#34;</span> <span class="na">value=</span><span class="s">&#34;180&#34;</span> <span class="nt">/&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="c">&lt;!-- å…³é—­abandedè¿æ¥æ—¶è¾“å‡ºé”™è¯¯æ—¥å¿—   --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;logAbandoned&#34;</span> <span class="na">value=</span><span class="s">&#34;true&#34;</span> <span class="nt">/&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">2019-04-17 17:10:05:140 - ERROR [Druid-ConnectionPool-Destroy-1559154670] - com.alibaba.druid.pool.DruidDataSource com.alibaba.druid.pool.DruidDataSource.removeAbandoned:2666 abandon connection, owner thread: http-nio-8085-exec-1, connected at : 1555491605100, open stackTrace
</span></span><span class="line"><span class="cl">	at java.lang.Thread.getStackTrace(Thread.java:1559)
</span></span><span class="line"><span class="cl">	at com.alibaba.druid.pool.DruidDataSource.getConnectionDirect(DruidDataSource.java:1313)
</span></span><span class="line"><span class="cl">	at com.alibaba.druid.pool.DruidDataSource.getConnection(DruidDataSource.java:1235)
</span></span><span class="line"><span class="cl">	at com.alibaba.druid.pool.DruidDataSource.getConnection(DruidDataSource.java:1225)
</span></span><span class="line"><span class="cl">	at com.xxxx.xx.common.util.JdbcUtil.linkTrace(JdbcUtil.java:39)
</span></span><span class="line"><span class="cl">	at com.xxxx.xx.xxxxx.service.impl.DashboardServiceImpl.getExpenTrend(DashboardServiceImpl.java:263)
</span></span><span class="line"><span class="cl">	at com.xxxx.xx.xxxxx.service.impl.DashboardServiceImpl.getBossData(DashboardServiceImpl.java:58)
</span></span><span class="line"><span class="cl">	at com.xxxx.xx.xxxxx.controller.DashboardController.getBossData(DashboardController.java:43)
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ—¥å¿—é‡ŒæŸ¥æ‰¾<code>removeAbandoned</code>å…³é”®å­—ï¼Œæ‰¾åˆ°è‡ªå·±å“ªä¸ªæ–¹æ³•è·å–è¿æ¥åæ²¡æœ‰å…³é—­èµ„æºï¼Œæ’æŸ¥åŸå› ã€‚</p>]]></description></item><item><title>spring cloud javaåå‘ä»£ç†è®¿é—®é˜¿é‡Œäº‘OSSç§æœ‰èµ„æº</title><link>https://hpk.me/posts/spring-proxy-oss/</link><pubDate>Mon, 17 Apr 2023 20:43:10 +0800</pubDate><author>hpkaiq</author><guid>https://hpk.me/posts/spring-proxy-oss/</guid><description><![CDATA[<p>æœ€è¿‘ç”¨åˆ°é˜¿é‡Œäº‘ossï¼Œæœ‰é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼Œé€šè¿‡ä»£ç†å†…ç½‘è®¿é—®å¯ä»¥å®ç°å…é™¤OSSæµé‡è´¹ï¼ŒæŸ¥åˆ°å¾ˆå¤šnginxåå‘ä»£ç†çš„æ•™ç¨‹ï¼Œä½†æ˜¯çº¯javaå®ç°æ²¡æœ‰æ‰¾åˆ°ï¼Œæ„Ÿè§‰å¯ä»¥è¯•ä¸€è¯•ã€‚</p>
<p>ï¼ˆä¸€ï¼‰
é¦–å…ˆè¦è§£å†³åå‘ä»£ç†çš„é—®é¢˜ï¼Œæœåˆ°<code>org.mitre.dsmiley.httpproxy.ProxyServlet</code>å¯è§£å†³ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;groupId&gt;</span>org.mitre.dsmiley.httpproxy<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;artifactId&gt;</span>smiley-http-proxy-servlet<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;version&gt;</span>1.11<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ServletRegistrationBean</span> <span class="nf">servletRegistrationAliBean01</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ServletRegistrationBean</span> <span class="n">oss</span>  <span class="o">=</span> <span class="k">new</span> <span class="n">ServletRegistrationBean</span><span class="o">(</span><span class="k">new</span> <span class="n">ProxyServlet</span><span class="o">(),</span> <span class="s">&#34;/ali/bucket_name/*&#34;</span><span class="o">);</span><span class="c1">//ä¿®æ”¹ä¸ºè‡ªå·±çš„bucket_name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">oss</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;bucket_name&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">oss</span><span class="o">.</span><span class="na">addInitParameter</span><span class="o">(</span><span class="s">&#34;targetUri&#34;</span><span class="o">,</span> <span class="s">&#34;http://bucket_name.oss-cn-beijing.aliyuncs.com&#34;</span><span class="o">);</span><span class="c1">//æœ¬åœ°æµ‹è¯•ç¯å¢ƒç”¨å¤–ç½‘åœ°å€ï¼Œçº¿ä¸Šæ”¹æˆå†…ç½‘è®¿é—®çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">oss</span><span class="o">.</span><span class="na">addInitParameter</span><span class="o">(</span><span class="n">ProxyServlet</span><span class="o">.</span><span class="na">P_LOG</span><span class="o">,</span> <span class="s">&#34;true&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">oss</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ï¼ˆäºŒï¼‰
Controlleré…ç½®å¦‚ä¸‹ï¼Œè½¬å‘åˆ°è‡ªå·±é…ç½®çš„åå‘ä»£ç†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">@RestController
</span></span><span class="line"><span class="cl">@RefreshScope
</span></span><span class="line"><span class="cl">@RequestMapping(&#34;/api/es&#34;)
</span></span><span class="line"><span class="cl">public class TestController {
</span></span><span class="line"><span class="cl">     @RequestMapping(&#34;/static/**&#34;)
</span></span><span class="line"><span class="cl">    public void testVideoOne(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException, URISyntaxException {
</span></span><span class="line"><span class="cl">        String resourcePath = request.getRequestURI().replace(&#34;/api/es/static&#34;,&#34;&#34;);
</span></span><span class="line"><span class="cl">        HeaderUtil.setHeaderOwn(request,resourcePath);
</span></span><span class="line"><span class="cl">        request.getRequestDispatcher(&#34;/ali&#34; + resourcePath).forward(request, response);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ï¼ˆä¸‰ï¼‰
å…¶ä¸­ä¸ºrequestè®¾ç½®Headerä»¥è®¤è¯OSSè®¿é—®çš„HeaderUtilå¦‚ä¸‹ï¼Œå…¶ä¸­æœ‰OSS Authorizationè®¡ç®—çš„javaå®ç°ï¼Œç”¨javaçš„åå°„åœ¨requestä¸­æ·»åŠ Headerä¿¡æ¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">import org.apache.commons.codec.binary.Base64;
</span></span><span class="line"><span class="cl">import org.apache.tomcat.util.http.MimeHeaders;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">import javax.crypto.Mac;
</span></span><span class="line"><span class="cl">import javax.crypto.spec.SecretKeySpec;
</span></span><span class="line"><span class="cl">import javax.servlet.http.HttpServletRequest;
</span></span><span class="line"><span class="cl">import java.lang.reflect.Field;
</span></span><span class="line"><span class="cl">import java.net.URISyntaxException;
</span></span><span class="line"><span class="cl">import java.nio.charset.Charset;
</span></span><span class="line"><span class="cl">import java.security.InvalidKeyException;
</span></span><span class="line"><span class="cl">import java.security.NoSuchAlgorithmException;
</span></span><span class="line"><span class="cl">import java.text.SimpleDateFormat;
</span></span><span class="line"><span class="cl">import java.util.Date;
</span></span><span class="line"><span class="cl">import java.util.Locale;
</span></span><span class="line"><span class="cl">import java.util.TimeZone;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">public class HeaderUtil {
</span></span><span class="line"><span class="cl">    /**
</span></span><span class="line"><span class="cl">     * ç»™requeståŠ å…¥Headerä¿¡æ¯ï¼ŒéªŒè¯OSSè®¿é—®æƒé™
</span></span><span class="line"><span class="cl">     * @param request
</span></span><span class="line"><span class="cl">     * @throws URISyntaxException
</span></span><span class="line"><span class="cl">     */
</span></span><span class="line"><span class="cl">    public static void setHeaderOwn(HttpServletRequest request,String resourcePath) throws URISyntaxException {
</span></span><span class="line"><span class="cl">        SimpleDateFormat sdf = new SimpleDateFormat(&#34;EEE, dd MMM yyyy HH:mm:ss &#39;GMT&#39;&#34;, Locale.US);
</span></span><span class="line"><span class="cl">        sdf.setTimeZone(TimeZone.getTimeZone(&#34;GMT&#34;));
</span></span><span class="line"><span class="cl">        String date_GMT = sdf.format(new Date());
</span></span><span class="line"><span class="cl">        String data = request.getMethod() + &#34;\n&#34;
</span></span><span class="line"><span class="cl">                + &#34;\n&#34;
</span></span><span class="line"><span class="cl">                + &#34;\n&#34;
</span></span><span class="line"><span class="cl">                + date_GMT + &#34;\n&#34;
</span></span><span class="line"><span class="cl">                + resourcePath;
</span></span><span class="line"><span class="cl">        String signature = genHMAC(&#34;AccessKeySecret&#34;, data);//AccessKeySecretæ”¹æˆè‡ªå·±çš„
</span></span><span class="line"><span class="cl">        reflectSetParam(request, &#34;Authorization&#34;, &#34;OSS AccessKeyId:&#34; + signature);//AccessKeyIdæ”¹æˆè‡ªå·±çš„
</span></span><span class="line"><span class="cl">        reflectSetParam(request, &#34;Date&#34;, date_GMT);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    /**
</span></span><span class="line"><span class="cl">     * åå°„ä¿®æ”¹headerä¿¡æ¯ï¼Œkey-valueé”®å€¼å¯¹åŠ å…¥åˆ°headerä¸­
</span></span><span class="line"><span class="cl">     *
</span></span><span class="line"><span class="cl">     * @param request
</span></span><span class="line"><span class="cl">     * @param key
</span></span><span class="line"><span class="cl">     * @param value
</span></span><span class="line"><span class="cl">     */
</span></span><span class="line"><span class="cl">    private static void reflectSetParam(HttpServletRequest request, String key, String value) {
</span></span><span class="line"><span class="cl">        Class&lt;? extends HttpServletRequest&gt; requestClass = request.getClass();
</span></span><span class="line"><span class="cl">        // System.out.println(&#34;requestå®ç°ç±»=&#34;+requestClass.getName());
</span></span><span class="line"><span class="cl">        try {
</span></span><span class="line"><span class="cl">            Field request1 = requestClass.getDeclaredField(&#34;request&#34;);
</span></span><span class="line"><span class="cl">            request1.setAccessible(true);
</span></span><span class="line"><span class="cl">            Object o = request1.get(request);
</span></span><span class="line"><span class="cl">            Field coyoteRequest = o.getClass().getDeclaredField(&#34;coyoteRequest&#34;);
</span></span><span class="line"><span class="cl">            coyoteRequest.setAccessible(true);
</span></span><span class="line"><span class="cl">            Object o1 = coyoteRequest.get(o);
</span></span><span class="line"><span class="cl">            // System.out.println(&#34;coyoteRequestå®ç°ç±»=&#34;+o1.getClass().getName());
</span></span><span class="line"><span class="cl">            Field headers = o1.getClass().getDeclaredField(&#34;headers&#34;);
</span></span><span class="line"><span class="cl">            headers.setAccessible(true);
</span></span><span class="line"><span class="cl">            MimeHeaders o2 = (MimeHeaders) headers.get(o1);
</span></span><span class="line"><span class="cl">            o2.addValue(key).setString(value);
</span></span><span class="line"><span class="cl">        } catch (Exception e) {
</span></span><span class="line"><span class="cl">            e.printStackTrace();
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    /**
</span></span><span class="line"><span class="cl">     * HmacSHA1 Base64åŠ å¯†
</span></span><span class="line"><span class="cl">     * @param key
</span></span><span class="line"><span class="cl">     * @param data
</span></span><span class="line"><span class="cl">     * @return
</span></span><span class="line"><span class="cl">     */
</span></span><span class="line"><span class="cl">    public static String genHMAC(String key, String data) {
</span></span><span class="line"><span class="cl">        byte[] result = null;
</span></span><span class="line"><span class="cl">        try {
</span></span><span class="line"><span class="cl">            //æ ¹æ®ç»™å®šçš„å­—èŠ‚æ•°ç»„æ„é€ ä¸€ä¸ªå¯†é’¥,ç¬¬äºŒå‚æ•°æŒ‡å®šä¸€ä¸ªå¯†é’¥ç®—æ³•çš„åç§°
</span></span><span class="line"><span class="cl">            SecretKeySpec signinKey = new SecretKeySpec(key.getBytes(), &#34;HmacSHA1&#34;);
</span></span><span class="line"><span class="cl">            //ç”Ÿæˆä¸€ä¸ªæŒ‡å®š Mac ç®—æ³• çš„ Mac å¯¹è±¡
</span></span><span class="line"><span class="cl">            Mac mac = Mac.getInstance(&#34;HmacSHA1&#34;);
</span></span><span class="line"><span class="cl">            //ç”¨ç»™å®šå¯†é’¥åˆå§‹åŒ– Mac å¯¹è±¡
</span></span><span class="line"><span class="cl">            mac.init(signinKey);
</span></span><span class="line"><span class="cl">            //å®Œæˆ Mac æ“ä½œ
</span></span><span class="line"><span class="cl">            byte[] rawHmac = mac.doFinal(data.getBytes(Charset.forName(&#34;UTF-8&#34;)));
</span></span><span class="line"><span class="cl">            result = Base64.encodeBase64(rawHmac);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        } catch (NoSuchAlgorithmException e) {
</span></span><span class="line"><span class="cl">            System.err.println(e.getMessage());
</span></span><span class="line"><span class="cl">        } catch (InvalidKeyException e) {
</span></span><span class="line"><span class="cl">            System.err.println(e.getMessage());
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        if (null != result) {
</span></span><span class="line"><span class="cl">            return new String(result);
</span></span><span class="line"><span class="cl">        } else {
</span></span><span class="line"><span class="cl">            return null;
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ€åè®¿é—®çš„åœ°å€ä¾‹å¦‚ï¼š
http://127.0.0.1:8081/api/es/static/bucket_name/object_name
å¯ä»¥åŠ ä¸ªæ‹¦æˆªå™¨åšä¸ªç™»é™†éªŒè¯ã€‚</p>]]></description></item></channel></rss>