<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title>所有文章 - PME-Blog</title><link>https://hpk.me/posts/</link><description>所有文章 | PME-Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><lastBuildDate>Tue, 12 Mar 2024 11:22:13 +0800</lastBuildDate><atom:link href="https://hpk.me/posts/" rel="self" type="application/rss+xml"/><item><title>kudu-spark KuduContext java.io.InvalidClassException 解决</title><link>https://hpk.me/posts/kudu-spark-invalid-class-exception/</link><pubDate>Tue, 18 Apr 2023 13:56:34 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/kudu-spark-invalid-class-exception/</guid><description><![CDATA[<p>背景：
线上kudu 集群版本为1.11.0版本, spark 使用 kudu-spark2_2.11-1.7.0.jar，
为了使用新版本中的
<code>val wo = new KuduWriteOptions(ignoreNull = true)</code>
特性，升级至 kudu-spark2_2.11-1.11.0.jar 版本，但是报错。</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">java</span><span class="p">.</span><span class="na">io</span><span class="p">.</span><span class="na">InvalidClassException</span><span class="p">:</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kudu</span><span class="p">.</span><span class="na">spark</span><span class="p">.</span><span class="na">kudu</span><span class="p">.</span><span class="na">KuduContext</span><span class="p">;</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="kd">class</span> <span class="nc">incompatible</span><span class="p">:</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="n">classdesc</span><span class="w"> </span><span class="n">serialVersionUID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xxxxxxxx</span><span class="p">,</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="kd">class</span> <span class="nc">serialVersionUID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xxxxxxx111</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在https://issues.apache.org/jira/browse/KUDU-2898 中说这个已经修复，但是修复的版本是kudu 1.12.0，升级线上kudu版本这个暂时不考虑，只好自己修改源码，重新编译 kudu-spark2_2.11-1.11.0.jar</p>
<ul>
<li>
<p>1.解压 kudu-spark2_2.11-1.11.0.jar ，将解压出的所有文件夹移动至一个空文件夹，例如tmp</p>
</li>
<li>
<p>2.在idea中新建maven项目，配置好 scala 等环境</p>
</li>
<li>
<p>3.解压 kudu-spark2_2.11-1.11.0-sources.jar，将 其中 org 文件夹 复制 至 maven中刚刚建好的项目中（org/apache/kudu/spark/kudu）</p>
</li>
<li>
<p>4.修改文件 KuduContext.scala 、 KuduRDD.scala， 增加或修改 @SerialVersionUID(xxxxxxxxxxL) ，xxxxxxxxxx改为报错信息中的local class serialVersionUID<br></p>
</li>
<li>
<p><img loading="lazy" src="https://im.gurl.eu.org/file/62c78529eb3073b0727e7.png" alt="请输入图片描述" srcset="https://im.gurl.eu.org/file/62c78529eb3073b0727e7.png?size=small, https://im.gurl.eu.org/file/62c78529eb3073b0727e7.png?size=medium 1.5x, https://im.gurl.eu.org/file/62c78529eb3073b0727e7.png?size=large 2x" data-title="请输入图片描述" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><br></p>
</li>
<li>
<p><img loading="lazy" src="https://im.gurl.eu.org/file/c5e7c401b84230d7a9bc3.png" alt="请输入图片描述" srcset="https://im.gurl.eu.org/file/c5e7c401b84230d7a9bc3.png?size=small, https://im.gurl.eu.org/file/c5e7c401b84230d7a9bc3.png?size=medium 1.5x, https://im.gurl.eu.org/file/c5e7c401b84230d7a9bc3.png?size=large 2x" data-title="请输入图片描述" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><br></p>
</li>
<li>
<p><img loading="lazy" src="https://im.gurl.eu.org/file/9513fccdb6c8b328ad76a.png" alt="请输入图片描述" srcset="https://im.gurl.eu.org/file/9513fccdb6c8b328ad76a.png?size=small, https://im.gurl.eu.org/file/9513fccdb6c8b328ad76a.png?size=medium 1.5x, https://im.gurl.eu.org/file/9513fccdb6c8b328ad76a.png?size=large 2x" data-title="请输入图片描述" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><br></p>
</li>
<li>
<p>5：OperationType.scala文件也需修改，和 上面的serialVersionUID不同，走完整个流程运行会报这个文件的serialVersionUID错误，改成错误信息中的local class serialVersionUID</p>
</li>
<li>
<p>6.将 kudu-spark2_2.11-1.11.0.pom 中的 dependencies 粘贴至 maven 中项目的pom文件中，还需额外增加以下依赖：</p>
</li>
</ul>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.apache.kudu<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>kudu-client<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>1.11.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.apache.yetus<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>audience-annotations<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>0.13.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.hdrhistogram<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>HdrHistogram<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>2.1.12<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>7.idea中将maven项目打包</p>
</li>
<li>
<p>8.将idea中打好的包解压，将其中 org/apache/kudu/spark/kudu  下的文件覆盖至 tmp 中 org/apache/kudu/spark/kudu</p>
</li>
<li>
<p>9.将 tmp 文件夹下的所有目录打包成新的jar包</p>
</li>
</ul>
<p>参考链接：</p>
<ol>
<li><a href="https://community.cloudera.com/t5/Support-Questions/KUDU-need-rebuild-post-upgrade-of-CDH-cluster/td-p/92885"target="_blank" rel="external nofollow noopener noreferrer">https://community.cloudera.com/t5/Support-Questions/KUDU-need-rebuild-post-upgrade-of-CDH-cluster/td-p/92885<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://issues.apache.org/jira/browse/KUDU-2898"target="_blank" rel="external nofollow noopener noreferrer">https://issues.apache.org/jira/browse/KUDU-2898<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ol>]]></description></item><item><title>Openwrt下使用TOTP动态验证码连接Openvpn</title><link>https://hpk.me/posts/openwrt-openvpn/</link><pubDate>Thu, 20 Jul 2023 12:24:22 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/openwrt-openvpn/</guid><description><![CDATA[<h1 id="背景" class="heading-element">
  <a href="#%e8%83%8c%e6%99%af" class="heading-mark"></a>背景</h1><p>在家办公需要使用 openvpn 连接公司内网，而且密码使用  固定密码 +TOTP 验证码 的形式，每次都需要打开电脑的openvpn客户端，打开验证码客户端复制验证码，连接，只能说繁琐。希望通过家里的软路由openwrt的openvpn客户端来实现上述操作的一键连接，实现家里每个终端设备都能连接公司内网。</p>
<h1 id="实操" class="heading-element">
  <a href="#%e5%ae%9e%e6%93%8d" class="heading-mark"></a>实操</h1><p>确保你的openwrt服务列表里已经安装openvpn，如没有请自行安装，在openwrt下新建 /root/openvpn 目录，一切操作均在这个目录下进行。</p>
<h2 id="1openwrt安装oathtool" class="heading-element">
  <a href="#1openwrt%e5%ae%89%e8%a3%85oathtool" class="heading-mark"></a>（1）openwrt安装oathtool</h2><p>下载连接： <a href="https://downloads.openwrt.org/releases/packages-21.02/x86_64/packages/oath-toolkit_2.6.5-1_x86_64.ipk"target="_blank" rel="external nofollow noopener noreferrer">https://downloads.openwrt.org/releases/packages-21.02/x86_64/packages/oath-toolkit_2.6.5-1_x86_64.ipk<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>下载上传至openwrt，安装 <code>opkg install  /tmp/upload/oath-toolkit_2.6.5-1_x86_64.ipk</code></p>
<p>验证： <code>oathtool -b --totp '你的密钥'</code>  和谷歌身份验证器里的验证码此时是否一致。</p>
<h2 id="2生成账户密码" class="heading-element">
  <a href="#2%e7%94%9f%e6%88%90%e8%b4%a6%e6%88%b7%e5%af%86%e7%a0%81" class="heading-mark"></a>（2）生成账户密码</h2><p>在/root/openvpn下新建<code>generate-password.sh</code> 脚本，内容如下，</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">yzm</span><span class="o">=</span><span class="k">$(</span>/usr/bin/oathtool -b --totp <span class="s1">&#39;你的密钥&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -e <span class="s2">&#34;公司openvpn账号\n公司openvpn固定密码</span><span class="si">${</span><span class="nv">yzm</span><span class="si">}</span><span class="s2">&#34;</span> &gt; /root/openvpn/userpass.txt</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3openvpn配置文件" class="heading-element">
  <a href="#3openvpn%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" class="heading-mark"></a>（3）openvpn配置文件</h2><p>上传<code>xxx.crt</code>、<code>xxx.key</code>、<code>xxx.ovpn</code>等文件到openwrt，并移动到/root/openvpn 目录下，修改ovpn文件。</p>
<p>auth-user-pass此项修改位为 <code>auth-user-pass userpass.txt</code>，从文件中读取用户名密码。</p>
<p>为了使指定的ip段使用openvpn，而其他的网络走路由默认线路，在ovpn文件下追加<code>route-nopull</code>及其下面的内容。</p>
<p>其中 10.87.1.0、10.88.1.0 修改为需要走openvpn的ip段，这样 10.87.1.1~10.87.1.254 、10.88.1.1~10.88.1.254 就会走openvpn，根据自己需要修改。</p>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">client
</span></span><span class="line"><span class="cl">dev tun
</span></span><span class="line"><span class="cl">link-mtu <span class="m">1500</span>
</span></span><span class="line"><span class="cl">proto tcp
</span></span><span class="line"><span class="cl">remote xxx.com <span class="m">8888</span>
</span></span><span class="line"><span class="cl">resolv-retry infinite
</span></span><span class="line"><span class="cl">nobind
</span></span><span class="line"><span class="cl">persist-key
</span></span><span class="line"><span class="cl">persist-tun
</span></span><span class="line"><span class="cl">ca /root/openvpn/xxx.crt
</span></span><span class="line"><span class="cl">remote-cert-tls server
</span></span><span class="line"><span class="cl">tls-auth /root/openvpn/xxx.key <span class="m">1</span>
</span></span><span class="line"><span class="cl">cipher AES-256-CBC
</span></span><span class="line"><span class="cl">auth-user-pass /root/openvpn/userpass.txt
</span></span><span class="line"><span class="cl">verb <span class="m">3</span>
</span></span><span class="line"><span class="cl">auth-nocache
</span></span><span class="line"><span class="cl">reneg-sec <span class="m">36000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">route-nopull
</span></span><span class="line"><span class="cl">pull-filter ignore <span class="s2">&#34;dhcp-option DNS&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">route 10.87.1.0 255.255.255.0 vpn_gateway
</span></span><span class="line"><span class="cl">route 10.88.1.0 255.255.255.0 vpn_gateway</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4openwrt配置修改" class="heading-element">
  <a href="#4openwrt%e9%85%8d%e7%bd%ae%e4%bf%ae%e6%94%b9" class="heading-mark"></a>（4）openwrt配置修改</h2><ol>
<li>
<p>修改 /etc/config/openvpn ，在其下追加自己的openvpn配置，如下所示，名字根据需要修改。</p>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">config openvpn &#39;公司vpn&#39;
</span></span><span class="line"><span class="cl">        option config &#39;/root/openvpn/xxx.ovpn&#39;
</span></span><span class="line"><span class="cl">        option auth_nocache &#39;1&#39;</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>为了在启动时先生成密码文件userpass.txt，修改 /etc/init.d/openvpn 脚本，在 <code>openvpn_add_instance()</code> 函数下第一行加上</p>
<p><code>sh /root/openvpn/generate-password.sh</code>，如下所示。</p>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">openvpn_add_instance<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        sh /root/openvpn/generate-password.sh
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">dir</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">conf</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$3</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">security</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$4</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">up</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$5</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">down</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$6</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">		...
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>此时openwrt网页openvpn下就有了刚刚加的配置了，勾选启用，点击保存应用。</p>
</li>
</ol>
<p><img loading="lazy" src="https://im.gurl.eu.org/file/0f4dea7f988b1a619fab3.png" alt="image-20230720120756596" srcset="https://im.gurl.eu.org/file/0f4dea7f988b1a619fab3.png?size=small, https://im.gurl.eu.org/file/0f4dea7f988b1a619fab3.png?size=medium 1.5x, https://im.gurl.eu.org/file/0f4dea7f988b1a619fab3.png?size=large 2x" data-title="image-20230720120756596" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="5修改openwrt防火墙" class="heading-element">
  <a href="#5%e4%bf%ae%e6%94%b9openwrt%e9%98%b2%e7%81%ab%e5%a2%99" class="heading-mark"></a>（5）修改openwrt防火墙</h2><p>上面的操作完成后，你会发现在openwrt里能ping通需要通过openvpn连接的ip段，但是连接路由的设备并不能连通，需要修改防火墙，在防火墙自定义规则里添加如下内容，其中<code>192.168.8.0/24</code>修改为你的路由网段，<code>10.87.1.0/24,10.88.1.0/24</code>修改为你需要通过openvpn连接的公司ip网段<code>10.87.1.*,10.88.1.*</code>,如果想要达到连接 <code>10.87.*.*</code>的效果，可以改成 <code>10.87.0.0/16</code> ，这方面的网络知识，请自行查阅相关资料。</p>
<p>注：我使用了openwrt的mosdns功能，公司的内网域名放到了mosdns自定义hosts里了。没使用这个功能可以通过网络-DHCP/DNS里额外的HOSTS文件来实现自定义域名。</p>
<div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">iptables -I FORWARD -o tun0 -j ACCEPT
</span></span><span class="line"><span class="cl">iptables -t nat -I POSTROUTING -s 192.168.8.0/24 -d 10.87.1.0/24,10.88.1.0/24 -o tun0 -j MASQUERADE</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="参考" class="heading-element">
  <a href="#%e5%8f%82%e8%80%83" class="heading-mark"></a>参考</h1><p><a href="http://www.phperz.com/article/15/1226/177358.html"target="_blank" rel="external nofollow noopener noreferrer">openwrt下的openvpn client实现 - PHPERZ中文资讯站<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p><a href="https://m.zohead.com/archives/openwrt-openvpn-ipset/?wpmp_switcher=true"target="_blank" rel="external nofollow noopener noreferrer">Soul Of Free Loop » 博客存档 » OpenWRT实现OpenVPN按ipset自动分流 (zohead.com)<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>]]></description></item><item><title>一些免费的大模型资源</title><link>https://hpk.me/posts/about_chatgpt/</link><pubDate>Tue, 12 Mar 2024 11:22:13 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/about_chatgpt/</guid><description><![CDATA[<p>一些免费的大模型资源，可生成兼容Openai api 接口的资源。</p>
<h2 id="谷歌gemini" class="heading-element">
  <a href="#%e8%b0%b7%e6%ad%8cgemini" class="heading-mark"></a>谷歌Gemini</h2><p>申请地址：https://makersuite.google.com/app/apikey</p>
<h2 id="字节coze海外版" class="heading-element">
  <a href="#%e5%ad%97%e8%8a%82coze%e6%b5%b7%e5%a4%96%e7%89%88" class="heading-mark"></a>字节Coze海外版</h2><p>官网：https://www.coze.com/</p>
<p>搭配：https://github.com/deanxv/coze-discord-proxy</p>
<p>​	代理<code>Discord</code>对话<code>Coze-Bot</code>，实现以API形式请求GPT4模型，提供对话、文生图、图生文、知识库检索等功能。</p>
<h2 id="groq" class="heading-element">
  <a href="#groq" class="heading-mark"></a>Groq</h2><p>官网：https://console.groq.com/keys</p>
<h2 id="api集成" class="heading-element">
  <a href="#api%e9%9b%86%e6%88%90" class="heading-mark"></a>Api集成</h2><p><a href="https://github.com/songquanpeng/one-api"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/songquanpeng/one-api<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>​	OpenAI 接口管理 &amp; 分发系统，支持 Azure、Anthropic Claude、Google PaLM 2 &amp; Gemini、智谱 ChatGLM、百度文心一言、讯飞星火认知、阿里通义千问、360 智脑以及腾讯混元，可用于二次分发管理 key，仅单可执行文件，已打包好 Docker 镜像，一键部署，开箱即用。</p>
<h2 id="web页面集成" class="heading-element">
  <a href="#web%e9%a1%b5%e9%9d%a2%e9%9b%86%e6%88%90" class="heading-mark"></a>Web页面集成</h2><p><a href="https://github.com/lobehub/lobe-chat"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/lobehub/lobe-chat<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>​	开源、现代化设计的 ChatGPT/LLMs 聊天应用与开发框架，支持语音合成、多模态、可扩展的（function call）插件系统，一键免费拥有你自己的 ChatGPT/Gemini/Ollama 应用。</p>]]></description></item><item><title>一些免费的大模型资源</title><link>https://hpk.me/posts/about_chatgpt/</link><pubDate>Tue, 12 Mar 2024 11:22:13 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/about_chatgpt/</guid><description><![CDATA[<p>一些免费的大模型资源，可生成兼容Openai api 接口的资源。</p>
<h2 id="谷歌gemini" class="heading-element">
  <a href="#%e8%b0%b7%e6%ad%8cgemini" class="heading-mark"></a>谷歌Gemini</h2><p>申请地址：https://makersuite.google.com/app/apikey</p>
<h2 id="字节coze海外版" class="heading-element">
  <a href="#%e5%ad%97%e8%8a%82coze%e6%b5%b7%e5%a4%96%e7%89%88" class="heading-mark"></a>字节Coze海外版</h2><p>官网：https://www.coze.com/</p>
<p>搭配：https://github.com/deanxv/coze-discord-proxy</p>
<p>​	代理<code>Discord</code>对话<code>Coze-Bot</code>，实现以API形式请求GPT4模型，提供对话、文生图、图生文、知识库检索等功能。</p>
<h2 id="groq" class="heading-element">
  <a href="#groq" class="heading-mark"></a>Groq</h2><p>官网：https://console.groq.com/keys</p>
<h2 id="api集成" class="heading-element">
  <a href="#api%e9%9b%86%e6%88%90" class="heading-mark"></a>Api集成</h2><p><a href="https://github.com/songquanpeng/one-api"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/songquanpeng/one-api<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>​	OpenAI 接口管理 &amp; 分发系统，支持 Azure、Anthropic Claude、Google PaLM 2 &amp; Gemini、智谱 ChatGLM、百度文心一言、讯飞星火认知、阿里通义千问、360 智脑以及腾讯混元，可用于二次分发管理 key，仅单可执行文件，已打包好 Docker 镜像，一键部署，开箱即用。</p>
<h2 id="web页面集成" class="heading-element">
  <a href="#web%e9%a1%b5%e9%9d%a2%e9%9b%86%e6%88%90" class="heading-mark"></a>Web页面集成</h2><p><a href="https://github.com/lobehub/lobe-chat"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/lobehub/lobe-chat<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>​	开源、现代化设计的 ChatGPT/LLMs 聊天应用与开发框架，支持语音合成、多模态、可扩展的（function call）插件系统，一键免费拥有你自己的 ChatGPT/Gemini/Ollama 应用。</p>]]></description></item><item><title>Openwrt下使用TOTP动态验证码连接Openvpn</title><link>https://hpk.me/posts/openwrt-openvpn/</link><pubDate>Thu, 20 Jul 2023 12:24:22 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/openwrt-openvpn/</guid><description><![CDATA[<h1 id="背景" class="heading-element">
  <a href="#%e8%83%8c%e6%99%af" class="heading-mark"></a>背景</h1><p>在家办公需要使用 openvpn 连接公司内网，而且密码使用  固定密码 +TOTP 验证码 的形式，每次都需要打开电脑的openvpn客户端，打开验证码客户端复制验证码，连接，只能说繁琐。希望通过家里的软路由openwrt的openvpn客户端来实现上述操作的一键连接，实现家里每个终端设备都能连接公司内网。</p>
<h1 id="实操" class="heading-element">
  <a href="#%e5%ae%9e%e6%93%8d" class="heading-mark"></a>实操</h1><p>确保你的openwrt服务列表里已经安装openvpn，如没有请自行安装，在openwrt下新建 /root/openvpn 目录，一切操作均在这个目录下进行。</p>
<h2 id="1openwrt安装oathtool" class="heading-element">
  <a href="#1openwrt%e5%ae%89%e8%a3%85oathtool" class="heading-mark"></a>（1）openwrt安装oathtool</h2><p>下载连接： <a href="https://downloads.openwrt.org/releases/packages-21.02/x86_64/packages/oath-toolkit_2.6.5-1_x86_64.ipk"target="_blank" rel="external nofollow noopener noreferrer">https://downloads.openwrt.org/releases/packages-21.02/x86_64/packages/oath-toolkit_2.6.5-1_x86_64.ipk<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>下载上传至openwrt，安装 <code>opkg install  /tmp/upload/oath-toolkit_2.6.5-1_x86_64.ipk</code></p>
<p>验证： <code>oathtool -b --totp '你的密钥'</code>  和谷歌身份验证器里的验证码此时是否一致。</p>
<h2 id="2生成账户密码" class="heading-element">
  <a href="#2%e7%94%9f%e6%88%90%e8%b4%a6%e6%88%b7%e5%af%86%e7%a0%81" class="heading-mark"></a>（2）生成账户密码</h2><p>在/root/openvpn下新建<code>generate-password.sh</code> 脚本，内容如下，</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">yzm</span><span class="o">=</span><span class="k">$(</span>/usr/bin/oathtool -b --totp <span class="s1">&#39;你的密钥&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -e <span class="s2">&#34;公司openvpn账号\n公司openvpn固定密码</span><span class="si">${</span><span class="nv">yzm</span><span class="si">}</span><span class="s2">&#34;</span> &gt; /root/openvpn/userpass.txt</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3openvpn配置文件" class="heading-element">
  <a href="#3openvpn%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" class="heading-mark"></a>（3）openvpn配置文件</h2><p>上传<code>xxx.crt</code>、<code>xxx.key</code>、<code>xxx.ovpn</code>等文件到openwrt，并移动到/root/openvpn 目录下，修改ovpn文件。</p>
<p>auth-user-pass此项修改位为 <code>auth-user-pass userpass.txt</code>，从文件中读取用户名密码。</p>
<p>为了使指定的ip段使用openvpn，而其他的网络走路由默认线路，在ovpn文件下追加<code>route-nopull</code>及其下面的内容。</p>
<p>其中 10.87.1.0、10.88.1.0 修改为需要走openvpn的ip段，这样 10.87.1.1~10.87.1.254 、10.88.1.1~10.88.1.254 就会走openvpn，根据自己需要修改。</p>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">client
</span></span><span class="line"><span class="cl">dev tun
</span></span><span class="line"><span class="cl">link-mtu <span class="m">1500</span>
</span></span><span class="line"><span class="cl">proto tcp
</span></span><span class="line"><span class="cl">remote xxx.com <span class="m">8888</span>
</span></span><span class="line"><span class="cl">resolv-retry infinite
</span></span><span class="line"><span class="cl">nobind
</span></span><span class="line"><span class="cl">persist-key
</span></span><span class="line"><span class="cl">persist-tun
</span></span><span class="line"><span class="cl">ca /root/openvpn/xxx.crt
</span></span><span class="line"><span class="cl">remote-cert-tls server
</span></span><span class="line"><span class="cl">tls-auth /root/openvpn/xxx.key <span class="m">1</span>
</span></span><span class="line"><span class="cl">cipher AES-256-CBC
</span></span><span class="line"><span class="cl">auth-user-pass /root/openvpn/userpass.txt
</span></span><span class="line"><span class="cl">verb <span class="m">3</span>
</span></span><span class="line"><span class="cl">auth-nocache
</span></span><span class="line"><span class="cl">reneg-sec <span class="m">36000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">route-nopull
</span></span><span class="line"><span class="cl">pull-filter ignore <span class="s2">&#34;dhcp-option DNS&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">route 10.87.1.0 255.255.255.0 vpn_gateway
</span></span><span class="line"><span class="cl">route 10.88.1.0 255.255.255.0 vpn_gateway</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4openwrt配置修改" class="heading-element">
  <a href="#4openwrt%e9%85%8d%e7%bd%ae%e4%bf%ae%e6%94%b9" class="heading-mark"></a>（4）openwrt配置修改</h2><ol>
<li>
<p>修改 /etc/config/openvpn ，在其下追加自己的openvpn配置，如下所示，名字根据需要修改。</p>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">config openvpn &#39;公司vpn&#39;
</span></span><span class="line"><span class="cl">        option config &#39;/root/openvpn/xxx.ovpn&#39;
</span></span><span class="line"><span class="cl">        option auth_nocache &#39;1&#39;</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>为了在启动时先生成密码文件userpass.txt，修改 /etc/init.d/openvpn 脚本，在 <code>openvpn_add_instance()</code> 函数下第一行加上</p>
<p><code>sh /root/openvpn/generate-password.sh</code>，如下所示。</p>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">openvpn_add_instance<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        sh /root/openvpn/generate-password.sh
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">dir</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">conf</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$3</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">security</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$4</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">up</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$5</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">down</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$6</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">		...
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>此时openwrt网页openvpn下就有了刚刚加的配置了，勾选启用，点击保存应用。</p>
</li>
</ol>
<p><img loading="lazy" src="https://im.gurl.eu.org/file/0f4dea7f988b1a619fab3.png" alt="image-20230720120756596" srcset="https://im.gurl.eu.org/file/0f4dea7f988b1a619fab3.png?size=small, https://im.gurl.eu.org/file/0f4dea7f988b1a619fab3.png?size=medium 1.5x, https://im.gurl.eu.org/file/0f4dea7f988b1a619fab3.png?size=large 2x" data-title="image-20230720120756596" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="5修改openwrt防火墙" class="heading-element">
  <a href="#5%e4%bf%ae%e6%94%b9openwrt%e9%98%b2%e7%81%ab%e5%a2%99" class="heading-mark"></a>（5）修改openwrt防火墙</h2><p>上面的操作完成后，你会发现在openwrt里能ping通需要通过openvpn连接的ip段，但是连接路由的设备并不能连通，需要修改防火墙，在防火墙自定义规则里添加如下内容，其中<code>192.168.8.0/24</code>修改为你的路由网段，<code>10.87.1.0/24,10.88.1.0/24</code>修改为你需要通过openvpn连接的公司ip网段<code>10.87.1.*,10.88.1.*</code>,如果想要达到连接 <code>10.87.*.*</code>的效果，可以改成 <code>10.87.0.0/16</code> ，这方面的网络知识，请自行查阅相关资料。</p>
<p>注：我使用了openwrt的mosdns功能，公司的内网域名放到了mosdns自定义hosts里了。没使用这个功能可以通过网络-DHCP/DNS里额外的HOSTS文件来实现自定义域名。</p>
<div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">iptables -I FORWARD -o tun0 -j ACCEPT
</span></span><span class="line"><span class="cl">iptables -t nat -I POSTROUTING -s 192.168.8.0/24 -d 10.87.1.0/24,10.88.1.0/24 -o tun0 -j MASQUERADE</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="参考" class="heading-element">
  <a href="#%e5%8f%82%e8%80%83" class="heading-mark"></a>参考</h1><p><a href="http://www.phperz.com/article/15/1226/177358.html"target="_blank" rel="external nofollow noopener noreferrer">openwrt下的openvpn client实现 - PHPERZ中文资讯站<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p><a href="https://m.zohead.com/archives/openwrt-openvpn-ipset/?wpmp_switcher=true"target="_blank" rel="external nofollow noopener noreferrer">Soul Of Free Loop » 博客存档 » OpenWRT实现OpenVPN按ipset自动分流 (zohead.com)<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>]]></description></item><item><title>m3u8格式直播地址文件使用php在线转换成txt格式</title><link>https://hpk.me/posts/m3u8-convert-to-txt/</link><pubDate>Mon, 29 May 2023 11:19:42 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/m3u8-convert-to-txt/</guid><description><![CDATA[<p>一些m3u或者m3u8格式的直播地址文件在一些软件中并不支持，在chatgpt的帮助下，使用php实现了在线转换成txt格式，需要能运行php的服务器。</p>
<p>代码如下，命名为 <code>m3u-txt.php</code> ，将其放在能运行php的服务器上，访问  <a href="http://xxxxxx.com/m3u-txt.php?url=https://raw.githubusercontent.com/fanmingming/live/main/tv/m3u/ipv6.m3u"target="_blank" rel="external nofollow noopener noreferrer">http://xxxxxx.com/m3u-txt.php?url=https://raw.githubusercontent.com/fanmingming/live/main/tv/m3u/ipv6.m3u<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> 可直接转换。</p>
<p>需要注意的是可能一些m3u文件格式不完全一样导致转换不成功，请参考<code>preg_match_all('/#EXTINF:-1.*?group-title=&quot;(.*?)&quot;.*?,(.*?)\n(.*?)\n/s', $file, $matches, PREG_SET_ORDER)</code>修改。</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nv">$file</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 用正则表达式提取group_title和m3u8链接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">preg_match_all</span><span class="p">(</span><span class="s1">&#39;/#EXTINF:-1.*?group-title=&#34;(.*?)&#34;.*?,(.*?)\n(.*?)\n/s&#39;</span><span class="p">,</span> <span class="nv">$file</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">,</span> <span class="nx">PREG_SET_ORDER</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$result</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$matches</span> <span class="k">as</span> <span class="nv">$match</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$group_title</span> <span class="o">=</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$channel_name</span> <span class="o">=</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$result</span><span class="p">[</span><span class="nv">$group_title</span><span class="p">][]</span> <span class="o">=</span> <span class="nv">$channel_name</span> <span class="o">.</span> <span class="s1">&#39;,&#39;</span> <span class="o">.</span> <span class="nv">$url</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$line_f</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 输出处理后的结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">&#34;HTTP_USER_AGENT&#34;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">strpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">&#34;HTTP_USER_AGENT&#34;</span><span class="p">],</span> <span class="s2">&#34;Mozilla&#34;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果是浏览器访问，将 &#34;\n&#34; 替换为 &#34;&lt;br&gt;&#34; 输出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$line_f</span> <span class="o">=</span> <span class="s2">&#34;&lt;br&gt;&#34;</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 输出结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">foreach</span> <span class="p">(</span><span class="nv">$result</span> <span class="k">as</span> <span class="nv">$group_title</span> <span class="o">=&gt;</span> <span class="nv">$channels</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="nv">$group_title</span> <span class="o">.</span> <span class="s1">&#39;,#genre#&#39;</span> <span class="o">.</span> <span class="nv">$line_f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$channels</span> <span class="k">as</span> <span class="nv">$channel</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="nv">$channel</span> <span class="o">.</span> <span class="nv">$line_f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="nv">$line_f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下。</p>
<p><a href="https://raw.githubusercontent.com/fanmingming/live/main/tv/m3u/ipv6.m3u"target="_blank" rel="external nofollow noopener noreferrer">https://raw.githubusercontent.com/fanmingming/live/main/tv/m3u/ipv6.m3u<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>  原格式：</p>
<p><img loading="lazy" src="https://i2.wp.com/telegra.ph/file/c9f85fc0ce5ae50deee7e.png" alt="image-20230529113558662" srcset="https://i2.wp.com/telegra.ph/file/c9f85fc0ce5ae50deee7e.png?size=small, https://i2.wp.com/telegra.ph/file/c9f85fc0ce5ae50deee7e.png?size=medium 1.5x, https://i2.wp.com/telegra.ph/file/c9f85fc0ce5ae50deee7e.png?size=large 2x" data-title="image-20230529113558662" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>转换后格式：</p>
<p><img loading="lazy" src="https://i2.wp.com/telegra.ph/file/f1143dd072298c19c2191.png" alt="image-20230529113721128" srcset="https://i2.wp.com/telegra.ph/file/f1143dd072298c19c2191.png?size=small, https://i2.wp.com/telegra.ph/file/f1143dd072298c19c2191.png?size=medium 1.5x, https://i2.wp.com/telegra.ph/file/f1143dd072298c19c2191.png?size=large 2x" data-title="image-20230529113721128" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>]]></description></item><item><title>Cloudflare优选ip并使用dnspodcn api设置解析</title><link>https://hpk.me/posts/cloudflare-betterip-dnspodcn/</link><pubDate>Mon, 29 May 2023 10:45:18 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/cloudflare-betterip-dnspodcn/</guid><description><![CDATA[<p>Cloudflare优选ip并使用dnspodcn api设置解析，实现在本地网络环境下nas或者其他服务器上优选IP，并自动解析到自己的dnspodcn域名，实现速度最优。</p>
<h2 id="优选ip" class="heading-element">
  <a href="#%e4%bc%98%e9%80%89ip" class="heading-mark"></a>优选ip</h2><p>请参考github项目 <a href="https://github.com/XIU2/CloudflareSpeedTest"target="_blank" rel="external nofollow noopener noreferrer">XIU2/CloudflareSpeedTest: 🌩「自选优选 IP」测试 Cloudflare CDN 延迟和速度，获取最快 IP (IPv4 / IPv6)！另外也支持其他 CDN / 网站 IP ~ (github.com)<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>我的本地服务器为centos8系统，下载并解压到 /opt/cloudflareST 目录。</p>
<h2 id="dnspodcn-api-设置解析" class="heading-element">
  <a href="#dnspodcn-api-%e8%ae%be%e7%bd%ae%e8%a7%a3%e6%9e%90" class="heading-mark"></a>dnspodcn api 设置解析</h2><p>参考<a href="https://github.com/rehiy/dnspod-shell"target="_blank" rel="external nofollow noopener noreferrer">rehiy/dnspod-shell: 基于DNSPod用户API实现的纯Shell动态域名客户端 (github.com)<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> ，加入线路逻辑修改而来。</p>
<p>进入 /opt/cloudflareST 目录，新建以下脚本。需要修改：</p>
<ul>
<li>修改arToken=&ldquo;12345,xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&rdquo; 为你自己的dnspodcn的token</li>
<li>修改arDdnsCheck &ldquo;xx.yy&rdquo; &ldquo;sub1&rdquo;  为你自己的域名。</li>
<li><code>hostIp=$(awk -F ',' 'NR==2 {print $1}' /opt/cloudflareST/result.csv)</code> 注意此处优选ip结果文件位置，结合你的运行目录修改。</li>
</ul>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">#</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">###################################################################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># AnripDdns v6.4.0</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Dynamic DNS using DNSPod API</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Author: Rehiy, https://github.com/rehiy</span>
</span></span><span class="line"><span class="cl"><span class="c1">#                https://www.rehiy.com/?s=dnspod</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Collaborators: https://github.com/rehiy/dnspod-shell/graphs/contributors</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Usage: please refer to `ddnspod.sh`</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### params ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> arToken
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The url to be used for querying public ip address.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">arIp4QueryUrl</span><span class="o">=</span><span class="s2">&#34;http://ipv4.rehi.org/ip&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">arIp6QueryUrl</span><span class="o">=</span><span class="s2">&#34;http://ipv6.rehi.org/ip&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The temp file to store the last record ip</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The error code to return when a ddns record is not changed</span>
</span></span><span class="line"><span class="cl"><span class="c1"># By default, report unchanged event as success</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">arErrCodeUnchanged</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### logger ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Output log to stderr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arLog<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &gt;<span class="p">&amp;</span><span class="m">2</span> <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### http client ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Use curl or wget open url</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Args: url postdata</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arRequest<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">url</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">data</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">agent</span><span class="o">=</span><span class="s2">&#34;AnripDdns/6.4.0(wang@rehiy.com)&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span> curl &gt;/dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">echo</span> <span class="nv">$url</span> <span class="p">|</span> grep -q https<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$params</span><span class="s2"> -k&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$data</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$params</span><span class="s2"> -d </span><span class="nv">$data</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        curl -s -A <span class="s2">&#34;</span><span class="nv">$agent</span><span class="s2">&#34;</span> <span class="nv">$params</span> <span class="nv">$url</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$?</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span> wget &gt;/dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">echo</span> <span class="nv">$url</span> <span class="p">|</span> grep -q https<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$params</span><span class="s2"> --no-check-certificate&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$data</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$params</span><span class="s2"> --post-data </span><span class="nv">$data</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        wget -qO- -U <span class="s2">&#34;</span><span class="nv">$agent</span><span class="s2">&#34;</span> <span class="nv">$params</span> <span class="nv">$url</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$?</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get IPv4 by ip route or network</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arWanIp4<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> hostIp
</span></span><span class="line"><span class="cl">    <span class="nv">hostIp</span><span class="o">=</span><span class="k">$(</span>awk -F <span class="s1">&#39;,&#39;</span> <span class="s1">&#39;NR==2 {print $1}&#39;</span> /opt/cloudflareST/result.csv<span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="nv">$hostIp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### dnspod api ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Dnspod Bridge</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Args: interface data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arDdnsApi<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">dnsapi</span><span class="o">=</span><span class="s2">&#34;https://dnsapi.cn/</span><span class="si">${</span><span class="nv">1</span><span class="p">:?</span><span class="s1">&#39;Info.Version&#39;</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">params</span><span class="o">=</span><span class="s2">&#34;login_token=</span><span class="nv">$arToken</span><span class="s2">&amp;format=json&amp;lang=en&amp;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    arRequest <span class="s2">&#34;</span><span class="nv">$dnsapi</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$params</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Fetch Record Id</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Args: domain subdomain recordType</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arDdnsLookup<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> errMsg
</span></span><span class="line"><span class="cl">    <span class="c1"># Get Record Id</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordId</span><span class="o">=</span><span class="k">$(</span>arDdnsApi <span class="s2">&#34;Record.List&#34;</span> <span class="s2">&#34;domain=</span><span class="nv">$1</span><span class="s2">&amp;sub_domain=</span><span class="nv">$2</span><span class="s2">&amp;record_type=</span><span class="nv">$3</span><span class="s2">&amp;record_line=</span><span class="nv">$4</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordId</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordId</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*&#34;id&#34;:&#34;\([0-9]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> ! <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$recordId</span><span class="s2">&#34;</span> -gt <span class="m">0</span> <span class="o">]</span> 2&gt;/dev/null <span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">errMsg</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordId</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*&#34;message&#34;:&#34;\([^\&#34;]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; arDdnsLookup - </span><span class="nv">$errMsg</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="nv">$recordId</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Update Record Value</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Args: domain subdomain recordId recordType [hostIp]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arDdnsUpdate<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> errMsg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> recordRs
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> recordCd
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> recordIp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> lastRecordIp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">yys_line</span><span class="o">=</span><span class="nv">$6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">arLastRecordFile</span><span class="o">=</span>/run/ardnspod_last_record_<span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>.<span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>.<span class="s2">&#34;</span><span class="nv">$yys_line</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$arLastRecordFile</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">lastRecordIp</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$arLastRecordFile</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># fetch the last record ip from api</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$lastRecordIp</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">recordRs</span><span class="o">=</span><span class="k">$(</span>arDdnsApi <span class="s2">&#34;Record.Info&#34;</span> <span class="s2">&#34;domain=</span><span class="nv">$1</span><span class="s2">&amp;record_id=</span><span class="nv">$3</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">recordCd</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordRs</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*{&#34;code&#34;:&#34;\([0-9]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">lastRecordIp</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordRs</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*,&#34;value&#34;:&#34;\([0-9a-fA-F\.\:]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$5</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="nv">$lastRecordIp</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; arDdnsUpdate - unchanged: </span><span class="nv">$recordIp</span><span class="s2">&#34;</span> <span class="c1"># unchanged event</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$arErrCodeUnchanged</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordRs</span><span class="o">=</span><span class="k">$(</span>arDdnsApi <span class="s2">&#34;Record.Ddns&#34;</span> <span class="s2">&#34;domain=</span><span class="nv">$1</span><span class="s2">&amp;sub_domain=</span><span class="nv">$2</span><span class="s2">&amp;record_id=</span><span class="nv">$3</span><span class="s2">&amp;record_type=</span><span class="nv">$4</span><span class="s2">&amp;value=</span><span class="nv">$5</span><span class="s2">&amp;record_line=</span><span class="nv">$yys_line</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># parse result</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordCd</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordRs</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*{&#34;code&#34;:&#34;\([0-9]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordIp</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordRs</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*,&#34;value&#34;:&#34;\([0-9a-fA-F\.\:]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$recordCd</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;1&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">errMsg</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$recordRs</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*,&#34;message&#34;:&#34;\([^&#34;]*\)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; arDdnsUpdate - error: </span><span class="nv">$errMsg</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$recordIp</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="nv">$lastRecordIp</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; arDdnsUpdate - unchanged: </span><span class="nv">$recordIp</span><span class="s2">&#34;</span> <span class="c1"># unchanged event</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="nv">$recordIp</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$arErrCodeUnchanged</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; arDdnsUpdate - updated: </span><span class="nv">$recordIp</span><span class="s2">&#34;</span> <span class="c1"># updated event</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="nv">$recordIp</span> &gt; <span class="nv">$arLastRecordFile</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="nv">$recordIp</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### task hub ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># DDNS Check</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Args: domain subdomain [6|4] interface</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">arDdnsCheck<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> errCode
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> hostIp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> recordType
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    arLog <span class="s2">&#34;=== Check </span><span class="nv">$2</span><span class="s2">.</span><span class="nv">$1</span><span class="s2"> </span><span class="k">$(</span><span class="nb">printf</span> <span class="k">$(</span><span class="nb">echo</span> -n <span class="s2">&#34;</span><span class="nv">$3</span><span class="s2">&#34;</span> <span class="p">|</span> sed <span class="s1">&#39;s/\\/\\\\/g;s/\(%\)\([0-9a-fA-F][0-9a-fA-F]\)/\\x\2/g&#39;</span><span class="k">))</span><span class="s2"> line===&#34;</span>
</span></span><span class="line"><span class="cl">    arLog <span class="s2">&#34;Fetching Host Ip&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">recordType</span><span class="o">=</span>A
</span></span><span class="line"><span class="cl">    <span class="nv">hostIp</span><span class="o">=</span><span class="k">$(</span>arWanIp4<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">errCode</span><span class="o">=</span><span class="nv">$?</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$errCode</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; Host Ip: </span><span class="nv">$hostIp</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; Record Type: </span><span class="nv">$recordType</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="o">[</span> <span class="nv">$errCode</span> -eq <span class="m">2</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; Host Ip: Auto&#34;</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; Record Type: </span><span class="nv">$recordType</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;</span><span class="nv">$hostIp</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$errCode</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    arLog <span class="s2">&#34;Fetching RecordId&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">recordId</span><span class="o">=</span><span class="k">$(</span>arDdnsLookup <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$recordType</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$3</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">errCode</span><span class="o">=</span><span class="nv">$?</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$errCode</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;&gt; Record Id: </span><span class="nv">$recordId</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        arLog <span class="s2">&#34;</span><span class="nv">$recordId</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$errCode</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    arLog <span class="s2">&#34;Updating Record value&#34;</span>
</span></span><span class="line"><span class="cl">    arDdnsUpdate <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$recordId</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$recordType</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$hostIp</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$3</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################################################### end ##</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /opt/cloudflareST
</span></span><span class="line"><span class="cl"><span class="c1"># https://github.com/XIU2/CloudflareSpeedTest</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 即需要找到 10 个平均延迟低于 300 ms 且下载速度高于 15MB/s 的 IP 才会停止测速</span>
</span></span><span class="line"><span class="cl">/opt/cloudflareST/CloudflareST -tl <span class="m">300</span> -sl <span class="m">15</span> -dn <span class="m">10</span> -url https://cf.xiu2.xyz/url -o /opt/cloudflareST/result.csv     
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Combine your token ID and token together as follows</span>
</span></span><span class="line"><span class="cl"><span class="nv">arToken</span><span class="o">=</span><span class="s2">&#34;12345,xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Web endpoint to be used for querying the public IPv6 address</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Set this to override the default url provided by ardnspod</span>
</span></span><span class="line"><span class="cl"><span class="c1"># arIp4QueryUrl=&#34;http://ipv4.rehi.org/ip&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># arIp6QueryUrl=&#34;http://ipv6.rehi.org/ip&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Return code when the last record IP is same as current host IP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Set this to a value other than 0 to distinguish with a successful ddns update</span>
</span></span><span class="line"><span class="cl"><span class="c1"># arErrCodeUnchanged=0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Place each domain you want to check as follows</span>
</span></span><span class="line"><span class="cl"><span class="c1"># you can have multiple arDdnsCheck blocks</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 联通 %E8%81%94%E9%80%9A</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 移动 %E7%A7%BB%E5%8A%A8</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 电信 %E7%94%B5%E4%BF%A1</span>
</span></span><span class="line"><span class="cl"><span class="nv">yys_lines</span><span class="o">=(</span><span class="s2">&#34;%E8%81%94%E9%80%9A&#34;</span> <span class="s2">&#34;%E7%A7%BB%E5%8A%A8&#34;</span> <span class="s2">&#34;%E7%94%B5%E4%BF%A1&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 使用循环遍历数组</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> yys_line in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">yys_lines</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">    arDdnsCheck <span class="s2">&#34;xx.yy&#34;</span> <span class="s2">&#34;sub1&#34;</span> <span class="s2">&#34;</span><span class="nv">$yys_line</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="定时运行" class="heading-element">
  <a href="#%e5%ae%9a%e6%97%b6%e8%bf%90%e8%a1%8c" class="heading-mark"></a>定时运行</h2><p>我使用crontab，8小时运行一次，请根据需要自行修改。</p>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="m">0</span> */8 * * * /opt/cloudflareST/dnspodcn.sh &gt;&gt; /opt/cloudflareST/log.txt</span></span></code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>spark 实现 mysql upsert</title><link>https://hpk.me/posts/spark-mysql-upsert/</link><pubDate>Tue, 18 Apr 2023 14:23:06 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/spark-mysql-upsert/</guid><description><![CDATA[<p><strong>实现 spark dataframe/dataset 根据mysql表唯一键实现有则更新，无则插入功能。</strong></p>
<p>基于 <strong>spark2.4.3 scala2.11.8</strong></p>
<h2 id="工具类-dataframewriterenhance" class="heading-element">
  <a href="#%e5%b7%a5%e5%85%b7%e7%b1%bb-dataframewriterenhance" class="heading-mark"></a>工具类 DataFrameWriterEnhance</h2><div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.xxx.utils</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.catalyst.plans.logical.LogicalPlan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.execution.SQLExecution</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.execution.datasources.DataSource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.execution.datasources.jdbc.</span><span class="p">{</span><span class="n">JDBCOptions</span><span class="p">,</span><span class="w"> </span><span class="n">JdbcOptionsInWrite</span><span class="p">,</span><span class="w"> </span><span class="n">JdbcRelationProvider</span><span class="p">,</span><span class="w"> </span><span class="n">JdbcUtils</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.jdbc.</span><span class="p">{</span><span class="n">JdbcDialect</span><span class="p">,</span><span class="w"> </span><span class="n">JdbcDialects</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.sources.BaseRelation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.types.StructType</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql._</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.Connection</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">object</span><span class="w"> </span><span class="n">DataFrameWriterEnhance</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">implicit</span><span class="w"> </span><span class="kd">class</span> <span class="nf">DataFrameWriterMysqlUpdateEnhance</span><span class="p">(</span><span class="n">writer</span><span class="p">:</span><span class="w"> </span><span class="n">DataFrameWriter</span><span class="o">[</span><span class="n">Row</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="nf">update</span><span class="p">():</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">extraOptionsField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">writer</span><span class="p">.</span><span class="na">getClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;org$apache$spark$sql$DataFrameWriter$$extraOptions&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">dfField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">writer</span><span class="p">.</span><span class="na">getClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;df&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">sourceField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">writer</span><span class="p">.</span><span class="na">getClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;source&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">partitioningColumnsField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">writer</span><span class="p">.</span><span class="na">getClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;partitioningColumns&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">extraOptionsField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">dfField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">sourceField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">partitioningColumnsField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">extraOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extraOptionsField</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">writer</span><span class="p">).</span><span class="na">asInstanceOf</span><span class="o">[</span><span class="n">scala</span><span class="p">.</span><span class="na">collection</span><span class="p">.</span><span class="na">Map</span><span class="o">[</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">]]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dfField</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">writer</span><span class="p">).</span><span class="na">asInstanceOf</span><span class="o">[</span><span class="n">DataFrame</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">partitioningColumns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">partitioningColumnsField</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">writer</span><span class="p">).</span><span class="na">asInstanceOf</span><span class="o">[</span><span class="n">Option</span><span class="o">[</span><span class="n">Seq</span><span class="o">[</span><span class="n">String</span><span class="o">]]]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">logicalPlanField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="p">.</span><span class="na">getClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;logicalPlan&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">logicalPlanField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="n">logicalPlan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logicalPlanField</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">df</span><span class="p">).</span><span class="na">asInstanceOf</span><span class="o">[</span><span class="n">LogicalPlan</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="p">.</span><span class="na">sparkSession</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">dataSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DataSource</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">sparkSession</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="s">&#34;${DataFrameWriterEnhance.getClass.getName}MysqlUpdateRelationProvider&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">partitionColumns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">partitioningColumns</span><span class="p">.</span><span class="na">getOrElse</span><span class="p">(</span><span class="n">Nil</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extraOptions</span><span class="p">.</span><span class="na">toMap</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">logicalPlan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataSource</span><span class="p">.</span><span class="na">planForWriting</span><span class="p">(</span><span class="n">SaveMode</span><span class="p">.</span><span class="na">Append</span><span class="p">,</span><span class="w"> </span><span class="n">logicalPlan</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">qe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">sessionState</span><span class="p">.</span><span class="na">executePlan</span><span class="p">(</span><span class="n">logicalPlan</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">SQLExecution</span><span class="p">.</span><span class="na">withNewExecutionId</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">qe</span><span class="p">)(</span><span class="n">qe</span><span class="p">.</span><span class="na">toRdd</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">class</span> <span class="nc">MysqlUpdateRelationProvider</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">JdbcRelationProvider</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">override</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">createRelation</span><span class="p">(</span><span class="n">sqlContext</span><span class="p">:</span><span class="w"> </span><span class="n">SQLContext</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">:</span><span class="w"> </span><span class="n">SaveMode</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">:</span><span class="w"> </span><span class="n">Map</span><span class="o">[</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">df</span><span class="p">:</span><span class="w"> </span><span class="n">DataFrame</span><span class="p">):</span><span class="w"> </span><span class="n">BaseRelation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JdbcOptionsInWrite</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">isCaseSensitive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqlContext</span><span class="p">.</span><span class="na">sparkSession</span><span class="p">.</span><span class="na">sessionState</span><span class="p">.</span><span class="na">conf</span><span class="p">.</span><span class="na">caseSensitiveAnalysis</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JdbcUtils</span><span class="p">.</span><span class="na">createConnectionFactory</span><span class="p">(</span><span class="n">options</span><span class="p">)()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="n">tableExists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JdbcUtils</span><span class="p">.</span><span class="na">tableExists</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tableExists</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">mode</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">SaveMode</span><span class="p">.</span><span class="na">Overwrite</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="na">isTruncate</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">JdbcUtils</span><span class="p">.</span><span class="na">isCascadingTruncateTable</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="na">url</span><span class="p">).</span><span class="na">contains</span><span class="p">(</span><span class="kc">false</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// In this case, we should truncate table and then load.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">JdbcUtils</span><span class="p">.</span><span class="na">truncateTable</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">val</span><span class="w"> </span><span class="n">tableSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JdbcUtils</span><span class="p">.</span><span class="na">getSchemaOption</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">updateTable</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">tableSchema</span><span class="p">,</span><span class="w"> </span><span class="n">isCaseSensitive</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// Otherwise, do not truncate the table, instead drop and recreate it</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">JdbcUtils</span><span class="p">.</span><span class="na">dropTable</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="na">table</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">JdbcUtils</span><span class="p">.</span><span class="na">createTable</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">updateTable</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="na">schema</span><span class="p">),</span><span class="w"> </span><span class="n">isCaseSensitive</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">SaveMode</span><span class="p">.</span><span class="na">Append</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">val</span><span class="w"> </span><span class="n">tableSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JdbcUtils</span><span class="p">.</span><span class="na">getSchemaOption</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">updateTable</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">tableSchema</span><span class="p">,</span><span class="w"> </span><span class="n">isCaseSensitive</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">SaveMode</span><span class="p">.</span><span class="na">ErrorIfExists</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">s</span><span class="s">&#34;Table or view &#39;${options.table}&#39; already exists. &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">s</span><span class="s">&#34;SaveMode: ErrorIfExists.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">SaveMode</span><span class="p">.</span><span class="na">Ignore</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// With `SaveMode.Ignore` mode, if table already exists, the save operation is expected</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// to not save the contents of the DataFrame and to not change the existing data.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Therefore, it is okay to do nothing here and then just return the relation below.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">JdbcUtils</span><span class="p">.</span><span class="na">createTable</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">updateTable</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="na">schema</span><span class="p">),</span><span class="w"> </span><span class="n">isCaseSensitive</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">conn</span><span class="p">.</span><span class="na">close</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">createRelation</span><span class="p">(</span><span class="n">sqlContext</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="nf">updateTable</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="w"> </span><span class="n">DataFrame</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">tableSchema</span><span class="p">:</span><span class="w"> </span><span class="n">Option</span><span class="o">[</span><span class="n">StructType</span><span class="o">]</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">isCaseSensitive</span><span class="p">:</span><span class="w"> </span><span class="n">Boolean</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">options</span><span class="p">:</span><span class="w"> </span><span class="n">JdbcOptionsInWrite</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="na">url</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="na">table</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">dialect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JdbcDialects</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">rddSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="p">.</span><span class="na">schema</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">getConnection</span><span class="p">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JdbcUtils</span><span class="p">.</span><span class="na">createConnectionFactory</span><span class="p">(</span><span class="n">options</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">batchSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="na">batchSize</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">isolationLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="na">isolationLevel</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">updateStmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUpdateStatement</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">rddSchema</span><span class="p">,</span><span class="w"> </span><span class="n">tableSchema</span><span class="p">,</span><span class="w"> </span><span class="n">isCaseSensitive</span><span class="p">,</span><span class="w"> </span><span class="n">dialect</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">println</span><span class="p">(</span><span class="n">updateStmt</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">repartitionedDF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="na">numPartitions</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">s</span><span class="s">&#34;Invalid value `$n` for parameter `${JDBCOptions.JDBC_NUM_PARTITIONS}` in table writing &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;via JDBC. The minimum value is 1.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">df</span><span class="p">.</span><span class="na">rdd</span><span class="p">.</span><span class="na">partitions</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">df</span><span class="p">.</span><span class="na">coalesce</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">df</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">repartitionedDF</span><span class="p">.</span><span class="na">rdd</span><span class="p">.</span><span class="na">foreachPartition</span><span class="p">(</span><span class="n">iterator</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">JdbcUtils</span><span class="p">.</span><span class="na">savePartition</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">getConnection</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">iterator</span><span class="p">,</span><span class="w"> </span><span class="n">rddSchema</span><span class="p">,</span><span class="w"> </span><span class="n">updateStmt</span><span class="p">,</span><span class="w"> </span><span class="n">batchSize</span><span class="p">,</span><span class="w"> </span><span class="n">dialect</span><span class="p">,</span><span class="w"> </span><span class="n">isolationLevel</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">options</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="nf">getUpdateStatement</span><span class="p">(</span><span class="n">table</span><span class="p">:</span><span class="w"> </span><span class="n">String</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                           </span><span class="n">rddSchema</span><span class="p">:</span><span class="w"> </span><span class="n">StructType</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                           </span><span class="n">tableSchema</span><span class="p">:</span><span class="w"> </span><span class="n">Option</span><span class="o">[</span><span class="n">StructType</span><span class="o">]</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                           </span><span class="n">isCaseSensitive</span><span class="p">:</span><span class="w"> </span><span class="n">Boolean</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                           </span><span class="n">dialect</span><span class="p">:</span><span class="w"> </span><span class="n">JdbcDialect</span><span class="p">):</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">columns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tableSchema</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">rddSchema</span><span class="p">.</span><span class="na">fields</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dialect</span><span class="p">.</span><span class="na">quoteIdentifier</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">name</span><span class="p">)).</span><span class="na">mkString</span><span class="p">(</span><span class="s">&#34;,&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="n">columnNameEquality</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isCaseSensitive</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">spark</span><span class="p">.</span><span class="na">sql</span><span class="p">.</span><span class="na">catalyst</span><span class="p">.</span><span class="na">analysis</span><span class="p">.</span><span class="na">caseSensitiveResolution</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">spark</span><span class="p">.</span><span class="na">sql</span><span class="p">.</span><span class="na">catalyst</span><span class="p">.</span><span class="na">analysis</span><span class="p">.</span><span class="na">caseInsensitiveResolution</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// The generated insert statement needs to follow rddSchema&#39;s column sequence and</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// tableSchema&#39;s column names. When appending data into some case-sensitive DBMSs like</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// PostgreSQL/Oracle, we need to respect the existing case-sensitive column names instead of</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// RDD column names for user convenience.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="n">tableColumnNames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tableSchema</span><span class="p">.</span><span class="na">get</span><span class="p">.</span><span class="na">fieldNames</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">rddSchema</span><span class="p">.</span><span class="na">fields</span><span class="p">.</span><span class="na">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="n">normalizedName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tableColumnNames</span><span class="p">.</span><span class="na">find</span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">columnNameEquality</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">.</span><span class="na">name</span><span class="p">)).</span><span class="na">getOrElse</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;&#34;&#34;Column &#34;</span><span class="n">$</span><span class="p">{</span><span class="n">col</span><span class="p">.</span><span class="na">name</span><span class="p">}</span><span class="s">&#34; not found in schema $tableSchema&#34;&#34;&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">dialect</span><span class="p">.</span><span class="na">quoteIdentifier</span><span class="p">(</span><span class="n">normalizedName</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}.</span><span class="na">mkString</span><span class="p">(</span><span class="s">&#34;,&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">placeholders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rddSchema</span><span class="p">.</span><span class="na">fields</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#34;?&#34;</span><span class="p">).</span><span class="na">mkString</span><span class="p">(</span><span class="s">&#34;,&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">s</span><span class="s">&#34;&#34;&#34;INSERT INTO $table ($columns) VALUES ($placeholders)
</span></span></span><span class="line"><span class="cl"><span class="s">         |ON DUPLICATE KEY UPDATE
</span></span></span><span class="line"><span class="cl"><span class="s">         |${columns.split(&#34;</span><span class="p">,</span><span class="s">&#34;).map(col =&gt; s&#34;</span><span class="n">$col</span><span class="o">=</span><span class="n">VALUES</span><span class="p">(</span><span class="n">$col</span><span class="p">)</span><span class="s">&#34;).mkString(&#34;</span><span class="p">,</span><span class="s">&#34;)}
</span></span></span><span class="line"><span class="cl"><span class="s">         |&#34;&#34;&#34;</span><span class="p">.</span><span class="na">stripMargin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="工具类-mysqlutils" class="heading-element">
  <a href="#%e5%b7%a5%e5%85%b7%e7%b1%bb-mysqlutils" class="heading-mark"></a>工具类 MysqlUtils</h2><div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.xxx.utils</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.xxx.utils.DataFrameWriterEnhance.DataFrameWriterMysqlUpdateEnhance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.functions.col</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.types.</span><span class="p">{</span><span class="n">NullType</span><span class="p">,</span><span class="w"> </span><span class="n">ShortType</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.</span><span class="p">{</span><span class="n">DataFrame</span><span class="p">,</span><span class="w"> </span><span class="n">SaveMode</span><span class="p">,</span><span class="w"> </span><span class="n">SparkSession</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">object</span><span class="w"> </span><span class="n">MysqlUtils</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="nf">upsert</span><span class="p">(</span><span class="n">rawDF</span><span class="p">:</span><span class="w"> </span><span class="n">DataFrame</span><span class="p">,</span><span class="w"> </span><span class="n">database</span><span class="p">:</span><span class="w"> </span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">tableName</span><span class="p">:</span><span class="w"> </span><span class="n">String</span><span class="p">)(</span><span class="n">implicit</span><span class="w"> </span><span class="n">spark</span><span class="p">:</span><span class="w"> </span><span class="n">SparkSession</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rawDF</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">for</span><span class="w"> </span><span class="p">(</span><span class="n">elem</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="p">.</span><span class="na">schema</span><span class="p">.</span><span class="na">fields</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">elem</span><span class="p">.</span><span class="na">dataType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NullType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="p">.</span><span class="na">withColumn</span><span class="p">(</span><span class="n">elem</span><span class="p">.</span><span class="na">name</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">(</span><span class="n">elem</span><span class="p">.</span><span class="na">name</span><span class="p">).</span><span class="na">cast</span><span class="p">(</span><span class="n">ShortType</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">df</span><span class="p">.</span><span class="na">write</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;jdbc&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="na">mode</span><span class="p">(</span><span class="n">SaveMode</span><span class="p">.</span><span class="na">Append</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="na">option</span><span class="p">(</span><span class="s">&#34;driver&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;com.mysql.jdbc.Driver&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="na">option</span><span class="p">(</span><span class="s">&#34;url&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="na">conf</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;spark.job.mysql.${database}.url&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="na">option</span><span class="p">(</span><span class="s">&#34;user&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="na">conf</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;spark.job.mysql.${database}.username&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="na">option</span><span class="p">(</span><span class="s">&#34;password&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="na">conf</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;spark.job.mysql.${database}.password&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="na">option</span><span class="p">(</span><span class="s">&#34;dbtable&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">tableName</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="na">option</span><span class="p">(</span><span class="s">&#34;useSSL&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;false&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="na">option</span><span class="p">(</span><span class="s">&#34;showSql&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;false&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="na">option</span><span class="p">(</span><span class="s">&#34;numPartitions&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;1&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="na">update</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="使用" class="heading-element">
  <a href="#%e4%bd%bf%e7%94%a8" class="heading-mark"></a>使用</h2><p>spark启动脚本加入mysql配置</p>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">spark-submit <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--master yarn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--deploy-mode cluster <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--executor-memory 3G <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--num-executors <span class="m">5</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--executor-cores <span class="m">4</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--driver-memory 3G <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.job.mysql.test.url<span class="o">=</span><span class="si">${</span><span class="nv">jdbc_url</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.job.mysql.test.username<span class="o">=</span><span class="si">${</span><span class="nv">jdbc_username</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.job.mysql.test.password<span class="o">=</span><span class="si">${</span><span class="nv">jdbc_password</span><span class="si">}</span> <span class="err">\</span></span></span></code></pre></td></tr></table>
</div>
</div><p>使用范例</p>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">utils.MysqlUtils</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">object</span><span class="w"> </span><span class="n">TestMysqlUpsert</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="n">Array</span><span class="o">[</span><span class="n">String</span><span class="o">]</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">implicit</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="n">spark</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SparkSession</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">enableHiveSupport</span><span class="p">().</span><span class="na">getOrCreate</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kn">import</span><span class="w"> </span><span class="nn">spark.implicits._</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;test&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Array</span><span class="p">((</span><span class="n">1</span><span class="p">,</span><span class="n">11</span><span class="p">,</span><span class="s">&#34;name1&#34;</span><span class="p">,</span><span class="n">11111</span><span class="p">),(</span><span class="n">2</span><span class="p">,</span><span class="n">22</span><span class="p">,</span><span class="s">&#34;name2&#34;</span><span class="p">,</span><span class="n">22222</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="na">sparkContext</span><span class="p">.</span><span class="na">parallelize</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="na">toDF</span><span class="p">(</span><span class="s">&#34;key_one&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;key_two&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;val_one&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;val_two&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MysqlUtils</span><span class="p">.</span><span class="na">upsert</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">database</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;test_unique_key&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">spark</span><span class="p">.</span><span class="na">close</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>test_unique_key表结构</p>
<div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">test_unique_key</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">key_one</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">key_two</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">val_one</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">val_two</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">uk</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">key_one</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">key_two</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="w"> </span><span class="k">COMMENT</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="参考" class="heading-element">
  <a href="#%e5%8f%82%e8%80%83" class="heading-mark"></a>参考</h2><p><a href="https://blog.csdn.net/qq_18453581/article/details/125907861" title="csdn_Spark Upsert写入Mysql(scala增强) 无需依赖"target="_blank" rel="external nofollow noopener noreferrer">csdn_Spark Upsert写入Mysql(scala增强) 无需依赖<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>]]></description></item><item><title>java 频次控制</title><link>https://hpk.me/posts/java-rate-limit-google-guava/</link><pubDate>Tue, 18 Apr 2023 14:21:15 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/java-rate-limit-google-guava/</guid><description><![CDATA[<p>访问某接口拉取数据，接口需要频次控制，经调研，<code>com.google.common.util.concurrent.RateLimiter</code>可轻易实现。</p>
<h2 id="1-maven" class="heading-element">
  <a href="#1-maven" class="heading-mark"></a>1. Maven</h2><div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.google.guava<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>guava<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>31.1-jre<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>cn.hutool<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>hutool-all<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>5.8.4<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2-测试代码" class="heading-element">
  <a href="#2-%e6%b5%8b%e8%af%95%e4%bb%a3%e7%a0%81" class="heading-mark"></a>2. 测试代码</h2><div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">cn.hutool.http.HttpRequest</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.google.common.util.concurrent.RateLimiter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.TimeUnit</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RateLimiterTest</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RateLimiter</span><span class="w"> </span><span class="n">rateLimiter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RateLimiter</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">20</span><span class="p">,</span><span class="n">1000</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="nf">RateLimiterTest</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">InstanceHolder</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RateLimiterTest</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RateLimiterTest</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">RateLimiterTest</span><span class="w"> </span><span class="nf">getInstance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">InstanceHolder</span><span class="p">.</span><span class="na">instance</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">runHttpGet</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">header</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">rateLimiter</span><span class="p">.</span><span class="na">acquire</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HttpRequest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">execute</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">body</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TestRate</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="p">,</span><span class="w"> </span><span class="n">ExecutionException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;https://xxxxx&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">header</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;Content-type&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">singletonList</span><span class="p">(</span><span class="s">&#34;application/json&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">header</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;Access-Token&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">singletonList</span><span class="p">(</span><span class="s">&#34;xxxxx&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">60</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">callable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">RateLimiterTest</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RateLimiterTest</span><span class="p">.</span><span class="na">getInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="na">runHttpGet</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">tasks</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">callable</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span><span class="n">60</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">futures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exec</span><span class="p">.</span><span class="na">invokeAll</span><span class="p">(</span><span class="n">tasks</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">futures</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">future</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">exec</span><span class="p">.</span><span class="na">shutdown</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>python3 easyocr 简单使用识别参数</title><link>https://hpk.me/posts/python3-easyocr-simple/</link><pubDate>Tue, 18 Apr 2023 14:18:37 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/python3-easyocr-simple/</guid><description><![CDATA[<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">easyocr</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">gpu_is_available</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">reader</span> <span class="o">=</span> <span class="n">easyocr</span><span class="o">.</span><span class="n">Reader</span><span class="p">([</span><span class="s1">&#39;ch_sim&#39;</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">],</span> <span class="n">gpu</span><span class="o">=</span><span class="n">gpu_is_available</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ocr_data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">readtext</span><span class="p">(</span><span class="s1">&#39;/image/path&#39;</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">text_threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">low_text</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width_ths</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>detail = 0 仅输出识别到的文字</li>
<li>text_threshold=0.7 文本置信阈值，值越小，文本块内被识别为文字的可能性越高</li>
<li>low_text=0.1 值越小，图片内容被识别为文本块的可能性就更高</li>
<li>width_ths=0.3 控制横向图片内容是否会被识别为一个或多个文本块，值越小被识别成多个文本块的可能性就更高</li>
<li>待续&hellip;</li>
</ol>
<p>参考：</p>
<ol>
<li><a href="https://www.jaided.ai/easyocr/documentation/" title="官方文档"target="_blank" rel="external nofollow noopener noreferrer">官方文档<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://cloud.tencent.com/developer/article/2016127" title="Python使用EasyOCR库对行程码图片进行OCR文字识别介绍与实践"target="_blank" rel="external nofollow noopener noreferrer">Python使用EasyOCR库对行程码图片进行OCR文字识别介绍与实践<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ol>]]></description></item><item><title>presto 自定义函数简述</title><link>https://hpk.me/posts/presto-udf-simple/</link><pubDate>Tue, 18 Apr 2023 14:16:42 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/presto-udf-simple/</guid><description><![CDATA[<p>presto自带unbase64函数某些时候会报错，所以想要自定义一个unbase64函数。</p>
<p>presto自带unbase64函数，用法如下。</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">FROM_UTF8(from_base64(nickname))</span></span></code></pre></td></tr></table>
</div>
</div><p>但是有些字符会报错。</p>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Query failed (#20220720_091551_00087_mkhun): Illegal base64 character -1a</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="idea新建maven项目" class="heading-element">
  <a href="#idea%e6%96%b0%e5%bb%bamaven%e9%a1%b9%e7%9b%ae" class="heading-mark"></a>idea新建maven项目</h2><p>pom文件如下：</p>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">    <span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.facebook.presto<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>presto-spi<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>0.272<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.google.guava<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>guava<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>18.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;build&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugins&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;artifactId&gt;</span>maven-jar-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;configuration&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;classesDirectory&gt;</span>target/classes/<span class="nt">&lt;/classesDirectory&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;archive&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;manifest&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;mainClass&gt;</span>com.alibaba.dubbo.container.Main<span class="nt">&lt;/mainClass&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="c">&lt;!-- 打包时 MANIFEST.MF文件不记录的时间戳版本 --&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;useUniqueVersions&gt;</span>false<span class="nt">&lt;/useUniqueVersions&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;addClasspath&gt;</span>true<span class="nt">&lt;/addClasspath&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;classpathPrefix&gt;</span>lib/<span class="nt">&lt;/classpathPrefix&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;/manifest&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;manifestEntries&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;Class-Path&gt;</span>.<span class="nt">&lt;/Class-Path&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;/manifestEntries&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;/archive&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/configuration&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;artifactId&gt;</span>maven-dependency-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;executions&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;execution&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;id&gt;</span>copy-dependencies<span class="nt">&lt;/id&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;goals&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;goal&gt;</span>copy-dependencies<span class="nt">&lt;/goal&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;/goals&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;configuration&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;type&gt;</span>jar<span class="nt">&lt;/type&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;includeTypes&gt;</span>jar<span class="nt">&lt;/includeTypes&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;outputDirectory&gt;</span>
</span></span><span class="line"><span class="cl">                                ${project.build.directory}/lib
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;/outputDirectory&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;/configuration&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;/execution&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/executions&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;groupId&gt;</span>com.facebook.presto<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;artifactId&gt;</span>presto-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;version&gt;</span>0.3<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;extensions&gt;</span>true<span class="nt">&lt;/extensions&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugins&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/build&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="function开发" class="heading-element">
  <a href="#function%e5%bc%80%e5%8f%91" class="heading-mark"></a>function开发</h2><div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">base64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.facebook.presto.common.type.StandardTypes</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.facebook.presto.spi.function.Description</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.facebook.presto.spi.function.ScalarFunction</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.facebook.presto.spi.function.SqlType</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">io.airlift.slice.Slice</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">io.airlift.slice.Slices</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UnBase64Function</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@ScalarFunction</span><span class="p">(</span><span class="s">&#34;unBase64&#34;</span><span class="p">)</span><span class="w"> </span><span class="c1">// 固定参数，表示函数名的意思，也就我们在使用Presto的时候用的函数名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Description</span><span class="p">(</span><span class="s">&#34;base64解密&#34;</span><span class="p">)</span><span class="w"> </span><span class="c1">// 函数的注释</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@SqlType</span><span class="p">(</span><span class="n">StandardTypes</span><span class="p">.</span><span class="na">VARCHAR</span><span class="p">)</span><span class="w"> </span><span class="c1">// 表示数据类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Slice</span><span class="w"> </span><span class="nf">unBase64</span><span class="p">(</span><span class="nd">@SqlType</span><span class="p">(</span><span class="n">StandardTypes</span><span class="p">.</span><span class="na">VARCHAR</span><span class="p">)</span><span class="w"> </span><span class="n">Slice</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 解码</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">decodeBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Base64</span><span class="p">.</span><span class="na">getDecoder</span><span class="p">().</span><span class="na">decode</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="na">toStringUtf8</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">decodeBytes</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;utf-8&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Slices</span><span class="p">.</span><span class="na">utf8Slice</span><span class="p">(</span><span class="n">res</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="plugin开发" class="heading-element">
  <a href="#plugin%e5%bc%80%e5%8f%91" class="heading-mark"></a>plugin开发</h2><div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Set</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">base64.Base64Function</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">base64.UnBase64Function</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.facebook.presto.spi.Plugin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.google.common.collect.ImmutableSet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PrestoUdfPlugin</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Plugin</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">getFunctions</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ImmutableSet</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span><span class="n">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// 添加插件class</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">UnBase64Function</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="加载plugin" class="heading-element">
  <a href="#%e5%8a%a0%e8%bd%bdplugin" class="heading-mark"></a>加载plugin</h2><p>在src/main/resources下创建目录META-INF，再在META-INF目录下创建services目录，注意下图项目结构中META-INF是父目录 services是子目录，只是idea合并显示了，不是说文件夹名里面有点 “.” 。然后创建文件com.facebook.presto.spi.Plugin，文件内容为plugin的全类名。
例如本例：<code>PrestoUdfPlugin</code></p>
<h2 id="上线" class="heading-element">
  <a href="#%e4%b8%8a%e7%ba%bf" class="heading-mark"></a>上线</h2><ol>
<li>maven打包。</li>
<li>在所有presto节点服务器的presto安装目录${PRESTO_HOME}/plugin下新建一个my_plugin目录。</li>
<li>上传jar包，及相关依赖包（在lib目录下）到所有服务器新建的my_plugin目录下。</li>
<li>重启presto： ${PRESTO_HOME}/bin/launcher restart。</li>
</ol>
<h1 id="项目结构" class="heading-element">
  <a href="#%e9%a1%b9%e7%9b%ae%e7%bb%93%e6%9e%84" class="heading-mark"></a>项目结构</h1><p><figure><a class="lightgallery" href="https://m.360buyimg.com/babel/jfs/t1/2081/12/19574/60306/62d7d4afEe88e1e4b/e23c77b2aa3d6304.png?size=large" data-thumbnail="https://m.360buyimg.com/babel/jfs/t1/2081/12/19574/60306/62d7d4afEe88e1e4b/e23c77b2aa3d6304.png?size=small" data-sub-html="<h2>结构</h2><p>结构</p>"><img loading="lazy" src="https://m.360buyimg.com/babel/jfs/t1/2081/12/19574/60306/62d7d4afEe88e1e4b/e23c77b2aa3d6304.png" alt="结构" srcset="https://m.360buyimg.com/babel/jfs/t1/2081/12/19574/60306/62d7d4afEe88e1e4b/e23c77b2aa3d6304.png?size=small, https://m.360buyimg.com/babel/jfs/t1/2081/12/19574/60306/62d7d4afEe88e1e4b/e23c77b2aa3d6304.png?size=medium 1.5x, https://m.360buyimg.com/babel/jfs/t1/2081/12/19574/60306/62d7d4afEe88e1e4b/e23c77b2aa3d6304.png?size=large 2x" data-title="结构" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a><figcaption class="image-caption">结构</figcaption>
  </figure></p>
<p>参考：<a href="https://blog.csdn.net/Mrerlou/article/details/119997884" title="【presto】方法二：presto实现自定义UDF函数"target="_blank" rel="external nofollow noopener noreferrer">【presto】方法二：presto实现自定义UDF函数<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>]]></description></item><item><title>python3 pandas 实现mysql upsert操作（唯一键更新）</title><link>https://hpk.me/posts/python3-pandas-mysql-upsert/</link><pubDate>Tue, 18 Apr 2023 14:15:04 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/python3-pandas-mysql-upsert/</guid><description><![CDATA[<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">parse</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">parse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="s1">&#39;xxxxxx.mysql.rds.aliyuncs.com&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">3306</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span>
</span></span><span class="line"><span class="cl">           <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;mysql+pymysql://</span><span class="si">%(user)s</span><span class="s1">:</span><span class="si">%(password)s</span><span class="s1">@</span><span class="si">%(host)s</span><span class="s1">:</span><span class="si">%(port)d</span><span class="s1">/</span><span class="si">%(database)s</span><span class="s1">?charset=utf8&#39;</span> <span class="o">%</span> <span class="n">db_info</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mysql_replace_into</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">data_iter</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">sqlalchemy.dialects.mysql</span> <span class="kn">import</span> <span class="n">insert</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data_iter</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">update_stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">on_duplicate_key_update</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">inserted</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">stmt</span><span class="o">.</span><span class="n">inserted</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update_stmt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">write_database</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">mysql_replace_into</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;app_id&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;app_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;11111122&#34;</span><span class="p">,</span> <span class="s2">&#34;game_id&#34;</span><span class="p">:</span> <span class="mi">11</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;app_id&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;app_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;22222233&#34;</span><span class="p">,</span> <span class="s2">&#34;game_id&#34;</span><span class="p">:</span> <span class="mi">22</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;app_id&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&#34;app_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;33333344&#34;</span><span class="p">,</span> <span class="s2">&#34;game_id&#34;</span><span class="p">:</span> <span class="mi">33</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">detailDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">write_database</span><span class="p">(</span><span class="n">detailDF</span><span class="p">,</span> <span class="s2">&#34;ad_app_ext&#34;</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>sqoop mysql update AUTO_INCREMENT 自增主键重复增长问题</title><link>https://hpk.me/posts/sqoop-mysql-update-auto-increment/</link><pubDate>Tue, 18 Apr 2023 14:11:19 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/sqoop-mysql-update-auto-increment/</guid><description><![CDATA[<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sqoop <span class="nb">export</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--update-key unique_index_columns <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--update-mode allowinsert</span></span></code></pre></td></tr></table>
</div>
</div><p>问题描述：
用上述模式 sqoop 导入数据更新 mysql 数据，无论导入的数据与mysql里数据相比有没有更新，mysql表的 AUTO_INCREMENT 的PRIMARY KEY 例如 （<code>id</code> int(11) NOT NULL AUTO_INCREMENT COMMENT &lsquo;自增主键&rsquo;） 实际都是增加了的，当有新唯一主键数据插入时，id会是累加后的开始，会变的很大。</p>
<p>解决：
sqoop源码层级暂时没看原因。。。
可以从业务流程上解决下这个问题，保证导入的数据都是新增或者更新的，不会有与mysql一样的数据，可以一定程度上减少 id 的增长。</p>]]></description></item><item><title>脚本执行spark-shell scala文件退出</title><link>https://hpk.me/posts/bash-spark-shell-scala/</link><pubDate>Tue, 18 Apr 2023 14:09:10 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/bash-spark-shell-scala/</guid><description><![CDATA[<p>脚本</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#! /bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">source</span> /etc/profile
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">set</span> +o posix  <span class="c1"># to enable process substitution when not running on bash </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">scala_file</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">shift</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">arguments</span><span class="o">=</span><span class="nv">$@</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">##### scala 文件后加  sys.exit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">spark-shell --master yarn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--executor-cores <span class="m">5</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--num-executors <span class="m">4</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--executor-memory 8g <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--driver-memory 3g <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.serializer<span class="o">=</span>org.apache.spark.serializer.KryoSerializer <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.default.parallelism<span class="o">=</span><span class="m">400</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.sql.shuffle.partitions<span class="o">=</span><span class="m">400</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.shuffle.io.maxRetries<span class="o">=</span><span class="m">10</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.shuffle.io.retryWait<span class="o">=</span>20s <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.yarn.executor.memoryOverhead<span class="o">=</span><span class="m">4096</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--conf spark.network.timeout<span class="o">=</span>300s <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--name sparkshell_scala <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-i &lt;<span class="o">(</span><span class="nb">echo</span> <span class="s1">&#39;val args = &#34;&#39;</span><span class="nv">$arguments</span><span class="s1">&#39;&#34;.split(&#34;\\s+&#34;)&#39;</span> <span class="p">;</span> cat <span class="nv">$scala_file</span><span class="o">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>简单scala文件示例</p>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">val</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">(</span><span class="n">0</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">spark</span><span class="p">.</span><span class="na">read</span><span class="p">.</span><span class="na">parquet</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="na">where</span><span class="p">(</span><span class="s">&#34;app_id = 77701&#34;</span><span class="p">).</span><span class="na">repartition</span><span class="p">(</span><span class="n">1</span><span class="p">).</span><span class="na">write</span><span class="p">.</span><span class="na">parquet</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;${path}_new&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">sys</span><span class="p">.</span><span class="na">exit</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如果不需要传参，可简单使用</p>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">spark-shell &lt; test.scala</span></span></code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>kudu-spark KuduContext java.io.InvalidClassException 解决</title><link>https://hpk.me/posts/kudu-spark-invalid-class-exception/</link><pubDate>Tue, 18 Apr 2023 13:56:34 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/kudu-spark-invalid-class-exception/</guid><description><![CDATA[<p>背景：
线上kudu 集群版本为1.11.0版本, spark 使用 kudu-spark2_2.11-1.7.0.jar，
为了使用新版本中的
<code>val wo = new KuduWriteOptions(ignoreNull = true)</code>
特性，升级至 kudu-spark2_2.11-1.11.0.jar 版本，但是报错。</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">java</span><span class="p">.</span><span class="na">io</span><span class="p">.</span><span class="na">InvalidClassException</span><span class="p">:</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kudu</span><span class="p">.</span><span class="na">spark</span><span class="p">.</span><span class="na">kudu</span><span class="p">.</span><span class="na">KuduContext</span><span class="p">;</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="kd">class</span> <span class="nc">incompatible</span><span class="p">:</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="n">classdesc</span><span class="w"> </span><span class="n">serialVersionUID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xxxxxxxx</span><span class="p">,</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="kd">class</span> <span class="nc">serialVersionUID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xxxxxxx111</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在https://issues.apache.org/jira/browse/KUDU-2898 中说这个已经修复，但是修复的版本是kudu 1.12.0，升级线上kudu版本这个暂时不考虑，只好自己修改源码，重新编译 kudu-spark2_2.11-1.11.0.jar</p>
<ul>
<li>
<p>1.解压 kudu-spark2_2.11-1.11.0.jar ，将解压出的所有文件夹移动至一个空文件夹，例如tmp</p>
</li>
<li>
<p>2.在idea中新建maven项目，配置好 scala 等环境</p>
</li>
<li>
<p>3.解压 kudu-spark2_2.11-1.11.0-sources.jar，将 其中 org 文件夹 复制 至 maven中刚刚建好的项目中（org/apache/kudu/spark/kudu）</p>
</li>
<li>
<p>4.修改文件 KuduContext.scala 、 KuduRDD.scala， 增加或修改 @SerialVersionUID(xxxxxxxxxxL) ，xxxxxxxxxx改为报错信息中的local class serialVersionUID<br></p>
</li>
<li>
<p><img loading="lazy" src="https://im.gurl.eu.org/file/62c78529eb3073b0727e7.png" alt="请输入图片描述" srcset="https://im.gurl.eu.org/file/62c78529eb3073b0727e7.png?size=small, https://im.gurl.eu.org/file/62c78529eb3073b0727e7.png?size=medium 1.5x, https://im.gurl.eu.org/file/62c78529eb3073b0727e7.png?size=large 2x" data-title="请输入图片描述" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><br></p>
</li>
<li>
<p><img loading="lazy" src="https://im.gurl.eu.org/file/c5e7c401b84230d7a9bc3.png" alt="请输入图片描述" srcset="https://im.gurl.eu.org/file/c5e7c401b84230d7a9bc3.png?size=small, https://im.gurl.eu.org/file/c5e7c401b84230d7a9bc3.png?size=medium 1.5x, https://im.gurl.eu.org/file/c5e7c401b84230d7a9bc3.png?size=large 2x" data-title="请输入图片描述" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><br></p>
</li>
<li>
<p><img loading="lazy" src="https://im.gurl.eu.org/file/9513fccdb6c8b328ad76a.png" alt="请输入图片描述" srcset="https://im.gurl.eu.org/file/9513fccdb6c8b328ad76a.png?size=small, https://im.gurl.eu.org/file/9513fccdb6c8b328ad76a.png?size=medium 1.5x, https://im.gurl.eu.org/file/9513fccdb6c8b328ad76a.png?size=large 2x" data-title="请输入图片描述" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><br></p>
</li>
<li>
<p>5：OperationType.scala文件也需修改，和 上面的serialVersionUID不同，走完整个流程运行会报这个文件的serialVersionUID错误，改成错误信息中的local class serialVersionUID</p>
</li>
<li>
<p>6.将 kudu-spark2_2.11-1.11.0.pom 中的 dependencies 粘贴至 maven 中项目的pom文件中，还需额外增加以下依赖：</p>
</li>
</ul>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.apache.kudu<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>kudu-client<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>1.11.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.apache.yetus<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>audience-annotations<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>0.13.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.hdrhistogram<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>HdrHistogram<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>2.1.12<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>7.idea中将maven项目打包</p>
</li>
<li>
<p>8.将idea中打好的包解压，将其中 org/apache/kudu/spark/kudu  下的文件覆盖至 tmp 中 org/apache/kudu/spark/kudu</p>
</li>
<li>
<p>9.将 tmp 文件夹下的所有目录打包成新的jar包</p>
</li>
</ul>
<p>参考链接：</p>
<ol>
<li><a href="https://community.cloudera.com/t5/Support-Questions/KUDU-need-rebuild-post-upgrade-of-CDH-cluster/td-p/92885"target="_blank" rel="external nofollow noopener noreferrer">https://community.cloudera.com/t5/Support-Questions/KUDU-need-rebuild-post-upgrade-of-CDH-cluster/td-p/92885<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://issues.apache.org/jira/browse/KUDU-2898"target="_blank" rel="external nofollow noopener noreferrer">https://issues.apache.org/jira/browse/KUDU-2898<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ol>]]></description></item><item><title>phoenix-client-4.14.1-HBase-1.4.jar jar包冲突解决</title><link>https://hpk.me/posts/phoenix-client-hbase-jar/</link><pubDate>Tue, 18 Apr 2023 13:49:28 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/phoenix-client-hbase-jar/</guid><description><![CDATA[<p>项目用到phoenix，使用了这个jar包phoenix-client-4.14.1-HBase-1.4.jar，这个jar包导致的jar包冲突很多，一番摸索，解决了，解决如下。</p>
<p>先jar命令解压jar包，然后删除以下内容。然后在jar命令打成jar包。</p>
<ol>
<li>rm -r javax/</li>
<li>rm -r com/jayway/</li>
<li>rm -r org/apache/phoenix/shaded/org/apache/thrift</li>
<li>rm -r com/sun/jersey/</li>
</ol>]]></description></item><item><title>spark 读取 hive date 分区表 奇怪的报错</title><link>https://hpk.me/posts/spark-hive-partition-issue/</link><pubDate>Mon, 17 Apr 2023 21:29:55 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/spark-hive-partition-issue/</guid><description><![CDATA[<p>当 hive 表的分区字段 是 date 类型时，用如下方式读取会发生报错。</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">targetDay</span> <span class="k">=</span> <span class="s">&#34;2020-08-20&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">table</span><span class="o">(</span><span class="n">tableName</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="s">s&#34;targetday in (&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,59),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,49),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,39),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,29),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,14),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,6),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,5),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,4),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,3),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,2),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,1),&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">      <span class="s">s&#34;date_sub(&#39;</span><span class="si">$targetDay</span><span class="s">&#39;,0))&#34;</span> <span class="o">).</span><span class="n">show</span></span></span></code></pre></td></tr></table>
</div>
</div><p>targetday 为 表的分区字段，date类型。
当 in 后面 的日期个数大于 10 时就会报错，小于等于 10 时都不会报错。奇怪的现象。。。
targetday 为 string 类型不会有此错误。</p>]]></description></item><item><title>Apache Kudu 写入数据定期出问题</title><link>https://hpk.me/posts/kudu-periodic-issues/</link><pubDate>Mon, 17 Apr 2023 21:23:09 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/kudu-periodic-issues/</guid><description><![CDATA[<p>线上项目出现一个很奇怪的问题，数据经过Spark程序消费Kafka写入Kudu，出现Kudu Master连接超时，这个问题开始排查不出原因，有点头大，只能采用下下策，重启Spark程序，出现过几次后， 我记录了出现的时间，发现每次出现时间有个固定周期，一周，有规律就是最大的好消息，感觉离发现真相不远了，果然网上有这方面的问题讨论，虽说以前也去网上搜索过相关问题，毕竟Kudu相比于Hive、HBase还是小众了一点。。。是Kudu Java Client的问题，使用1.5以上版本就没问题了。</p>
<p>参考：<a href="https://blog.csdn.net/u011489205/article/details/79173537"target="_blank" rel="external nofollow noopener noreferrer">关于kudu使用的一些问题及解决办法<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>]]></description></item><item><title>spark yarn cluster模式下log4j日志的配置</title><link>https://hpk.me/posts/spark-yarn-cluster-log4j/</link><pubDate>Mon, 17 Apr 2023 21:19:43 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/spark-yarn-cluster-log4j/</guid><description><![CDATA[<p>最近线上的spark项目日志文件急剧增加，磁盘顶不住了啊，解决日志文件问题，参考下面三篇文章，基本就可以搞明白了。</p>
<ol>
<li><a href="https://www.jianshu.com/p/0fe51185eeba"target="_blank" rel="external nofollow noopener noreferrer">Spark日志过大导致磁盘溢出问题解决方案<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="http://www.cnblogs.com/163yun/p/9882530.html"target="_blank" rel="external nofollow noopener noreferrer">Spark日志配置及问题排查方式。<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://blog.csdn.net/ZMC921/article/details/80238392"target="_blank" rel="external nofollow noopener noreferrer">Spark log4j 日志配置详解<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ol>
<p>以上内容转载自网络，如有侵权，请联系删除。</p>]]></description></item><item><title>五十个电子书搜索网</title><link>https://hpk.me/posts/book-search-website/</link><pubDate>Mon, 17 Apr 2023 21:15:15 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/book-search-website/</guid><description><![CDATA[<p><em>转载自网络，不保证可用性及是否拥有版权，仅供分享，如有法律纠纷，请联系删除。</em></p>
<h1 id="国内网站" class="heading-element">
  <a href="#%e5%9b%bd%e5%86%85%e7%bd%91%e7%ab%99" class="heading-mark"></a><strong>国内网站</strong></h1><p>1、鸠摩搜书</p>
<p>网址：https://www.jiumodiary.com/</p>
<p>一个强大的搜书神站，无论是什么类型的书籍，只要你知道书名，就可以轻松的搜到你想要书籍。页面简单明了，书籍种类繁多，格式多种多样，有mobi格式、pdf格式、word格式、txt格式等。关键是可以无限下载，无需注册登录。</p>
<p>2、周读</p>
<p>网址：http://www.ireadweek.com/index.php/Index/index.html</p>
<p>周读是一个提供优质的epud,mobi,pdf,txt电子书下载和分享的网站，帮助不知道读什么书的用户，选择值得读的好书籍，该网站提供多种书籍分类，涵盖了大多数的可读书籍。</p>
<p>3、我的小书屋</p>
<p>网址：http://mebook.cc/</p>
<p>免费无广告、电子书的质量很好，图书都是经过站长精挑细选的。网站分为畅销小说、网络小说、合集资源、多看专区、杂志期刊、漫画、工具书、原版书籍、轻小说等模块。站长每天都会推荐更新几本书，书太多不知道读什么，就试试站长推荐的吧。</p>
<p>4、书格</p>
<p>网址： <a href="https://shuge.org/"target="_blank" rel="external nofollow noopener noreferrer">https://shuge.org/<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>书格是一个自由开放的在线古籍图书馆，致力于开放式分享、介绍、推荐古本（四九以前的影像本）PDF；网站致力于为古籍的保护与数字化传播贡献。</p>
<p>5、西林街搜索</p>
<p>网址：http://www.xilinjie.com/</p>
<p>专注于网盘、视频、文库（文档、古籍、专业书籍、电子书PDF、ePub、Mobi等格式）、学术（各种期刊、论文、学报等）和Mooc（在线课程、学习、视频教程）等资源的搜索。</p>
<p>6、好读</p>
<p>网址：http://haodoo.net</p>
<p>免费的线上繁体中文图书馆，可在线阅读及下载，可下载的格式有：updb，pdb，prc，epub。</p>
<p>7、图灵社区</p>
<p>网址：http://www.ituring.com.cn/</p>
<p>图灵社区主要专注于科技书籍的出版，包括计算机、数学统计、科普等领域，提供免费和付费的电子书。用户可以使用网银或者支付宝的购买方式，大部分电子书同时提供了三种阅读方式：在线阅读、MOBI 推送、PDF 下载，部分书籍只提供其中部分格式。</p>
<p>8、盘搜</p>
<p>网址：http://www.pansoso.com/</p>
<p>一个老牌网盘搜索工具，功能非常强大，界面非常简洁。每天都有更新，不同达人分享自己的“盘中资源”！盘搜不存储任何网盘内容，但是资源非常丰富，无论是工作还是学习都必备。</p>
<p>9、苦瓜书盘</p>
<p>网址：https://kgbook.com/</p>
<p>苦瓜书盘,电子书分享的平台。适合电纸书阅读的6寸pdf及mobi格式电子书制作技术的网站。</p>
<p>10、新浪爱问共享资料</p>
<p>网址：http://ishare.iask.sina.com.cn/</p>
<p>新浪爱问共享资料是新浪旗下的在线资料分享站，免费高速上传或下载各类资源，内容涉及教育资源、专业资料、IT的资料、娱乐生活、经济管理、办公文书、游戏资料等。如果你要寻找偏学术的资料，所有地方都找不到，可以来这里试试，一般为扫描版PDF。</p>
<p>11、E书联盟</p>
<p>网址：http://www.book118.com/</p>
<p>E书联盟是一个庞大的免费中文电子书下载站，提供各类电子书下载，其中含比较专业的电子图书，提供部分电子书在线阅读。</p>
<p>12、云海电子图书馆</p>
<p>网址：http://www.pdfbook.cn/</p>
<p>云海电子图书馆是致力于pdf电子书的专业网站,提供各门类pdf电子书下载及高清pdf电子书。</p>
<p>13、万千集合站</p>
<p>网址：http://www.hejizhan.com/html/search</p>
<p>包含非常多的教材类相关电子书籍，搜索后直接显示下载链接。搜索结果基本涵盖了所有版本的电子教材、习题详解等。如果上大学时有这种资源，就省下好多买教材、习题解答的钱了。</p>
<p>14、蚂蚁搜书</p>
<p>网址：http://book.mybanshu.win/</p>
<p>IT书更多的资源网站，支持下载，不支持kindle推送。注册需要加微信索要邀请码，也是管理很严格了。</p>
<p>15、书语者</p>
<p>网址：https://book.shuyuzhe.com/</p>
<p>书语者电子图书馆，一个搜书网站，让你快速找到想要的书籍！</p>
<p>16、计算机书控</p>
<p>网址：http://bestcbooks.com/</p>
<p>这个网站可谓是计算机专业的福音，这里包含许多优秀的计算机书籍下载。无论是英文原版还是中文这里都有。</p>
<p>17、影印古籍资料</p>
<p>网址：https://sou-yun.com/eBookIndex.aspx</p>
<p>提供7000+种古籍资料的网上阅读和PDF格式下载服务。</p>
<p>18、知轩藏书</p>
<p>网址：http://www.zxcs8.com/</p>
<p>这是一个小说网站，在这里你可以找到你想要的小说。</p>
<p>19、国学网</p>
<p>地址：http://www.guoxue.com/</p>
<p>一家在国学传播领域独具特色的文化创意企业，主要从事古籍数字化研究、网络文献检索开发和网站建设，是中国最大的专业古籍电子文献数据公司之一。</p>
<p>20、国家数字图书馆</p>
<p>网址： <a href="http://www.nlc.gov.cn/index.htm"target="_blank" rel="external nofollow noopener noreferrer">http://www.nlc.gov.cn/index.htm<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>大量在线资源、子数据库、可以在线阅读海量电子书，需要注册（实名注册、需要身份证号）。国图购买了大量资源，有账号，便可在线阅读或者下载，版权期限内的图书只能读前两章，民国图书和古籍则可阅读全部内容。</p>
<p>21、PDF之家</p>
<p>网址： <a href="http://www.pdfzj.com/"target="_blank" rel="external nofollow noopener noreferrer">http://www.pdfzj.com/<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>PDF之家，做中国最好的pdf资源站，致力最全最新的pdf杂志、期刊杂志、电子杂志、电子图书的免费分享和下载服务。</p>
<p>22、我爱读电子书</p>
<p>网址：http://www.woaidu.org/</p>
<p>我爱读电子书是权威电子书搜索引擎，可以使用我爱读电子书快速的找到自己喜欢的电子书，也可以通过书榜了解最新最热门的书，随时随地畅想自己喜欢的书。</p>
<p>23、高清杂志网</p>
<p>网址：http://www.gqzzw.com/</p>
<p>高清杂志网提供杂志国内热门原版高清电子杂志下载服务,目前有财经理财、电脑数码、故事传奇、婚姻家庭、健康养生、教育教学、经济法律、科技科普、旅游民俗、女性杂志等等。</p>
<p>24、超星电子书</p>
<p>网址：http://www.chaoxing.com</p>
<p>40万电子书，注册后可以在线或使用客户端阅读海量书籍。若在教育网中，推荐包库网址 ，可以将PDG格式电子书下载到本机上离线阅读。pdg如何转成pdf，请看百度经验 。该站共享资料页也有大量资源。</p>
<p>25、走读派</p>
<p>地址：http://zoudupai.com</p>
<p>瀑布流电子书网站，支持下载和推送，注册登陆后无其他限制，但是书不多，上传资源需要先申请。资源质量有待优化。其书评系统 #书瓦台# 形式接近微博。</p>
<p>26、掌上书苑</p>
<p>地址：https://www.cnepub.com/</p>
<p>Epub格式电子书下载站，下载和推送均为付费服务，但是可以免费在线阅读</p>
<p>27、众人搜索网</p>
<p>网址：http://dianzishu.renrensousuo.com/</p>
<p>一个电子书搜索功能的网站，可以同时搜索各类电子书、电子小说等。</p>
<p>28、胖次搜索</p>
<p>网址：https://www.panc.cc/</p>
<p>胖次的搜索结果需要配合繁体字才能有最佳效果，整体来说胖次还蛮好用的，连隐秘绝迹的讲座录音/笔记都有，这个必须给点个赞！界面做的也挺简洁，资源方面说实话也够看了。胖次可搜索影音视频、音乐歌曲、小说文档、程序App、图片壁纸、压缩文件BT种子等资源；胖次搜索如果是无效资源，会显示出来，这个很方便。</p>
<p>29、盘多多</p>
<p>网址：http://www.panduoduo.net/</p>
<p>热门资源、专业资源方面出来的结果都很棒。office2016，各科目的文献资料都有，只要点击链接，就能进入详细页面进行下载，在页面下方，也列出了其他相关资源，全站无诱导下载的假按钮，真心不错。小问题：资源最丰富，但是偶尔不稳定。</p>
<p>30、去转盘网</p>
<p>网址：http://www.quzhuanpan.com/</p>
<p>去转盘有着风景宜人的界面，是一个网盘搜索引擎，可以搜索bt和网盘资源还有资源分享等功能，搜索类型主要有影视、音乐、电子书、种子、软件等各种资源，搜索网盘为百度网盘。同时开发了PC端和app客户端，链接龙轩导航、哔哩哔哩、咪咕鱼等网站，功能十分强大。</p>
<p>31、麦库搜索</p>
<p>网址：http://huisou.me/</p>
<p>麦库搜索界面相当简约，但不影响其强大的搜索功能。麦库是利用Google创建的一系列垂直搜索引擎，所以Google的一些使用技巧同样适合于麦库搜索。麦库数据来源：百度网盘，新浪微盘等。</p>
<p>32、特百度</p>
<p>网址：http://www.tebaidu.com/</p>
<p>特百度云提供百度云旗下的百度网盘搜索下载百度网盘的资源，本站也支持百度网盘登陆，百度网盘是目前受欢迎的T级超大免费网盘，注册用户过亿。</p>
<p>33、史莱姆搜索</p>
<p>网址：http://www.slimego.cn/</p>
<p>最丰富的学习资料库,收集整理了大量免费资源,教学资源,百度云资源,网盘资源。包含主流的资源搜索外,还能找到各行业细分的学习资源。</p>
<h1 id="国外网站" class="heading-element">
  <a href="#%e5%9b%bd%e5%a4%96%e7%bd%91%e7%ab%99" class="heading-mark"></a><strong>国外网站</strong></h1><p>34、Library Genesis</p>
<p>网址：http://gen.lib.rus.ec/</p>
<p>这个界面简洁明了，输入你想要找的关键词或者全名，就可以搜到该领域的一些电子书籍。一些科研的电子书，还有科研论文、小说、喜剧、行业标准、杂志啥的都可以搜搜试试。从这个网站搜索可以搜出一本书的好多版本，大家根据自己的需求下载。</p>
<p>35、Project Gutenberg</p>
<p>网址：http://www.gutenberg.org/</p>
<p>它是国外一个知名的电子书免费分享网站，旨在基于互联网，大量提供版权过期而进入公有领域书籍的一项协作计划，最初是在1971年7月由Michael Hart发起的。登堡计划是互联网上最早的免费电子书网站。它们拥有众多的志愿者，藏书量超过4万本。书海茫茫，找本好书不容易，而古登堡的书籍下载排行榜有很高的参考价值。</p>
<p>36、ebookee</p>
<p>网址： <a href="https://ebookee.org/"target="_blank" rel="external nofollow noopener noreferrer">https://ebookee.org/<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>该站书籍种类丰富，基本专业书籍都可找到。网站是按照主题分类的，特别方便查找！</p>
<p>37、Planet eBook</p>
<p>网址：https://www.planetebook.com/</p>
<p>这个网站是免费的古典文学的家园。这里所有的小说和书籍是完全免费下载和共享，图里看到的1984，The Great Gastsby，只要点击图标，就可以很快下载下来。</p>
<p>38、HathiTrust Digital Library</p>
<p>网址：https://www.hathitrust.org/</p>
<p>HathiTrust是学术和研究机构合作，提供一个收集世界各地的数以百万计的图书数字化图书馆。可在线阅读，也可下载。</p>
<p>39、Wikibooks</p>
<p>网址：https://en.wikibooks.org/wiki/Main_Page</p>
<p>Wikibooks，维基教科书，内容开放的教科书及手册集。是维基媒体的一项工程，也是维基百科的姊妹计划，于2003年7月10日开放。 此计划收集自由的教科书，目录或其他用户自己编辑的书。</p>
<p>40、Get Free e-Books</p>
<p>网址：https://www.getfreeebooks.com/</p>
<p>免费电子图书网站，下载书籍也是完全免费。在这个网站上，你找到的电子书收集来自各地或由创始人亲自编制。</p>
<p>41、BookYards</p>
<p>网址：https://www.bookyards.com/en/welcome</p>
<p>Bookyards有22626本书籍，而且图书量随时在增加。它还有四万多个外部网站链接，将近五千个新闻和博客的链接，三万多个电子书链接和访问数以百计的网上图书馆。</p>
<p>42、ePUBee</p>
<p>网址：http://cn.epubee.com/books/</p>
<p>这个网站应该是全球最大的免费电子书库，超过10万本书籍，50万个文件版本，总能找到你喜欢的适合阅读器的电子书文件。品类齐全，搜索功能强大，图书管理方便。</p>
<p>43、FreeBookSpot</p>
<p>网址：http://www.freebookspot.es/</p>
<p>FreeBookSpot是一个免费英文电子书大全网站，它提供有4485本免费电子书，分为96个分类，高达71.97GB。你可以通过分类搜索这些免费电子书，比如科学，工业，编辑，小说或其它电子书。并且没有注册要求，就可以免费下载电子书。</p>
<p>44、Free-eBooks</p>
<p>网址：https://www.free-ebooks.net/</p>
<p>Free-eBooks是一个提供免费电子书下载，电子书资源，电子书作者介绍的网站，你可以免费下载你喜欢的电子书，也可以上传你自己的电子书分享。你需要注册成为该网站的用户才可以下载它们的电子收资源，不过注册是免费的。</p>
<p>45、ManyBooks</p>
<p>地址：http://manybooks.net/</p>
<p>ManyBooks是一个专门提供免费电子书下载的网站，它所提供的免费电子书超过2万本。你可以通过分类，作者，书名和语言进行搜索查询，每本书都包含一个简介，包括书名，作者，国家和内容简介。所有电子书含都可以下载保存为几十种电子书格式，比如Doc，PDF，RTF，JAR，TXT等等。</p>
<p>46、GetFreeEBooks</p>
<p>网址：https://www.getfreeebooks.com/</p>
<p>GetFreeEBooks是一个提供免费电子书下载的网站，站内的所有电子书都可以免费下载。更重要的一点是，该网站提供的电子书都是符合法律要求或是版权协议的。</p>
<p>47、FreeComputerBooks</p>
<p>网址：http://freecomputerbooks.com/</p>
<p>FreeComputerBooks是一个专门收集计算机，编辑，数学，演讲报告和教程等专业知识电子书的网站。它的网站分类结构非常细致，达到12层的分类系统，超过150个子分类。方便你的电子书搜索查找。</p>
<p>48、FreeTechBooks</p>
<p>网址：http://www.freetechbooks.com/</p>
<p>FreeTechBooks也是一个提供科技类免费电子书下载的网站，该网站提供的电子书都是符合法律要求或是版权协议，许可免费的。</p>
<p>49、TheOnlineBooksPage</p>
<p>网址：http://digital.library.upenn.edu/books/</p>
<p>TheOnlineBooksPage列出了一份免费电子书列表，超过3万本免费电子书供用户免费下载。</p>
<p>50、Owllook</p>
<p>网址：https://www.owllook.net/</p>
<p>一个免费下载各类小说的搜索引擎， 页面清新简洁，无广告。直接输入书名即可搜索。</p>]]></description></item><item><title>阿里Druid连接池连接不释放、连接泄漏排查</title><link>https://hpk.me/posts/druid-connect-not-free/</link><pubDate>Mon, 17 Apr 2023 21:12:25 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/druid-connect-not-free/</guid><description><![CDATA[<p>配置好下面三个属性。</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- 超过时间限制是否回收 --&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;removeAbandoned&#34;</span> <span class="na">value=</span><span class="s">&#34;true&#34;</span> <span class="nt">/&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="c">&lt;!-- 超时时间；单位为秒。180秒=3分钟   --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;removeAbandonedTimeout&#34;</span> <span class="na">value=</span><span class="s">&#34;180&#34;</span> <span class="nt">/&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="c">&lt;!-- 关闭abanded连接时输出错误日志   --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;logAbandoned&#34;</span> <span class="na">value=</span><span class="s">&#34;true&#34;</span> <span class="nt">/&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>查看日志文件。</p>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">2019-04-17 17:10:05:140 - ERROR [Druid-ConnectionPool-Destroy-1559154670] - com.alibaba.druid.pool.DruidDataSource com.alibaba.druid.pool.DruidDataSource.removeAbandoned:2666 abandon connection, owner thread: http-nio-8085-exec-1, connected at : 1555491605100, open stackTrace
</span></span><span class="line"><span class="cl">	at java.lang.Thread.getStackTrace(Thread.java:1559)
</span></span><span class="line"><span class="cl">	at com.alibaba.druid.pool.DruidDataSource.getConnectionDirect(DruidDataSource.java:1313)
</span></span><span class="line"><span class="cl">	at com.alibaba.druid.pool.DruidDataSource.getConnection(DruidDataSource.java:1235)
</span></span><span class="line"><span class="cl">	at com.alibaba.druid.pool.DruidDataSource.getConnection(DruidDataSource.java:1225)
</span></span><span class="line"><span class="cl">	at com.xxxx.xx.common.util.JdbcUtil.linkTrace(JdbcUtil.java:39)
</span></span><span class="line"><span class="cl">	at com.xxxx.xx.xxxxx.service.impl.DashboardServiceImpl.getExpenTrend(DashboardServiceImpl.java:263)
</span></span><span class="line"><span class="cl">	at com.xxxx.xx.xxxxx.service.impl.DashboardServiceImpl.getBossData(DashboardServiceImpl.java:58)
</span></span><span class="line"><span class="cl">	at com.xxxx.xx.xxxxx.controller.DashboardController.getBossData(DashboardController.java:43)</span></span></code></pre></td></tr></table>
</div>
</div><p>日志里查找<code>removeAbandoned</code>关键字，找到自己哪个方法获取连接后没有关闭资源，排查原因。</p>]]></description></item><item><title>spring cloud java反向代理访问阿里云OSS私有资源</title><link>https://hpk.me/posts/spring-proxy-oss/</link><pubDate>Mon, 17 Apr 2023 20:43:10 +0800</pubDate><author>作者</author><guid>https://hpk.me/posts/spring-proxy-oss/</guid><description><![CDATA[<p>最近用到阿里云oss，有阿里云服务器，通过代理内网访问可以实现免除OSS流量费，查到很多nginx反向代理的教程，但是纯java实现没有找到，感觉可以试一试。</p>
<p>（一）
首先要解决反向代理的问题，搜到<code>org.mitre.dsmiley.httpproxy.ProxyServlet</code>可解决。</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;groupId&gt;</span>org.mitre.dsmiley.httpproxy<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;artifactId&gt;</span>smiley-http-proxy-servlet<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;version&gt;</span>1.11<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyConfig</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ServletRegistrationBean</span><span class="w"> </span><span class="nf">servletRegistrationAliBean01</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ServletRegistrationBean</span><span class="w"> </span><span class="n">oss</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServletRegistrationBean</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ProxyServlet</span><span class="p">(),</span><span class="w"> </span><span class="s">&#34;/ali/bucket_name/*&#34;</span><span class="p">);</span><span class="c1">//修改为自己的bucket_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oss</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="s">&#34;bucket_name&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oss</span><span class="p">.</span><span class="na">addInitParameter</span><span class="p">(</span><span class="s">&#34;targetUri&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;http://bucket_name.oss-cn-beijing.aliyuncs.com&#34;</span><span class="p">);</span><span class="c1">//本地测试环境用外网地址，线上改成内网访问的地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oss</span><span class="p">.</span><span class="na">addInitParameter</span><span class="p">(</span><span class="n">ProxyServlet</span><span class="p">.</span><span class="na">P_LOG</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;true&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">oss</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>（二）
Controller配置如下，转发到自己配置的反向代理</p>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">@RestController
</span></span><span class="line"><span class="cl">@RefreshScope
</span></span><span class="line"><span class="cl">@RequestMapping(&#34;/api/es&#34;)
</span></span><span class="line"><span class="cl">public class TestController {
</span></span><span class="line"><span class="cl">     @RequestMapping(&#34;/static/**&#34;)
</span></span><span class="line"><span class="cl">    public void testVideoOne(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException, URISyntaxException {
</span></span><span class="line"><span class="cl">        String resourcePath = request.getRequestURI().replace(&#34;/api/es/static&#34;,&#34;&#34;);
</span></span><span class="line"><span class="cl">        HeaderUtil.setHeaderOwn(request,resourcePath);
</span></span><span class="line"><span class="cl">        request.getRequestDispatcher(&#34;/ali&#34; + resourcePath).forward(request, response);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}</span></span></code></pre></td></tr></table>
</div>
</div><p>（三）
其中为request设置Header以认证OSS访问的HeaderUtil如下，其中有OSS Authorization计算的java实现，用java的反射在request中添加Header信息。</p>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">commons</span><span class="o">.</span><span class="n">codec</span><span class="o">.</span><span class="n">binary</span><span class="o">.</span><span class="n">Base64</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">tomcat</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">MimeHeaders</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">javax</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">Mac</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">javax</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">SecretKeySpec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">javax</span><span class="o">.</span><span class="n">servlet</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">HttpServletRequest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">Field</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">java</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">URISyntaxException</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">java</span><span class="o">.</span><span class="n">nio</span><span class="o">.</span><span class="n">charset</span><span class="o">.</span><span class="n">Charset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">java</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">InvalidKeyException</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">java</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">NoSuchAlgorithmException</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">java</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">SimpleDateFormat</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">Date</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">Locale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">TimeZone</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">public</span> <span class="k">class</span> <span class="n">HeaderUtil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">/**</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="err">给</span><span class="n">request加入Header信息</span><span class="err">，验证</span><span class="n">OSS访问权限</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="err">@</span><span class="n">param</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="err">@</span><span class="n">throws</span> <span class="n">URISyntaxException</span>
</span></span><span class="line"><span class="cl">     <span class="o">*/</span>
</span></span><span class="line"><span class="cl">    <span class="n">public</span> <span class="k">static</span> <span class="n">void</span> <span class="n">setHeaderOwn</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span><span class="ne">String</span> <span class="n">resourcePath</span><span class="p">)</span> <span class="n">throws</span> <span class="n">URISyntaxException</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SimpleDateFormat</span> <span class="n">sdf</span> <span class="o">=</span> <span class="n">new</span> <span class="n">SimpleDateFormat</span><span class="p">(</span><span class="s2">&#34;EEE, dd MMM yyyy HH:mm:ss &#39;GMT&#39;&#34;</span><span class="p">,</span> <span class="n">Locale</span><span class="o">.</span><span class="n">US</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">sdf</span><span class="o">.</span><span class="n">setTimeZone</span><span class="p">(</span><span class="n">TimeZone</span><span class="o">.</span><span class="n">getTimeZone</span><span class="p">(</span><span class="s2">&#34;GMT&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="ne">String</span> <span class="n">date_GMT</span> <span class="o">=</span> <span class="n">sdf</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new</span> <span class="n">Date</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="ne">String</span> <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">getMethod</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="o">+</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="o">+</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="o">+</span> <span class="n">date_GMT</span> <span class="o">+</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="o">+</span> <span class="n">resourcePath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="ne">String</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">genHMAC</span><span class="p">(</span><span class="s2">&#34;AccessKeySecret&#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span><span class="o">//</span><span class="n">AccessKeySecret改成自己的</span>
</span></span><span class="line"><span class="cl">        <span class="n">reflectSetParam</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&#34;Authorization&#34;</span><span class="p">,</span> <span class="s2">&#34;OSS AccessKeyId:&#34;</span> <span class="o">+</span> <span class="n">signature</span><span class="p">);</span><span class="o">//</span><span class="n">AccessKeyId改成自己的</span>
</span></span><span class="line"><span class="cl">        <span class="n">reflectSetParam</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&#34;Date&#34;</span><span class="p">,</span> <span class="n">date_GMT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">/**</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="err">反射修改</span><span class="n">header信息</span><span class="err">，</span><span class="n">key</span><span class="o">-</span><span class="n">value键值对加入到header中</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="err">@</span><span class="n">param</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="err">@</span><span class="n">param</span> <span class="n">key</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="err">@</span><span class="n">param</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">     <span class="o">*/</span>
</span></span><span class="line"><span class="cl">    <span class="n">private</span> <span class="k">static</span> <span class="n">void</span> <span class="n">reflectSetParam</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="ne">String</span> <span class="n">key</span><span class="p">,</span> <span class="ne">String</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Class</span><span class="o">&lt;</span><span class="err">?</span> <span class="k">extends</span> <span class="n">HttpServletRequest</span><span class="o">&gt;</span> <span class="n">requestClass</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">getClass</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;request实现类=&#34;</span><span class="o">+</span><span class="n">requestClass</span><span class="o">.</span><span class="n">getName</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Field</span> <span class="n">request1</span> <span class="o">=</span> <span class="n">requestClass</span><span class="o">.</span><span class="n">getDeclaredField</span><span class="p">(</span><span class="s2">&#34;request&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">request1</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="bp">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="ne">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">request1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Field</span> <span class="n">coyoteRequest</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getDeclaredField</span><span class="p">(</span><span class="s2">&#34;coyoteRequest&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">coyoteRequest</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="bp">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="ne">Object</span> <span class="n">o1</span> <span class="o">=</span> <span class="n">coyoteRequest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">//</span> <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;coyoteRequest实现类=&#34;</span><span class="o">+</span><span class="n">o1</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">Field</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">o1</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getDeclaredField</span><span class="p">(</span><span class="s2">&#34;headers&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">headers</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="bp">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">MimeHeaders</span> <span class="n">o2</span> <span class="o">=</span> <span class="p">(</span><span class="n">MimeHeaders</span><span class="p">)</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">o1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">o2</span><span class="o">.</span><span class="n">addValue</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">setString</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="n">printStackTrace</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">/**</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">HmacSHA1</span> <span class="n">Base64加密</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="err">@</span><span class="n">param</span> <span class="n">key</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="err">@</span><span class="n">param</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="err">@</span><span class="k">return</span>
</span></span><span class="line"><span class="cl">     <span class="o">*/</span>
</span></span><span class="line"><span class="cl">    <span class="n">public</span> <span class="k">static</span> <span class="ne">String</span> <span class="n">genHMAC</span><span class="p">(</span><span class="ne">String</span> <span class="n">key</span><span class="p">,</span> <span class="ne">String</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">byte</span><span class="p">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">//</span><span class="err">根据给定的字节数组构造一个密钥</span><span class="p">,</span><span class="err">第二参数指定一个密钥算法的名称</span>
</span></span><span class="line"><span class="cl">            <span class="n">SecretKeySpec</span> <span class="n">signinKey</span> <span class="o">=</span> <span class="n">new</span> <span class="n">SecretKeySpec</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">getBytes</span><span class="p">(),</span> <span class="s2">&#34;HmacSHA1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">//</span><span class="err">生成一个指定</span> <span class="n">Mac</span> <span class="err">算法</span> <span class="err">的</span> <span class="n">Mac</span> <span class="err">对象</span>
</span></span><span class="line"><span class="cl">            <span class="n">Mac</span> <span class="n">mac</span> <span class="o">=</span> <span class="n">Mac</span><span class="o">.</span><span class="n">getInstance</span><span class="p">(</span><span class="s2">&#34;HmacSHA1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">//</span><span class="err">用给定密钥初始化</span> <span class="n">Mac</span> <span class="err">对象</span>
</span></span><span class="line"><span class="cl">            <span class="n">mac</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">signinKey</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">//</span><span class="err">完成</span> <span class="n">Mac</span> <span class="err">操作</span>
</span></span><span class="line"><span class="cl">            <span class="n">byte</span><span class="p">[]</span> <span class="n">rawHmac</span> <span class="o">=</span> <span class="n">mac</span><span class="o">.</span><span class="n">doFinal</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">getBytes</span><span class="p">(</span><span class="n">Charset</span><span class="o">.</span><span class="n">forName</span><span class="p">(</span><span class="s2">&#34;UTF-8&#34;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="n">Base64</span><span class="o">.</span><span class="n">encodeBase64</span><span class="p">(</span><span class="n">rawHmac</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">NoSuchAlgorithmException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">InvalidKeyException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">null</span> <span class="o">!=</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">new</span> <span class="ne">String</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>最后访问的地址例如：
http://127.0.0.1:8081/api/es/static/bucket_name/object_name
可以加个拦截器做个登陆验证。</p>]]></description></item></channel></rss>